<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="WebNiceSendMap">

    <!--
    * ================================================================
    * 날짜 : 20180221
    * 이름 : 송준빈
    * 추가내용 : 고객 타켓리스트 정보 조회
    * 대상 테이블 : TB_TRGT_CUST_DTPT
    * ================================================================
    -->
    <select id="WebNiceSendMap.getMemberNiceInfo" parameterType="map" resultType="resultMap">
        SELECT CNTR_CD              AS CNTR_CD             /* 센터코드 (CCA : 대명스테이션 CCB : 인우기술)                                  */
              ,TRGT_LIST_ID         AS TRGT_LIST_ID        /* 대상 목록 ID                                                            */
              ,SUB_TRGT_LIST_ID     AS SUB_TRGT_LIST_ID    /* 서브 대상 목록 ID                                                         */
              ,TRGT_CUST_DTPT_ID    AS TRGT_CUST_DTPT_ID   /* 대상 고객 상세 ID                                                         */
              ,CUST_NM              AS CUST_NM             /* 고객 명                                                                                           */
              ,MEM_NO               AS MEM_NO              /* 대명고객 번호                                                                                     */
              ,ACCNT_NO             AS ACCNT_NO            /* 대명회원 번호                                                                                     */
              ,CLPH_TLNO            AS CLPH_TLNO           /* 휴대폰 전화번호                                                                                   */
              ,HOME_TLNO            AS HOME_TLNO           /* 집 전화번호                                                                                       */
              ,COMP_TLNO            AS COMP_TLNO           /* 회사 전화번호                                                                                     */
              ,ETC_TLNO             AS ETC_TLNO            /* 기타 전화번호                                                                                     */
              ,UNTY_CASE_ADTL_YN    AS UNTY_CASE_ADTL_YN   /* 단일 건 추가 여부                                                                                 */
              ,USER_DEFN1_CNTN      AS USER_DEFN1_CNTN     /* 사용자 정의01 내용                                                                                */
              ,USER_DEFN2_CNTN      AS USER_DEFN2_CNTN     /* 사용자 정의02 내용                                                                                */
              ,USER_DEFN3_CNTN      AS USER_DEFN3_CNTN     /* 사용자 정의03 내용                                                                                */
              ,USER_DEFN4_CNTN      AS USER_DEFN4_CNTN     /* 사용자 정의04 내용                                                                                */
              ,USER_DEFN5_CNTN      AS USER_DEFN5_CNTN     /* 사용자 정의05 내용                                                                                */
              ,USER_DEFN6_CNTN      AS USER_DEFN6_CNTN     /* 사용자 정의06 내용                                                                                */
              ,USER_DEFN7_CNTN      AS USER_DEFN7_CNTN     /* 사용자 정의07 내용                                                                                */
              ,USER_DEFN8_CNTN      AS USER_DEFN8_CNTN     /* 사용자 정의08 내용                                                                                */
              ,USER_DEFN9_CNTN      AS USER_DEFN9_CNTN     /* 사용자 정의09 내용                                                                                */
              ,USER_DEFN10_CNTN     AS USER_DEFN10_CNTN    /* 사용자 정의10 내용                                                                                */
              ,USER_DEFN11_CNTN     AS USER_DEFN11_CNTN    /* 사용자 정의11 내용                                                                                */
              ,USER_DEFN12_CNTN     AS USER_DEFN12_CNTN    /* 사용자 정의12 내용                                                                                */
              ,USER_DEFN13_CNTN     AS USER_DEFN13_CNTN    /* 사용자 정의13 내용                                                                                */
              ,USER_DEFN14_CNTN     AS USER_DEFN14_CNTN    /* 사용자 정의14 내용                                                                                */
              ,USER_DEFN15_CNTN     AS USER_DEFN15_CNTN    /* 사용자 정의15 내용                                                                                */
              ,USER_DEFN16_CNTN     AS USER_DEFN16_CNTN    /* 사용자 정의16 내용                                                                                */
              ,USER_DEFN17_CNTN     AS USER_DEFN17_CNTN    /* 사용자 정의17 내용                                                                                */
              ,USER_DEFN18_CNTN     AS USER_DEFN18_CNTN    /* 사용자 정의18 내용                                                                                */
              ,USER_DEFN19_CNTN     AS USER_DEFN19_CNTN    /* 사용자 정의19 내용                                                                                */
              ,USER_DEFN20_CNTN     AS USER_DEFN20_CNTN    /* 사용자 정의20 내용                                                                                */
              ,RGSR_ID              AS RGSR_ID             /* 등록자 ID                                                               */
              ,RGSN_DTTM            AS RGSN_DTTM           /* 등록 일시                                                                                         */
              ,AMND_ID              AS AMND_ID             /* 수정자 ID                                                               */
              ,AMNT_DTTM            AS AMNT_DTTM           /* 수정 일시                                                                                         */
              ,PRMV_ID              AS PRMV_ID             /* 관계 id                                                                 */
              ,BRTH_MON_DAY         AS BRTH_MON_DAY        /* 고객생년월일(NICE에서 전화번호와 더불어 생년월일도 필요함)                           */
          FROM TB_TRGT_CUST_DTPT /* 고객데이터(대상고객상세) */
         WHERE 1=1
         <if test="trgt_cust_dtpt_id != null and trgt_cust_dtpt_id != ''">
             AND TRGT_CUST_DTPT_ID = #{trgt_cust_dtpt_id}
         </if>
         <if test="app_no != null and app_no != ''">
             AND TRGT_CUST_DTPT_ID = #{app_no}
         </if>
         <!--
         <if test="mem_no != null and mem_no != ''">
             AND MEM_NO = #{mem_no}
         </if>
         <if test="accnt_no != null and accnt_no != ''">
             AND ACCNT_NO = #{accnt_no}
         </if>
         -->

    </select>

    <!--
    * ================================================================
    * 날짜 : 20180221
    * 이름 : 송준빈
    * 추가내용 : NICE 전자서명 대상 고객 조회
    * 대상 테이블 : TB_MEMBER_NICE_INFO
    * ================================================================
    -->
    <select id="WebNiceSendMap.getMemberNiceRetrieve" parameterType="map" resultType="resultMap">
        SELECT CNTR_CD           /* 센터 코드
              ,TRGT_LIST_ID      /* 대상 목록 ID (캠페인 ID)                                                  */
              ,SUB_TRGT_LIST_ID  /* 서브 대상 목록 ID (캠페인 서브타켓 리스트 ID)                                   */
              ,TRGT_CUST_DTPT_ID /* 대상 고객 상세 ID                                                        */
              ,CUST_NM           /* 고객명                                                                                          */
              ,MEM_NO            /* 고객고유번호                                                                                    */
              ,ACCNT_NO          /* 고객회원번호                                                                                    */
              ,CLPH_TLNO         /* 휴대폰전화번호                                                                                  */
              ,NICE_NO           /* NICE가 발행한 해당접수건 고유 KEY값                                                           */
              ,NCCS_STAT         /* NICE가 보낸 상태코드 접수건 상태 값 (01: 접수, 02: 진행, 03: NICE측에서 취소, 04: 완료)       */
              ,UPP_TX_TYPE       /* 전송구분값(01: 1차접수, 02:본인인증, 03: 신용정보취득 04: 2차접수, 05:위탁처리 06:고객가입완료) */
              ,BRTH_MON_DAY      /* 고객생년월일                                                                                    */
              ,IMG_FILE_NM       /* 고객파일명                                                                                      */
              ,IMG_FILE_PATH     /* 고객파일절대경로                                                                                */
              ,CREDIT_RATING     /* 신용등급                                                                                        */
              ,ACUON_FITNESS_YN  /* 애큐온심사적격여부                                                                              */
              ,CI_VAL            /* 본인인증값(CI_VAL)                                                      */
              ,GENDER            /* 성별                                                                                            */
              ,RGSR_ID           /* 등록자ID                                                              */
              ,RGSN_DTTM         /* 등록일시                                                                                        */
              ,NICE_NO2          /* 2차접수시 NICE번호                                                                            */
              ,SAFEKEY           /* 세이프키                                                                                        */
              ,FINISH_FLAG       /* 1차.2차 완료.취소 여부 */
          FROM LF_DMUSER.TB_MEMBER_NICE_INFO
         WHERE 1=1
         <if test="trgt_cust_dtpt_id != null and trgt_cust_dtpt_id != ''">
             AND TRGT_CUST_DTPT_ID = #{trgt_cust_dtpt_id}
         </if>
         <if test="app_no != null and app_no != ''">
             AND TRGT_CUST_DTPT_ID = #{app_no}
         </if>
         <!--
         <if test="mem_no != null and mem_no != ''">
             AND MEM_NO = #{mem_no}
         </if>
         -->
         <if test="accnt_no != null and accnt_no != ''">
             AND ACCNT_NO = #{accnt_no}
         </if>
    </select>

    <!--
    * ================================================================
    * 날짜 : 20180221
    * 이름 : 송준빈
    * 추가내용 : NICE 전자서명 대상 고객 저장
    * 대상 테이블 : TB_MEMBER_NICE_INFO
    * ================================================================
    -->
    <insert id="WebNiceSendMap.insertMemberNiceInfo" parameterType="map">
        INSERT INTO LF_DMUSER.TB_MEMBER_NICE_INFO
                   (CNTR_CD,          TRGT_LIST_ID, SUB_TRGT_LIST_ID, TRGT_CUST_DTPT_ID, CUST_NM,
                    MEM_NO,           ACCNT_NO,     CLPH_TLNO,        NICE_NO,           NCCS_STAT,
                    UPP_TX_TYPE,      BRTH_MON_DAY, IMG_FILE_NM,      IMG_FILE_PATH,     CREDIT_RATING,
                    ACUON_FITNESS_YN, CI_VAL,           GENDER,            RGSR_ID,       RGSN_DTTM,
                    RGSR_ID2,         RGSN_DTTM2)
             VALUES(#{cntr_cd}, #{trgt_list_id}, #{sub_trgt_list_id}, #{trgt_cust_dtpt_id}, #{cust_nm},
                    '',         '',              #{clph_tlno},        '',                   '',
                    '01',         #{brth_mon_day}, '',                  '',                   '',
                    '',         '',                  '',                   #{rgsr_id}, SYSDATE,
                    '',         '')
    </insert>

    <!--
    * ================================================================
    * 날짜 : 20180221
    * 이름 : 송준빈
    * 추가내용 : NICE 전자서명 대상고객 히스토리 저장
    * 대상 테이블 : TB_MEMBER_NICE_INFO_HIST
    * ================================================================
    -->
    <insert id="WebNiceSendMap.insertMemberNiceInfoHist" parameterType="map">
        INSERT INTO LF_DMUSER.TB_MEMBER_NICE_INFO_HIST
                   (TRGT_CUST_DTPT_ID, TRGT_CUST_DTPT_SEQ, UPP_TX_TYPE,      NCCS_STAT,   RESULT_CODE,
                    RESULT_MEMO,       BRTH_MON_DAY,       CUST_NM,          CLPH_TLNO,   MEM_NO,
                    ACCNT_NO,          PROD_CD,            ACUON_FITNESS_YN, EXTEND_DATA, RGSR_ID,   RGSN_DTTM)
             VALUES(#{app_no},
                    (SELECT NVL(MAX(TO_NUMBER(TRGT_CUST_DTPT_SEQ)) , 0) + 1 FROM LF_DMUSER.TB_MEMBER_NICE_INFO_HIST WHERE 1=1 AND TRGT_CUST_DTPT_ID = #{app_no}),
                    #{upp_tx_type}, #{nccs_stat}, #{result_code}, #{result_memo}, #{brth_mon_day}, #{cust_nm}, #{clph_tlno}, #{mem_no},
                    #{accnt_no}, #{prod_cd}, #{acuon_fitness_yn}, #{extend_data}, #{rgsr_id}, SYSDATE)
    </insert>

    <!--
    * ================================================================
    * 날짜 : 20180221
    * 이름 : 송준빈
    * 추가내용 : 고객 타켓리스트 정보 업데이트 (고객생년월일)
    * 대상 테이블 : TB_TRGT_CUST_DTPT
    * ================================================================
    -->
    <update id="WebNiceSendMap.updateMemberNiceInfo" parameterType="map">
        UPDATE TB_TRGT_CUST_DTPT
           SET BRTH_MON_DAY = #{brth_mon_day}
              ,AMND_ID = #{amnd_id}
              ,AMNT_DTTM = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
         WHERE 1=1
           AND TRGT_CUST_DTPT_ID = #{trgt_cust_dtpt_id}
    </update>

    <!--
    * ================================================================
    * 날짜 : 20180221
    * 이름 : 송준빈
    * 추가내용 : 고객 타켓리스트 정보 업데이트 (2차 방송시 수행됨, 고객의 고유번호와 회원번호가 업데이트됨)
    * 대상 테이블 : TB_TRGT_CUST_DTPT
    * ================================================================
    -->
    <update id="WebNiceSendMap.updateMemberNiceInfo2" parameterType="map">
        UPDATE TB_TRGT_CUST_DTPT
           SET MEM_NO = #{mem_no}
              ,ACCNT_NO = #{accnt_no}
         WHERE 1=1
           AND TRGT_CUST_DTPT_ID = #{trgt_cust_dtpt_id}
    </update>

    <!--
    * ================================================================
    * 날짜 : 20180221
    * 이름 : 송준빈
    * 추가내용 : NICE 전자서명 대상 고객 (2차 방송시 수행됨, 고객의 고유번호와 회원번호가 업데이트됨)
    * 대상 테이블 : TB_MEMBER_NICE_INFO
    * ================================================================
    -->
    <update id="WebNiceSendMap.updateMemberNiceInfo3" parameterType="map">
        UPDATE LF_DMUSER.TB_MEMBER_NICE_INFO
           SET MEM_NO      = #{mem_no}
              ,ACCNT_NO    = #{accnt_no}
              ,FINISH_FLAG = #{finish_flag}
              ,RGSR_ID2    = #{rgsr_id}
              ,RGSN_DTTM2  = SYSDATE
         WHERE 1=1
           AND TRGT_CUST_DTPT_ID   = #{trgt_cust_dtpt_id}
    </update>

    <!--
    * ================================================================
    * 날짜 : 20180221
    * 이름 : 송준빈
    * 추가내용 : 고객의 증서내용 조회 (2차 발송시 NICE 개별부로 보내지게 됨)
    * ================================================================
    -->
    <select id="WebNiceSendMap.getCertfMng" parameterType="map" resultType="resultMap">
        SELECT DISTINCT MEM.MEM_NO
              ,ACCNT.ACCNT_NO
              ,LF_DMUSER.FN_MEM_NM(ACCNT.MEM_NO) MEM_NM
              ,PROD.PROD_CL
              ,ACCNT.JOIN_DT AS JOIN_DT
              ,(CASE WHEN LENGTH(MEM.CELL)>5 THEN SUBSTR(MEM.CELL, 1, LENGTH(MEM.CELL)-4) || '****' ELSE ' ' END) CELL
              ,MEM.CELL CELL_FULL
              ,MEM.BRTH_MON_DAY
              ,MEM.HOME_ZIP
              ,MEM.HOME_ADDR
              ,MEM.HOME_ADDR2
              ,MEM.HOME_ADDR || ' ' || HOME_ADDR2 AS ADDR
              ,ACCNT.EMPLE_NO
              ,LF_DMUSER.FN_DEPT_NM((SELECT DEPT_CD FROM LF_DMUSER.EMPLOYEE EMPL WHERE EMPL.EMPLE_NO = ACCNT.EMPLE_NO))|| '/' || NVL(LF_DMUSER.FN_EMPLE_NM(ACCNT.EMPLE_NO),' ')  AS CHARGENM
              ,CASE WHEN PROD.PROD_CL='03' THEN CASE WHEN PROD.JOIN_TYPE ='0001' THEN TRIM(TO_CHAR(PROD_AMT,'999,999,999,999,999')) || ' 원' || (SELECT '(실납입금액 : ' || TRIM(TO_CHAR(SUM((MONTH_PAY_AMT) * (END_NO-ST_NO + 1)),'999,999,999,999,999')) || ' 원)'  FROM LF_DMUSER.PRODUCT_DTL WHERE PROD_CD=PROD.PROD_CD AND MONTH_PAY_AMT>0)
                    WHEN PROD.JOIN_TYPE ='0002' AND PROD.JOIN_GIFT_CARD_SORT ='0001' THEN TRIM(TO_CHAR(PROD_AMT,'999,999,999,999,999')) || ' 원' || (SELECT '(실납입금액 : ' || TRIM(TO_CHAR(SUM((MONTH_PAY_AMT) * (END_NO-ST_NO + 1)),'999,999,999,999,999')) || ' 원)'  FROM LF_DMUSER.PRODUCT_DTL WHERE PROD_CD=PROD.PROD_CD AND MONTH_PAY_AMT>0)
                    ELSE TRIM(TO_CHAR(PROD_AMT,'999,999,999,999,999')) || ' 원'
               END
               ELSE TRIM(TO_CHAR(PROD_AMT,'999,999,999,999,999')) || ' 원'
               END PROD_AMT
              ,PROD.PROD_CD
              ,PROD.PROD_NM
              ,PROD.JOIN_TYPE
              ,(CASE WHEN NVL(PROD.JOIN_GIFT_CARD_SORT, ' ') = '0001' THEN 'Y' ELSE 'N' END) MOBILE_PROD
              ,NVL(CASE WHEN PROD.PROD_CL='03' THEN CASE  WHEN PROD.JOIN_TYPE ='0002' AND PROD.JOIN_GIFT_CARD_SORT ='0002' THEN TRIM(TO_CHAR(PROD.MON_PAY_AMT,'999,999,999,999,999')) ||' 원'
                    ELSE LF_DMUSER.FN_CERTIF_EXCEPT(PROD.PROD_CD)
               END
               ELSE TRIM(TO_CHAR(PROD.MON_PAY_AMT,'999,999,999,999,999'))  ||' 원'
               END,' ') MON_PAY_AMT
              ,PROD.EXPR_NO
                ,LF_DMUSER.FN_COM_NM('01',ACCNT.PAY_MTHD) PAY_MTHD_NM
              ,CASE WHEN ACCNT.PAY_MTHD='04' THEN  CMSMEM.DEPR WHEN ACCNT.PAY_MTHD='06' THEN LF_DMUSER.FN_MEM_NM(ACCNT.MEM_NO) ELSE ' ' END DEPR
              ,CASE WHEN ACCNT.PAY_MTHD='06' THEN LF_DMUSER.FN_COM_NM('0120', CARDMEM.CARD_CD) ELSE LF_DMUSER.FN_COM_NM('63',CMSMEM.BANK_CD) END AS BANK_NM
              ,CASE WHEN ACCNT.PAY_MTHD='06' THEN ' ' ELSE LF_DMUSER.FN_COM_NM ('07', CMSMEM.RELTN) END AS RELTN_NM
              ,CASE WHEN ACCNT.PAY_MTHD='06' THEN SUBSTR( CARD_NO,1, 4) || '-' || SUBSTR(SUBSTR(CARD_NO,1, 8), -4) ||'-****-****'
                    ELSE SUBSTR(CMSMEM.BANK_ACCNT_NO,1,3) || '********'
               END AS BANK_ACCNT_NO
              ,CASE WHEN ACCNT.PAY_MTHD='04' THEN ICHAE_DT WHEN ACCNT.PAY_MTHD='06' THEN CARDMEM.PAY_DT ELSE ' ' END ICHAE_DT
              ,SUBSTR((CASE WHEN MEM.CONTC_TM_FROM=' ' OR MEM.CONTC_TM_FROM IS NULL THEN '00' ELSE MEM.CONTC_TM_FROM END), 1,2)  || ':' || SUBSTR((CASE WHEN MEM.CONTC_TM_FROM=' ' OR MEM.CONTC_TM_FROM IS NULL THEN '00' ELSE MEM.CONTC_TM_FROM END), -2)  || '~'
               || SUBSTR((CASE WHEN MEM.CONTC_TM_TO=' ' OR MEM.CONTC_TM_TO IS NULL THEN '00' ELSE MEM.CONTC_TM_TO END), 1,2)  || ':' || SUBSTR((CASE WHEN MEM.CONTC_TM_TO=' ' OR MEM.CONTC_TM_TO IS NULL THEN '00' ELSE MEM.CONTC_TM_TO END), -2) AS CONTC_TM
              ,CASE WHEN NVL(PMCC.PROD_PRT_NM,' ') = ' ' THEN PROD.PROD_NM ELSE PMCC.PROD_PRT_NM END  PROD_PRT_NM
              ,CASE WHEN PROD.PROD_CL='03' THEN PMCC.PROD_JOIN_PRT_NM ||
                    CASE WHEN NVL(ACCNT.PROD_MODEL_CD, 0) > 0 THEN (SELECT '(' ||PRODMD.MODEL_NM||')'
                                                                      FROM LF_DMUSER.PRODUCT_MODEL_MST PRODMM
                                                                      INNER JOIN LF_DMUSER.PRODUCT_MODEL_DTL PRODMD
                                                                              ON PRODMM.SEQ = PRODMD.SEQ
                                                                     WHERE PRODMM.PROD_CD = ACCNT.PROD_CD
                                                                       AND PRODMM.PROD_KIND = ACCNT.PROD_MODEL_KIND
                                                                       AND PRODMD.MODEL_CD = ACCNT.PROD_MODEL_CD
                                                                       AND PRODMM.DEL_FG ='N') ELSE ' '
                    END
               ELSE ' '
               END PROD_JOIN_PRT_NM
              ,NVL(CASE WHEN PROD.PROD_CL='03' THEN (SELECT TO_CHAR( SUM(END_NO-ST_NO + 1)) || '개월 할부매매계약(무이자)' FROM LF_DMUSER.PRODUCT_DTL WHERE PROD_CD=PROD.PROD_CD AND ALLT_AMT+ADD_AMT>0) ELSE ' ' END, ' ') CONTRACT_TYPE
              ,NVL(CASE WHEN PROD.PROD_CL='03' THEN (SELECT ALLT_AMT+ADD_AMT FROM LF_DMUSER.PRODUCT_DTL WHERE PROD_CD=PROD.PROD_CD AND SEQ =1) ELSE 0 END, 0) CONTRACT_MON_PAY
              ,NVL(CASE WHEN PROD.PROD_CL='03' THEN (SELECT '할부원금 ' || TO_CHAR( SUM(ALLT_AMT+ADD_AMT * (END_NO-ST_NO + 1)),'999,999,999,999,999') || '원(VAT포함)'  FROM LF_DMUSER.PRODUCT_DTL WHERE PROD_CD=PROD.PROD_CD AND ALLT_AMT+ADD_AMT>0) ELSE ' ' END, ' ') CONTRACT_AMT
              ,CASE WHEN PROD.PROD_CL='03' THEN (SELECT ('월'|| TO_CHAR( ALLT_AMT+ADD_AMT,'999,999,999,999,999') ||'원*') ||   TO_CHAR(END_NO-ST_NO+1) ||'회' FROM LF_DMUSER.PRODUCT_DTL WHERE PROD_CD = 'S9' AND MONTH_PAY_AMT>0 AND SEQ =1)
                    ELSE ('월'|| TO_CHAR( PROD.MON_PAY_AMT,'999,999,999,999,999') || '원*' || TO_CHAR( PROD.EXPR_NO) || '회')
               END MONTH_PAY_AMT
              ,CASE WHEN PROD.PROD_CL='03' THEN (SELECT TO_CHAR( SUM(END_NO-ST_NO+1))||'회'
                                                   FROM LF_DMUSER.PRODUCT_DTL
                                                  WHERE PROD_CD = PROD.PROD_CD
                                                    AND MONTH_PAY_AMT > 0)
               ELSE TO_CHAR(PROD.EXPR_NO)|| '회'
               END PAY_EXPR_NO
              ,CASE WHEN PROD.PROD_CL='03' THEN '할부이자율 : 무이자' ELSE ' ' END ETC
              ,CASE WHEN PROD.PROD_CL='03' THEN (SELECT '월'||TRIM(TO_CHAR(MAX(MONTH_PAY_AMT+ALLT_AMT),'999,999,999,999,999'))||'원' || (CASE WHEN ACCNT.PAY_MTHD = '06' THEN '(카드결제)' ELSE ' ' END) || '*' || TO_CHAR(SUM(END_NO-ST_NO+1))||'회' FROM LF_DMUSER.PRODUCT_DTL WHERE PROD_CD = PROD.PROD_CD AND MONTH_PAY_AMT>0)
                    ELSE ('월'|| TRIM(TO_CHAR(PROD.MON_PAY_AMT,'999,999,999,999,999')) || '원' || (CASE WHEN ACCNT.PAY_MTHD = '06' THEN '(카드결제)' ELSE ' ' END) || '*' || TO_CHAR(PROD.EXPR_NO) || '회')  END PROD1_PAY_INFO
              ,CASE WHEN PROD.PROD_CL = '03' AND (ACCNT.RECOMMEND_EMPLE_NO IS NOT NULL AND ACCNT.RECOMMEND_EMPLE_NO != '') THEN LF_DMUSER.FN_DEPT_NM((SELECT DEPT_CD FROM LF_DMUSER.EMPLOYEE EMPL WHERE EMPL.EMPLE_NO = ACCNT.RECOMMEND_EMPLE_NO))|| '/' || NVL(LF_DMUSER.FN_EMPLE_NM(ACCNT.RECOMMEND_EMPLE_NO),' ')
                    WHEN PROD.PROD_CL = '03' AND (ACCNT.RECOMMEND_EMPLE_NO IS NULL OR ACCNT.RECOMMEND_EMPLE_NO = '') THEN ' '
                    ELSE LF_DMUSER.FN_DEPT_NM((SELECT DEPT_CD FROM LF_DMUSER.EMPLOYEE EMPL WHERE EMPL.EMPLE_NO = ACCNT.EMPLE_NO)) || '/' || NVL(LF_DMUSER.FN_EMPLE_NM(ACCNT.EMPLE_NO),' ')
               END DEPT_EMPLE_NM
              ,ACCNT.PAY_MTHD
              ,CASE WHEN PROD.JOIN_GIFT_CARD_AMT IS NOT NULL THEN TRIM(TO_CHAR(NVL(PROD.JOIN_GIFT_CARD_AMT, 0),'999,999,999,999,999')) || '원' ELSE ' ' END COMB_VAL
              ,NVL((SELECT END_NO-ST_NO+1 FROM LF_DMUSER.PRODUCT_DTL WHERE PROD_CD = ACCNT.PROD_CD AND SEQ = 1), 0) COMB_NO
              ,SUBSTR(SUBSTR(ACCNT.JOIN_DT,1, 4),-2) JOIN_YEAR
              ,SUBSTR(SUBSTR(ACCNT.JOIN_DT,1, 6), -2) JOIN_MONTH
              ,SUBSTR(ACCNT.JOIN_DT, -2) JOIN_DAY

              /* 증서정보 */
              ,NVL(CM.COFFIN1,' ') COFFIN1
              ,NVL(CM.COFFIN2,' ') COFFIN2
              ,NVL(CM.SHROUD_M1,' ') SHROUD_M1
              ,NVL(CM.SHROUD_M2,' ') SHROUD_M2
              ,NVL(CM.SHROUD_D1,' ') SHROUD_D1
              ,NVL(CM.SHROUD_D2,' ') SHROUD_D2
              ,NVL(CM.COFFIN_GDS1,' ') COFFIN_GDS1
              ,NVL(CM.COFFIN_GDS2,' ') COFFIN_GDS2
              ,NVL(CM.COFFIN_GDS3,' ') COFFIN_GDS3
              ,NVL(CM.MORTUARY_GDS1,' ')MORTUARY_GDS1
              ,NVL(CM.MORTUARY_GDS2,' ') MORTUARY_GDS2
              ,NVL(CM.MORTUARY_GDS3,' ') MORTUARY_GDS3
              ,NVL(CM.CAR1,' ') CAR1
              ,NVL(CM.CAR2,' ') CAR2
              ,NVL(CM.CAR3,' ') CAR3
              ,NVL(CM.FLOWER_M1,' ') FLOWER_M1
              ,NVL(CM.FLOWER_M2,' ') FLOWER_M2
              ,NVL(CM.FLOWER_M3,' ') FLOWER_M3
              ,NVL(CM.FLOWER_D1,' ') FLOWER_D1
              ,NVL(CM.FLOWER_D2,' ') FLOWER_D2
              ,NVL(CM.FLOWER_D3,' ') FLOWER_D3
              ,NVL(CM.FUNERAL_CLOTHES1,' ') FUNERAL_CLOTHES1
              ,NVL(CM.FUNERAL_CLOTHES2,' ') FUNERAL_CLOTHES2
              ,NVL(CM.FUNERAL_CLOTHES3,' ') FUNERAL_CLOTHES3
              ,NVL(CM.HELPER_M1,' ') HELPER_M1
              ,NVL(CM.HELPER_M2,' ') HELPER_M2
              ,NVL(CM.HELPER_M3,' ') HELPER_M3
              ,NVL(CM.HELPER_D1,' ') HELPER_D1
              ,NVL(CM.HELPER_D2,' ') HELPER_D2
              ,NVL(CM.HELPER_D3,' ') HELPER_D3
              ,REPLACE(REPLACE(CM.TERMS_SVC,<![CDATA['<BR>']]>, '\N'  ),CHR(13),'') TERMS_SVC
              ,REPLACE(REPLACE(CM.TERMS_DTL,<![CDATA['<BR>']]>, '\N'  ),CHR(13),'') TERMS_DTL
              ,REPLACE(REPLACE(CM.CONSM_NT,<![CDATA['<BR>']]>, '\N'  ),CHR(13),'') CONSM_NT
              ,REPLACE(REPLACE(CM.REFUND_NT,<![CDATA['<BR>']]>, '\N'  ),CHR(13),'') REFUND_NT
              ,REPLACE(REPLACE(CM.CONSM_AMT_MNG,<![CDATA['<BR>']]>, '\N'  ),CHR(13),'') CONSM_AMT_MNG
              ,REPLACE(REPLACE(CM.REFUND_MATH1,<![CDATA['<BR>']]>, '\N'  ),CHR(13),'') REFUND_MATH1
              ,REPLACE(REPLACE(CM.REFUND_MATH2,<![CDATA['<BR>']]>, '\N' ),CHR(13),'') REFUND_MATH2
              ,REPLACE(REPLACE((CASE WHEN (ACCNT.PROD_CD = '19' AND ACCNT.PROD_MODEL_KIND = '0356') THEN (SELECT RESN_AMT_INFO FROM LF_DMUSER.CERTF_MNG WHERE PROD_CD = '19' AND TO_CHAR(UPD_DM,'YYYYMMDD') = '20170926' )
                                ELSE CM.RESN_AMT_INFO END),<![CDATA['<BR>']]>, '\N'),CHR(13),'') RESN_AMT_INFO
              ,REPLACE(CM.REFUND_AMT,CHR(13),'') REFUND_AMT
              ,REPLACE(CM.ASSET,CHR(13),'') ASSET
              ,REPLACE(CM.REFUND_MATH3,CHR(13),'') REFUND_MATH3
              ,REPLACE(CM.ETC  ,CHR(13),'') CMETC
              ,REPLACE(REPLACE(CM.ETC_VAL,<![CDATA['<BR>']]>, '\N' ),CHR(13),'')  ETC_VAL
              ,CASE WHEN PROD.PROD_CL='03' AND PROD.SECTION_F = '0001' THEN '계약금액'  ELSE ' '  END AS PROD_BUGA_LBL2
              ,CASE WHEN PROD.PROD_CL='03' THEN
                   CASE WHEN PROD.JOIN_TYPE ='0001' THEN '월납입금'
                        WHEN PROD.JOIN_TYPE ='0002' AND PROD.JOIN_GIFT_CARD_SORT ='0001' THEN '회차별납입액'
                        WHEN PROD.JOIN_TYPE ='0002' AND PROD.JOIN_GIFT_CARD_SORT ='0002' THEN '계약유형'
                        WHEN PROD.JOIN_TYPE ='0002' AND PROD.JOIN_GIFT_CARD_SORT ='0003' THEN '회차별납입액'
                   ELSE ' '
                    END
               ELSE ' '
                END PROD_BUGA_LBL3
              ,CASE WHEN PROD.PROD_CL='03' THEN
                   CASE WHEN PROD.JOIN_TYPE ='0001' THEN '계약유형'
                        WHEN PROD.JOIN_TYPE ='0002' AND PROD.JOIN_GIFT_CARD_SORT ='0001' THEN '계약유형'
                        WHEN PROD.JOIN_TYPE ='0002' AND PROD.JOIN_GIFT_CARD_SORT ='0002' THEN '기타사항'
                        WHEN PROD.JOIN_TYPE ='0002' AND PROD.JOIN_GIFT_CARD_SORT ='0003' THEN '계약유형'
                   ELSE ' '
                   END
               ELSE ' '
                END PROD_BUGA_LBL4
              ,CASE WHEN PROD.PROD_CL='03' THEN
                   CASE WHEN PROD.JOIN_TYPE ='0002' AND PROD.JOIN_GIFT_CARD_SORT ='0001' THEN (SELECT TRIM(TO_CHAR(SUM((ALLT_AMT+ADD_AMT) * (END_NO-ST_NO + 1)),'999,999,999,999,999')) ||'원' FROM LF_DMUSER.PRODUCT_DTL WHERE PROD_CD=PROD.PROD_CD AND ALLT_AMT+ADD_AMT>0)
                        WHEN PROD.JOIN_TYPE ='0002' AND PROD.JOIN_GIFT_CARD_SORT ='0002' THEN (SELECT '할부원금 ' || TRIM(TO_CHAR(SUM((ALLT_AMT+ADD_AMT) * (END_NO-ST_NO + 1)),'999,999,999,999,999')) || '원'  FROM LF_DMUSER.PRODUCT_DTL WHERE PROD_CD=PROD.PROD_CD AND ALLT_AMT+ADD_AMT>0)
                        WHEN PROD.JOIN_TYPE ='0002' AND PROD.JOIN_GIFT_CARD_SORT ='0003' THEN (SELECT TRIM(TO_CHAR(SUM((ALLT_AMT+ADD_AMT) * (END_NO-ST_NO + 1)),'999,999,999,999,999')) ||'원' FROM LF_DMUSER.PRODUCT_DTL WHERE PROD_CD=PROD.PROD_CD AND ALLT_AMT+ADD_AMT>0)
                   ELSE (SELECT CASE WHEN NVL(SUM((ALLT_AMT+ADD_AMT) * (END_NO-ST_NO + 1)),0) > 0 THEN '할부원금 ' || TRIM(TO_CHAR(SUM((ALLT_AMT+ADD_AMT) * (END_NO-ST_NO + 1)),'999,999,999,999,999')) || '원(VAT포함)' ELSE ' ' END FROM LF_DMUSER.PRODUCT_DTL WHERE PROD_CD=PROD.PROD_CD AND ALLT_AMT+ADD_AMT>0)
                   END
               ELSE ' '
                END PROD_BUGA_VAL2
              ,CASE WHEN PROD.PROD_CL='03' THEN
                   CASE WHEN PROD.JOIN_TYPE ='0001' THEN (SELECT ('월'||TRIM(TO_CHAR(ALLT_AMT+ADD_AMT,'999,999,999,999,999'))||'원*')|| TO_CHAR((END_NO-ST_NO+1))||'회' FROM LF_DMUSER.PRODUCT_DTL WHERE PROD_CD = PROD.PROD_CD AND MONTH_PAY_AMT>0 AND SEQ =1)
                        WHEN PROD.JOIN_TYPE ='0002' AND PROD.JOIN_GIFT_CARD_SORT ='0001' THEN (SELECT ('월'|| TRIM(TO_CHAR(ALLT_AMT+ADD_AMT,'999,999,999,999,999')) ||'원*')||TO_CHAR((END_NO-ST_NO+1))||'회' FROM LF_DMUSER.PRODUCT_DTL WHERE PROD_CD = PROD.PROD_CD AND MONTH_PAY_AMT>0 AND SEQ =1)
                        WHEN PROD.JOIN_TYPE ='0002' AND PROD.JOIN_GIFT_CARD_SORT ='0002' THEN (SELECT TO_CHAR( SUM(END_NO-ST_NO + 1)) || '개월 할부매매계약'  FROM LF_DMUSER.PRODUCT_DTL WHERE PROD_CD=PROD.PROD_CD AND ALLT_AMT+ADD_AMT>0)
                        WHEN PROD.JOIN_TYPE ='0002' AND PROD.JOIN_GIFT_CARD_SORT ='0003' THEN (SELECT ('월'|| TRIM(TO_CHAR(ALLT_AMT+ADD_AMT,'999,999,999,999,999'))||'원*')|| TO_CHAR((END_NO-ST_NO+1))||'회' FROM LF_DMUSER.PRODUCT_DTL WHERE PROD_CD = PROD.PROD_CD AND MONTH_PAY_AMT>0 AND SEQ =1)
                   ELSE (SELECT CASE WHEN NVL(SUM((ALLT_AMT+ADD_AMT) * (END_NO-ST_NO + 1)),0) > 0 THEN  '할부원금 ' || TO_CHAR(SUM((ALLT_AMT+ADD_AMT) * (END_NO-ST_NO + 1)))|| '원(VAT포함)' ELSE ' ' END FROM LF_DMUSER.PRODUCT_DTL WHERE PROD_CD=PROD.PROD_CD AND ALLT_AMT+ADD_AMT>0)
                   END
               ELSE ' '
                END PROD_BUGA_VAL3
              ,CASE WHEN PROD.PROD_CL='03' THEN
                   CASE  WHEN PROD.JOIN_TYPE ='0001' THEN (SELECT TO_CHAR( SUM(END_NO-ST_NO + 1)) || '개월 할부매매계약(무이자)'  FROM LF_DMUSER.PRODUCT_DTL WHERE PROD_CD=PROD.PROD_CD AND ALLT_AMT+ADD_AMT>0)
                         WHEN PROD.JOIN_TYPE ='0002' AND PROD.JOIN_GIFT_CARD_SORT ='0001' THEN '이용구매계약'
                         WHEN PROD.JOIN_TYPE ='0002' AND PROD.JOIN_GIFT_CARD_SORT ='0002' THEN '할부이자율 : 무이자'
                         WHEN PROD.JOIN_TYPE ='0002' AND PROD.JOIN_GIFT_CARD_SORT ='0003' THEN '구매 및 충전 계약'
                   ELSE ' '
                   END
               ELSE ' '
                END PROD_BUGA_VAL4
              ,CARDMEM.EXPIRE_DATE
              /* 2018.04.10 토탈라이프서비스, 실 해약환급내용 추가 */
              ,REPLACE(REPLACE(CM.TERMS_SVC,<![CDATA['<BR>']]>, '\n'),chr(13),'') AS TERMS_SVC  /*INFO_40*/
              ,REPLACE(REPLACE((CASE WHEN (ACCNT.PROD_CD = '19' AND ACCNT.PROD_MODEL_KIND = '0356') THEN
                                          ( SELECT RESN_AMT_INFO FROM LF_DMUSER.CERTF_MNG WHERE PROD_CD = '19' AND TO_CHAR(UPD_DM,'YYYYMMDD') = '20170926' )
                                     ELSE CM.RESN_AMT_INFO END),<![CDATA['<BR>']]>, '\N'),CHR(13),'') AS RESN_AMT_INFO /* INFO_41*/
          FROM LF_DMUSER.MEM_PROD_ACCNT ACCNT
          INNER JOIN LF_DMUSER.PRODUCT PROD
                  ON PROD.PROD_CD = ACCNT.PROD_CD
          INNER JOIN LF_DMUSER.PRODUCT_MODEL_CL_CD PMCC
                  ON ACCNT.PROD_MODEL_KIND = PMCC.MODEL_CL_CD
          INNER JOIN LF_DMUSER.MEMBER MEM
                  ON ACCNT.MEM_NO = MEM.MEM_NO
          LEFT OUTER JOIN LF_DMUSER.CMS_MEM CMSMEM
                  ON CMSMEM.ACCNT_NO = ACCNT.ACCNT_NO
                 AND CMSMEM.DEL_FG='N'
          LEFT OUTER JOIN LF_DMUSER.CARD_MEM CARDMEM
                  ON CARDMEM.ACCNT_NO = ACCNT.ACCNT_NO
                 AND CARDMEM.DEL_FG='N'
          LEFT OUTER JOIN ( SELECT A.*  ,  NVL( LF_DMUSER.FN_CERTF_MNG_APP_DM(A.PROD_CD,A.APP_DM) , '9999/12/31')  MIN_APP_DM FROM LF_DMUSER.CERTF_MNG A WHERE A.DEL_FG = 'N') CM
                  ON CM.PROD_CD = ACCNT.PROD_CD
                 AND CM.DEL_FG='N'
                 AND SUBSTR(ACCNT.JOIN_DT, 1,8) BETWEEN SUBSTR( CM.APP_DM, 1,8) AND REPLACE(CM.MIN_APP_DM,'/','')
         WHERE ACCNT.DEL_FG = 'N'
           AND MEM.DEL_FG='N'
           AND ACCNT.ACCNT_NO IN #{accnt_no}
        ORDER BY PROD.PROD_NM, ACCNT.ACCNT_NO
    </select>

    <!--
    * ================================================================
    * 날짜 : 20180221
    * 이름 : 송준빈
    * 추가내용 : 고객의 해약율과 해약금 조회 (2차 발송시 NICE 개별부로 보내지게 됨)
    * ================================================================
    -->
    <select id="WebNiceSendMap.getResnAmt" parameterType="map" resultType="resultMap">
        SELECT NVL(NO,0) NO
              ,PROD_CD
              ,ACCNT_NO
              ,ROUND(RESN_AMT,0) RESN_AMT
              ,CASE WHEN PROD_CD IN ('I7','I8','BI','W4','AM') THEN
                    CASE WHEN NO <![CDATA[<=]]> EXPR_NO AND NVL(TMTAMT,0) <![CDATA[>]]> 0 THEN TO_CHAR((SELECT PCT FROM LF_DMUSER.PRODUCT_NO_DATA WHERE PROD_CD = TMP.PROD_CD AND NO = TMP.NO))
                        WHEN NO > EXPR_NO THEN '100%'
                        ELSE ''
                    END
                ELSE
                CASE WHEN PROD_CD = '19' THEN
                    CASE WHEN NO <![CDATA[<=]]> EXPR_NO AND NVL(TMTAMT,0) <![CDATA[>]]> 0 THEN TO_CHAR((SELECT PCT FROM LF_DMUSER.PRODUCT_NO_DATA WHERE PROD_CD = '^9' AND NO = TMP.NO)) || '%'
                        WHEN NO > EXPR_NO THEN '100%'
                        ELSE ''
                    END
                WHEN PROD_CD = 'M1' THEN
                    CASE WHEN NO <![CDATA[<=]]> EXPR_NO AND NVL(TMTAMT,0) <![CDATA[>]]> 0 THEN TO_CHAR((SELECT PCT FROM LF_DMUSER.PRODUCT_NO_DATA WHERE PROD_CD = '^1' AND NO = TMP.NO)) || '%'
                        WHEN NO > EXPR_NO THEN '100%'
                        ELSE ''
                    END
                ELSE
                    CASE WHEN NO <![CDATA[<=]]> EXPR_NO AND NVL(TMTAMT,0) <![CDATA[>]]> 0 THEN NVL( TO_NUMBER(ROUND( TO_NUMBER(RESN_AMT) /  ((SELECT SUM(AMT) FROM LF_DMUSER.PRODUCT_NO_DATA WHERE PROD_CD = TMP.PROD_CD AND NO <![CDATA[<=]]> TMP.NO) ) * 100,0)),100) ||'%'
                        WHEN NO > EXPR_NO THEN '100%'
                        ELSE ''
                    END
                END
               END PCT
              ,TMTAMT
              ,PROD_NM
          FROM( SELECT D.NO
                      ,TM.SEQ
                      ,P.PROD_NM
                      ,P.PROD_CD
                      ,ACCNT.ACCNT_NO
                      ,D.RESN_AMT
                      ,P.EXPR_NO
                      ,TM.REAL_EXPR_NO
                      ,LF_DMUSER.FN_PROD_NO_AMT(P.PROD_CD,'01',D.NO)  AS TMTAMT
                  FROM (SELECT M.ACCNT_NO
                              ,T.SEQ
                              ,(P.EXPR_NO-NVL(M.NEW_CHAN_GUNSU,0)) REAL_EXPR_NO
                          FROM LF_DMUSER.MEM_PROD_ACCNT M
                          JOIN LF_DMUSER.PRODUCT P
                            ON M.PROD_CD =P.PROD_CD
                          LEFT JOIN LF_DMUSER.TMP_RESN_NO  T
                            ON 1=1
                         WHERE ACCNT_NO IN (#{accnt_no})
                       ) TM
                  JOIN LF_DMUSER.MEM_PROD_ACCNT ACCNT
                    ON TM.ACCNT_NO = ACCNT.ACCNT_NO
                  JOIN LF_DMUSER.PRODUCT P
                    ON ACCNT.PROD_CD = P.PROD_CD
                  LEFT JOIN LF_DMUSER.RESNSTD_M M
                    ON ACCNT.PROD_CD=M.PROD_CD
                   AND M.USE_YN = 'Y'
                   AND M.MODEL_CL_CD = ACCNT.PROD_MODEL_KIND
                   AND M.SEQ = LF_DMUSER.FN_RESNSTD_M_SEQ(ACCNT.PROD_CD,ACCNT.PROD_MODEL_KIND, ACCNT.JOIN_DT)
                  LEFT JOIN LF_DMUSER.RESNSTD_D D ON M.SEQ = D.MST_SEQ  AND D.NO = TM.SEQ
                   AND ACCNT.ACCNT_NO IN (#{accnt_no})
                ) TMP
        ORDER BY TMP.PROD_NM, ACCNT_NO, SEQ
    </select>

    <!--
    * ================================================================
    * 날짜 : 20180221
    * 이름 : 송준빈
    * 추가내용 : NICE 전자서명 대상 고객 정보 업데이트 (NICE에서 보내주는 데이터를 통하여 업데이트 됨)
    * 대상 테이블 : TB_MEMBER_NICE_INFO
    * ================================================================
    -->
    <update id="WebNiceSendMap.updateNiceSendStatement" parameterType="map">
        UPDATE LF_DMUSER.TB_MEMBER_NICE_INFO
           SET NCCS_STAT           = #{nccs_stat}
              ,UPP_TX_TYPE         = #{upp_tx_type}
              <if test="ci != null and ci != ''">
                  ,CI_VAL              = #{ci}
              </if>
              <if test="gender != null and gender != ''">
                  ,GENDER              = LPAD(#{gender}, 4,'0')
              </if>
              <if test="safekey != null and safekey != ''">
                  ,SAFEKEY             = #{safekey}
              </if>
              <if test="acuon_fitness_yn != null and acuon_fitness_yn != ''">
                  ,ACUON_FITNESS_YN    = #{acuon_fitness_yn}
              </if>
              <if test="img_file_nm != null and img_file_nm != ''">
                  ,IMG_FILE_NM         = #{img_file_nm}
              </if>
              <if test="img_file_path != null and img_file_path != ''">
                  ,IMG_FILE_PATH       = #{img_file_path}
              </if>
              <if test="finish_flag != null and finish_flag != ''">
                  ,FINISH_FLAG       = #{finish_flag}
              </if>
              <if test="upp_tx_type == '04'">
                  ,NICE_NO2             = #{nice_no}
              </if>
              <if test="upp_tx_type == '01'">
                  ,NICE_NO             = #{nice_no}
              </if>
         WHERE 1=1
           AND TRGT_CUST_DTPT_ID   = #{app_no}
    </update>



    <!--
    * ================================================================
    * 날짜 : 20180221
    * 이름 : 송준빈
    * 추가내용 : NICE 전자서명 SMS 발송 내역 조회
    * 대상 테이블 : TB_MEMBER_NICE_INFO, TB_MEMBER_NICE_INFO_HIST, TB_TRGT_CUST_DTPT, TB_USER
    * ================================================================
    -->
    <select id="WebNiceSendMap.getNiceSenderInfoList" parameterType="map" resultType="resultMap">
        SELECT X.*
          FROM ( SELECT ROWNUM                                 AS ROW_CNT           /* 행번호 */
                       ,A.MEM_NO                               AS MEM_NO            /* 고유번호 */
                       ,A.ACCNT_NO                             AS ACCNT_NO          /* 회원번호 */
                       ,C.MEM_NO                               AS CALL_MEM_NO       /* 고객번호(이건질문해야함) */
                       ,A.CUST_NM                              AS CUST_NM           /* 회원명 */
                       ,A.CLPH_TLNO                            AS CLPH_TLNO         /* 전화번호 */
                       ,A.BRTH_MON_DAY                         AS BRTH_MON_DAY      /* 생년월일 */
                       ,A.UPP_TX_TYPE                          AS UPP_TX_TYPE       /* 진행상태 */
                       ,DECODE(LENGTH(A.CI_VAL), 88, 'Y', 'N') AS TX_2              /* 본인인증여부 */
                       ,A.ACUON_FITNESS_YN                     AS ACUON_FITNESS_YN  /* 신용조회결과 */
                       ,B.RESULT_CODE                          AS RESULT_CODE       /* 처리결과 */
                       ,A.FINISH_FLAG                          AS FINISH_FLAG       /* 완료취소 여부 */
                       ,D.USER_NM                              AS RGSR_NM           /* 상담사명 */
                       ,A.RGSN_DTTM                            AS RGSN_DTTM         /* 1차발송일시 */
                       ,A.RGSN_DTTM2                           AS RGSN_DTTM2        /* 2차발송일시 */
                       ,'계약서'                                 AS CONTRACT_REPORT   /* 고객계약서 */
                       ,''                                     AS ETC_TEXT          /* 비고 */
                       ,A.TRGT_LIST_ID                         AS TRGT_LIST_ID      /* 캠페인ID */
                       ,A.SUB_TRGT_LIST_ID                     AS SUB_TRGT_LIST_ID  /* 서브타켓리스트ID */
                       ,A.TRGT_CUST_DTPT_ID                    AS TRGT_CUST_DTPT_ID /* 고객타켓리스트ID */
                       ,A.IMG_FILE_NM                          AS IMG_FILE_NM       /* 고객계약파일명 */
                       ,A.IMG_FILE_PATH                        AS IMG_FILE_PATH     /* 고객계약파일위치 */
                       ,A.NICE_NO2                             AS NICE_NO2          /* NICE2차번호 */
                   FROM LF_DMUSER.TB_MEMBER_NICE_INFO A
                   INNER JOIN (SELECT A.TRGT_CUST_DTPT_ID
                                     ,MAX(TO_NUMBER(B.TRGT_CUST_DTPT_SEQ))
                                     ,B.RESULT_CODE
                                     ,A.UPP_TX_TYPE
                                     ,A.NCCS_STAT
                                 FROM LF_DMUSER.TB_MEMBER_NICE_INFO A
                                 INNER JOIN LF_DMUSER.TB_MEMBER_NICE_INFO_HIST B
                                         ON A.TRGT_CUST_DTPT_ID = B.TRGT_CUST_DTPT_ID
                                        AND A.UPP_TX_TYPE = B.UPP_TX_TYPE
                                WHERE 1=1
                                GROUP BY A.TRGT_CUST_DTPT_ID, B.RESULT_CODE, A.UPP_TX_TYPE, A.NCCS_STAT
                               ) B
                           ON A.TRGT_CUST_DTPT_ID = B.TRGT_CUST_DTPT_ID
                          AND A.UPP_TX_TYPE = B.UPP_TX_TYPE
                   INNER JOIN TB_TRGT_CUST_DTPT C
                           ON A.TRGT_CUST_DTPT_ID = C.TRGT_CUST_DTPT_ID
                   INNER JOIN TB_USER D
                           ON A.RGSR_ID = D.USER_ID
                  WHERE 1=1
                    AND A.RGSN_DTTM BETWEEN TO_DATE(#{rgsn_dttm_from} || '000000', 'YYYYMMDDHH24MISS') AND TO_DATE(#{rgsn_dttm_to} || '235959', 'YYYYMMDDHH24MISS')
                    <if test="rgsr_nm != null and rgsr_nm != ''">
                           AND D.USER_NM = #{rgsr_nm}
                    </if>
                    <if test="clph_tlno != null and clph_tlno != ''">
                           AND A.CLPH_TLNO = #{clph_tlno}
                    </if>
               ) X
         WHERE 1=1
           AND X.ROW_CNT <![CDATA[>=]]> #{startLine}
           AND X.ROW_CNT <![CDATA[<]]> #{endLine}
    </select>

    <!--
    * ================================================================
    * 날짜 : 20180221
    * 이름 : 송준빈
    * 추가내용 : NICE 전자서명 SMS 발송 내역 조회 총 건수
    * 대상 테이블 : TB_MEMBER_NICE_INFO, TB_MEMBER_NICE_INFO_HIST, TB_TRGT_CUST_DTPT, TB_USER
    * ================================================================
    -->
    <select id="WebNiceSendMap.getTotalCount" parameterType="map" resultType="int">
        SELECT COUNT(*) AS ROW_CNT
          FROM LF_DMUSER.TB_MEMBER_NICE_INFO A
          INNER JOIN (SELECT A.TRGT_CUST_DTPT_ID
                                     ,MAX(TO_NUMBER(B.TRGT_CUST_DTPT_SEQ))
                                     ,B.RESULT_CODE
                                     ,A.UPP_TX_TYPE
                                     ,A.NCCS_STAT
                                 FROM LF_DMUSER.TB_MEMBER_NICE_INFO A
                                 INNER JOIN LF_DMUSER.TB_MEMBER_NICE_INFO_HIST B
                                         ON A.TRGT_CUST_DTPT_ID = B.TRGT_CUST_DTPT_ID
                                        AND A.UPP_TX_TYPE = B.UPP_TX_TYPE
                                WHERE 1=1
                                GROUP BY A.TRGT_CUST_DTPT_ID, B.RESULT_CODE, A.UPP_TX_TYPE, A.NCCS_STAT
                               ) B
                           ON A.TRGT_CUST_DTPT_ID = B.TRGT_CUST_DTPT_ID
                          AND A.UPP_TX_TYPE = B.UPP_TX_TYPE
          INNER JOIN TB_TRGT_CUST_DTPT C
                  ON A.TRGT_CUST_DTPT_ID = C.TRGT_CUST_DTPT_ID
          INNER JOIN TB_USER D
                  ON A.RGSR_ID = D.USER_ID
         WHERE 1=1
           AND A.RGSN_DTTM BETWEEN TO_DATE(#{rgsn_dttm_from} || '000000', 'YYYYMMDDHH24MISS') AND TO_DATE(#{rgsn_dttm_to} || '235959', 'YYYYMMDDHH24MISS')
           <if test="user_nm != null and user_nm != ''">
               AND D.USER_NM = #{user_nm}
           </if>
           <if test="clph_tlno != null and clph_tlno != ''">
               AND A.CLPH_TLNO = #{clph_tlno}
           </if>
    </select>

    <!--
    * ================================================================
    * 날짜 : 20180302
    * 이름 : 송준빈
    * 추가내용 : NICE 전자서명 대상 고객 완료 Flag 업데이트 (NICE에서 신용정보취득, 고객가입완료 전문 리턴시 완료 전문을 보낸뒤 완료여부를 업데이트 A는 1차접수완료, B는 2차접수완료)
    * 대상 테이블 : TB_MEMBER_NICE_INFO
    * ================================================================
    -->
    <update id="WebNiceSendMap.updateNiceFinishStatement" parameterType="map">
        UPDATE LF_DMUSER.TB_MEMBER_NICE_INFO
           SET FINISH_FLAG = #{finish_flag}
         WHERE 1=1
           AND TRGT_CUST_DTPT_ID   = #{app_no}
    </update>

    <!--
    * ================================================================
    * 날짜 : 20180305
    * 이름 : 송준빈
    * 추가내용 : 1차 전문 처리중 에러(Exception)시 해당 값 삭제
    * 대상 테이블 : TB_MEMBER_NICE_INFO
    * ================================================================
    -->
    <delete id="WebNiceSendMap.deleteExceptionHandlerNiceInfo" parameterType="map">
        DELETE FROM LF_DMUSER.TB_MEMBER_NICE_INFO
         WHERE 1=1
         <if test="trgt_cust_dtpt_id != null and trgt_cust_dtpt_id != ''">
             AND TRGT_CUST_DTPT_ID = #{trgt_cust_dtpt_id}
         </if>
         <if test="app_no != null and app_no != ''">
             AND TRGT_CUST_DTPT_ID = #{app_no}
         </if>
    </delete>

    <!--
    * ================================================================
    * 날짜 : 20180305
    * 이름 : 송준빈
    * 추가내용 : 1차 전문 처리중 에러(Exception)시 해당 값 초기화
    * 대상 테이블 : TB_TRGT_CUST_DTPT
    * ================================================================
    -->
    <update id="WebNiceSendMap.updateExceptionHandlerTrgtCust" parameterType="map">
        UPDATE TB_TRGT_CUST_DTPT
           SET BRTH_MON_DAY = ''
         WHERE 1=1
         <if test="trgt_cust_dtpt_id != null and trgt_cust_dtpt_id != ''">
             AND TRGT_CUST_DTPT_ID = #{trgt_cust_dtpt_id}
         </if>
         <if test="app_no != null and app_no != ''">
             AND TRGT_CUST_DTPT_ID = #{app_no}
         </if>
    </update>

    <!--
    * ================================================================
    * 날짜 : 20180305
    * 이름 : 송준빈
    * 추가내용 : 2차 전문 처리중 에러(Exception)시 고유번호와 회원번호 초기화
    * 대상 테이블 : TB_MEMBER_NICE_INFO
    * ================================================================
    -->
    <update id="WebNiceSendMap.updateExceptionHandlerNiceInfo2" parameterType="map">
        UPDATE LF_DMUSER.TB_MEMBER_NICE_INFO
           SET MEM_NO = ''
              ,ACCNT_NO = ''
              ,NICE_NO2 = ''
         WHERE 1=1
         <if test="trgt_cust_dtpt_id != null and trgt_cust_dtpt_id != ''">
             AND TRGT_CUST_DTPT_ID = #{trgt_cust_dtpt_id}
         </if>
         <if test="app_no != null and app_no != ''">
             AND TRGT_CUST_DTPT_ID = #{app_no}
         </if>
    </update>

    <!--
    * ================================================================
    * 날짜 : 20180305
    * 이름 : 송준빈
    * 추가내용 : 2차 전문 처리중 에러(Exception)시 고유번호와 회원번호 초기화
    * 대상 테이블 : TB_TRGT_CUST_DTPT
    * ================================================================
    -->
    <update id="WebNiceSendMap.updateExceptionHandlerTrgtCust2" parameterType="map">
        UPDATE TB_TRGT_CUST_DTPT
           SET MEM_NO = ''
              ,ACCNT_NO = ''
         WHERE 1=1
         <if test="trgt_cust_dtpt_id != null and trgt_cust_dtpt_id != ''">
             AND TRGT_CUST_DTPT_ID = #{trgt_cust_dtpt_id}
         </if>
         <if test="app_no != null and app_no != ''">
             AND TRGT_CUST_DTPT_ID = #{app_no}
         </if>
    </update>

    <!--
    * ================================================================
    *  날짜 : 20180309
    * 이름 : 송준빈
    * 추가내용 : 고객의 증서 이미지를 관리할 폴더를 만들기 위함임.
    * 대상 테이블 : MEM_PROD_ACCNT
    * ================================================================
    -->
    <select id="WebNiceSendMap.getMemberNiceJoinDt" parameterType="map" resultType="resultMap">
        SELECT JOIN_DT
          FROM LF_DMUSER.MEM_PROD_ACCNT
         WHERE 1=1
           AND ACCNT_NO = #{accnt_no}
    </select>

    <!--
    * ================================================================
    * 날짜 : 20180710
    * 이름 : 송준빈
    * 추가내용 : 가입후 재전송 회원 상태값 변경.
    * 대상 테이블 : TB_MEMBER_NICE_INFO
    * ================================================================
    -->
    <update id="WebNiceSendMap.updateResendNicePdfFile" parameterType="map">
        UPDATE LF_DMUSER.TB_MEMBER_NICE_INFO
   		   SET UPP_TX_TYPE = '03'
      	      ,NCCS_STAT   = '04'
              ,FINISH_FLAG = 'FR'
              ,IMG_FILE_NM = ''
              ,IMG_FILE_PATH = ''
 		 WHERE 1=1
  		   AND ACCNT_NO = #{accnt_no}
    </update>

    <!--
    *  ================================================================
    * 날짜 : 20180809
    * 이름 : 송준빈
    * 추가내용 : 최근 애큐온 인증 여부 Y/N
    * 대상 테이블 : TB_MEMBER_NICE_INFO
    * ================================================================
    -->
    <select id="WebNiceSendMap.getAcuonLatelyAuth" parameterType="map" resultType="resultMap">
        SELECT NICE_NO || '_' || AUTH_01 || AUTH_02 AS AUTH
  		  FROM ( SELECT NICE_NO
               		   ,AUTH_01
               		   ,AUTH_02
               		   ,RANK() OVER (ORDER BY IDX_AUTH DESC) IDX_AUTH
           		   FROM ( SELECT NICE_NO
                        		,AUTH_01
                        		,AUTH_02
                        		,RANK AS IDX_AUTH
                    		FROM ( SELECT A.NICE_NO
                                 		 ,A.UPP_TX_TYPE AS AUTH_01 -- 01 02 03 완료
                                 		 ,'신규' AS AUTH_02
                                 		 ,RANK() OVER (ORDER BY NICE_NO DESC) RANK
                             		 FROM LF_DMUSER.TB_MEMBER_NICE_INFO A
                            		WHERE A.CI_VAL = 'h1Ji9pLj2qxYHVUxbrxd3NzFbzr3xamNzdAYnmn/4MYtcl8YnHIz6KkqrjVz+tjW7IXAnEOvM/ENRHSDHyO2Mg=='
                         		 )
                   		   WHERE RANK = 1

                  		  UNION ALL

                  		 SELECT B.NICE_NO
                               ,A.UPP_TX_TYPE AS AUTH_01
                               ,B.UPP_TX_TYPE AS AUTH_02
                               ,2 AS IDX_AUTH
                           FROM LF_DMUSER.TB_MEMBER_NICE_INFO A
                           LEFT OUTER JOIN LF_DMUSER.TB_MEMBER_NICE_INFO_SECOND B
                                   ON A.NICE_NO = B.NICE_NO
                          WHERE 1=1
                          	AND B.DEL_FG = 'N'
                            AND B.ACCNT_NO = #{accnt_no}
                        ) TBL
               )
         WHERE IDX_AUTH = 1
    </select>

    <!--
    * ================================================================
    * 날짜 : 20180809
    * 이름 : 송준빈
    * 추가내용 : NICE 전자서명 2차대상 고객 저장
    * 대상 테이블 : TB_MEMBER_NICE_INFO_SECOND
    * ================================================================
    -->
    <insert id="WebNiceSendMap.insertMemberNiceInfoSecond" parameterType="map">
        	BEGIN
	        	UPDATE LF_DMUSER.TB_MEMBER_NICE_INFO_SECOND
	        	SET DEL_FG = 'Y'
	        	WHERE ACCNT_NO = #{accnt_no};

	     		INSERT INTO LF_DMUSER.TB_MEMBER_NICE_INFO_SECOND( JOIN_SEQ, NICE_NO, NICE_NO2, MEM_NO, ACCNT_NO
															 ,NCCS_STAT, UPP_TX_TYPE, IMG_FILE_NM, IMG_FILE_PATH
															 ,RGSR_ID, RGSN_DTTM, UPDT_DTTM, FINISH_FLAG, DEL_FG )
				 VALUES ( (SELECT NVL(MAX(JOIN_SEQ) , 0) + 1 FROM LF_DMUSER.TB_MEMBER_NICE_INFO_SECOND WHERE 1=1)
				         ,#{nice_no}, '', #{mem_no}, #{accnt_no}, '', '', '', '', #{rgsr_id}, SYSDATE, SYSDATE, '1Y', 'N');
			END;
    </insert>

    <!--
    * ================================================================
    * 날짜 : 20180809
    * 이름 : 송준빈
    * 추가내용 : NICE 전자서명 2차대상 고객 저장
    * 대상 테이블 : TB_MEMBER_NICE_INFO_SECOND
    * ================================================================
    -->
    <update id="WebNiceSendMap.updateNiceSendStatement2" parameterType="map">
        UPDATE LF_DMUSER.TB_MEMBER_NICE_INFO_SECOND
           SET NCCS_STAT           = #{nccs_stat}
              ,UPP_TX_TYPE         = #{upp_tx_type}
              ,UPDT_DTTM           = SYSDATE
              <if test="img_file_nm != null and img_file_nm != ''">
                  ,IMG_FILE_NM         = #{img_file_nm}
              </if>
              <if test="img_file_path != null and img_file_path != ''">
                  ,IMG_FILE_PATH       = #{img_file_path}
              </if>
              <if test="upp_tx_type == '04'">
                  ,NICE_NO2             = #{nice_no}
              </if>
         WHERE 1=1
           AND DEL_FG = 'N'
           AND ACCNT_NO   = #{app_no}
    </update>

    <!--
    * ================================================================
    * 날짜 : 20180221
    * 이름 : 송준빈
    * 추가내용 : 고객 타켓리스트 정보 조회
    * 대상 테이블 : TB_TRGT_CUST_DTPT
    * ================================================================
    -->
    <select id="WebNiceSendMap.getMemberNiceRetrieve2" parameterType="map" resultType="resultMap">
        SELECT JOIN_SEQ      AS JOIN_SEQ
			  ,NICE_NO       AS NICE_NO
			  ,NICE_NO2      AS NICE_NO2
			  ,MEM_NO        AS MEM_NO
			  ,ACCNT_NO      AS ACCNT_NO
			  ,NCCS_STAT     AS NCCS_STAT
			  ,UPP_TX_TYPE   AS UPP_TX_TYPE
			  ,IMG_FILE_NM   AS IMG_FILE_NM
			  ,IMG_FILE_PATH AS IMG_FILE_PATH
		 	  ,RGSR_ID       AS RGSR_ID
			  ,RGSN_DTTM     AS RGSN_DTTM
			  ,UPDT_DTTM     AS UPDT_DTTM
			  ,FINISH_FLAG   AS FINISH_FLAG
	      FROM LF_DMUSER.TB_MEMBER_NICE_INFO_SECOND
	     WHERE 1=1
	     AND DEL_FG = 'N'
	     <if test="app_no != null and app_no != ''">
             AND ACCNT_NO = #{app_no}
         </if>
	     <if test="accnt_no != null and accnt_no != ''">
             AND ACCNT_NO = #{accnt_no}
         </if>
    </select>

    <!--
    * ================================================================
    * 날짜 : 20180302
    * 이름 : 송준빈
    * 추가내용 : NICE 전자서명 대상 고객 완료 Flag 업데이트 (NICE에서 신용정보취득, 고객가입완료 전문 리턴시 완료 전문을 보낸뒤 완료여부를 업데이트 A는 1차접수완료, B는 2차접수완료)
    * 대상 테이블 : TB_MEMBER_NICE_INFO
    * ================================================================
    -->
    <update id="WebNiceSendMap.updateNiceFinishStatement2" parameterType="map">
        UPDATE LF_DMUSER.TB_MEMBER_NICE_INFO_SECOND
           SET FINISH_FLAG = #{finish_flag}
         WHERE 1=1
           AND ACCNT_NO = #{app_no}
           AND DEL_FG = 'N'
    </update>
    
    <!--
    * ================================================================
    * 날짜 : 20180824
    * 이름 : 송준빈
    * 추가내용 : 전자서명인증고객 관리 List
    * 대상 테이블 : TB_MEMBER_NICE_INFO
    * ================================================================
    -->
    <select id="WebNiceSendMap.getNiceAuthInformation" parameterType="map" resultType="resultMap">
        SELECT ''                  AS CHK               /* CHK                                           */
              ,A.CNTR_CD           AS CNTR_CD           /* 센터 코드                                     */
              ,A.TRGT_LIST_ID      AS TRGT_LIST_ID      /* 대상 목록 ID (캠페인 ID)                      */
              ,A.SUB_TRGT_LIST_ID  AS SUB_TRGT_LIST_ID  /* 서브 대상 목록 ID (캠페인 서브타켓 리스트 ID) */
              ,A.TRGT_CUST_DTPT_ID AS TRGT_CUST_DTPT_ID /* 대상 고객 상세 ID                             */
              ,A.CUST_NM           AS CUST_NM           /* 고객명                                        */
              ,A.CLPH_TLNO         AS CLPH_TLNO         /* 휴대폰전화번호                                */
              ,A.NICE_NO           AS NICE_NO           /* NICE가 발행한 해당접수건 고유 KEY값           */
              ,A.NCCS_STAT         AS NCCS_STAT         /* NICE가 보낸 상태코드 접수건 상태 값           */
              ,A.UPP_TX_TYPE       AS UPP_TX_TYPE       /* 전송구분값                                    */
              ,A.BRTH_MON_DAY      AS BRTH_MON_DAY      /* 고객생년월일                                  */
              ,A.CREDIT_RATING     AS CREDIT_RATING     /* 신용등급                                      */
              ,A.ACUON_FITNESS_YN  AS ACUON_FITNESS_YN  /* 애큐온심사적격여부                            */
              ,A.CI_VAL            AS CI_VAL            /* 본인인증값                                    */
              ,A.GENDER            AS GENDER            /* 성별                                          */
              ,A.SAFEKEY           AS SAFEKEY           /* 세이프키                                      */
              ,A.FINISH_FLAG       AS FINISH_FLAG       /* 완료여부                                      */
              ,A.RGSR_ID           AS RGSR_ID           /* 1차등록자                                     */
              ,A.RGSN_DTTM         AS RGSN_DTTM         /* 1차등록일시                                   */
          FROM LF_DMUSER.TB_MEMBER_NICE_INFO A
         WHERE 1=1
         <if test="mem_nm != null and mem_nm != ''">
             AND A.CUST_NM = #{mem_nm}
         </if>
         <if test="upp_tx_type != null and upp_tx_type != ''">
             AND A.UPP_TX_TYPE = #{upp_tx_type}
         </if>
         <if test="brth_mon_day != null and brth_mon_day != ''">
             AND A.BRTH_MON_DAY = #{brth_mon_day}
         </if>
         <if test="clph_tlno != null and clph_tlno != ''">
             AND A.CLPH_TLNO = #{clph_tlno}
         </if>
         <if test="stt_dt != null and stt_dt != '' and end_dt != null and end_dt != ''">
             AND A.RGSN_DTTM BETWEEN TO_DATE( #{stt_dt} || ' 000000', 'YYYYMMDD HH24MISS') AND TO_DATE( #{end_dt} || ' 235959', 'YYYYMMDD HH24MISS')
         </if>
    </select>
    
    <!--
    * ================================================================
    * 날짜 : 20180824
    * 이름 : 송준빈
    * 추가내용 : 전자서명가입고객 관리 List
    * 대상 테이블 : TB_MEMBER_NICE_INFO, TB_MEMBER_NICE_INFO_SECOND
    * ================================================================
    -->
    <select id="WebNiceSendMap.getNiceJoinInformation" parameterType="map" resultType="resultMap">
        SELECT ''              AS CHK                /* 체크플래그        */
              ,B.MEM_NO        AS MEM_NO             /* 고객고유번호      */
              ,B.ACCNT_NO      AS ACCNT_NO           /* 고객회원번호      */
              ,A.CUST_NM       AS CUST_NM            /* 고객명            */
              ,A.BRTH_MON_DAY  AS BRTH_MON_DAY       /* 고객생년월일      */
              ,A.GENDER        AS GENDER             /* 성별              */
              ,A.CI_VAL        AS CI_VAL             /* 본인인증값        */
              ,A.NICE_NO       AS NICE_NO_1          /* 1차접수시NICE번호 */
              ,B.NICE_NO2      AS NICE_NO_2          /* 2차접수시NICE번호 */
              ,A.UPP_TX_TYPE   AS UPP_TX_TYPE_AUTH_1 /* 1차접수진행상태   */
              ,A.NCCS_STAT     AS NCCS_STAT_1        /* 1차접수NICE상태   */
              ,B.UPP_TX_TYPE   AS UPP_TX_TYPE_AUTH_2 /* 2차접수진행상태   */
              ,B.NCCS_STAT     AS NCCS_STAT_2        /* 2차접수NICE상태   */
              ,B.IMG_FILE_NM   AS IMG_FILE_NM        /* 고객증서파일명    */
              ,B.IMG_FILE_PATH AS IMG_FILE_PATH      /* 고객증서파일경로  */
              ,A.RGSN_DTTM     AS RGSN_DTTM_1        /* 1차접수일시       */
              ,B.RGSN_DTTM     AS RGSN_DTTM_2        /* 2차접수일시       */
          FROM LF_DMUSER.TB_MEMBER_NICE_INFO A
          INNER JOIN LF_DMUSER.TB_MEMBER_NICE_INFO_SECOND B
                  ON A.NICE_NO = B.NICE_NO
                 AND B.DEL_FG = 'N'
         WHERE 1=1
         <if test="mem_no != null and mem_no != ''">
             AND B.MEM_NO = #{mem_no}
         </if>  
         <if test="accnt_no != null and accnt_no != ''">
             AND B.ACCNT_NO = #{accnt_no}
         </if>  
         <if test="mem_nm != null and mem_nm != ''">
             AND A.CUST_NM = #{mem_nm}
         </if>
         <if test="upp_tx_type != null and upp_tx_type != ''">
             AND B.UPP_TX_TYPE = #{upp_tx_type}
         </if>
         <if test="brth_mon_day != null and brth_mon_day != ''">
             AND A.BRTH_MON_DAY = #{brth_mon_day}
         </if>
         <if test="stt_dt != null and stt_dt != '' and end_dt != null and end_dt != ''">
             AND B.RGSN_DTTM BETWEEN TO_DATE( #{stt_dt} || ' 000000', 'YYYYMMDD HH24MISS') AND TO_DATE( #{end_dt} || ' 235959', 'YYYYMMDD HH24MISS')
         </if>
    </select>
    
    <!--
    * ================================================================
    * 날짜 : 20181015
    * 이름 : 송준빈
    * 추가내용 : 가입고객데이터 삭제
    * 대상 테이블 : TB_MEMBER_NICE_INFO_SECOND
    * ================================================================
    -->
    
    <update id="WebNiceSendMap.updateNiceJoinData" parameterType="map">
        UPDATE LF_DMUSER.TB_MEMBER_NICE_INFO_SECOND
           SET DEL_FG = 'Y'
         WHERE 1=1
           AND MEM_NO   = #{mem_no}
           AND ACCNT_NO = #{accnt_no}
           AND NICE_NO  = #{nice_no_1}
           <if test="nice_no_2 != null and nice_no_2 != ''">
               AND NICE_NO2 = #{nice_no_2}
           </if>
    </update>
    
    <!--
    * ================================================================
    * 날짜 : 20181015
    * 이름 : 송준빈
    * 추가내용 : 2차 전문 발송 에러시 Exception 처리
    * 대상 테이블 : TB_MEMBER_NICE_INFO_SECOND
    * ================================================================
    -->
    <delete id="WebNiceSendMap.deleteExceptionHandlerNiceInfoSecond" parameterType="map">
        DELETE FROM LF_DMUSER.TB_MEMBER_NICE_INFO_SECOND
         WHERE 1=1
           AND MEM_NO   = #{mem_no}
           AND ACCNT_NO = #{accnt_no}
           AND RGSR_ID = #{rgsr_id}
    </delete>

</mapper>

