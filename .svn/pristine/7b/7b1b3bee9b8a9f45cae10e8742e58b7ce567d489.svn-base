<?xml version="1.0" encoding="utf-8"?>
<FDL version="1.5">
  <TypeDefinition url="..\default_typedef.xml"/>
  <Form id="Frame_Top" classname="Frame_Top" inheritanceid="" position="absolute 0 0 1280 36" onsize="Frame_Top_onsize" class="frm_TopFrame" scrollbars="none" onmousemove="Frame_Top_onmousemove" dragscrolltype="none" rtldirection="ltr">
    <Layouts>
      <Layout>
        <Div id="Div00" taborder="1" text="Div00" position="absolute -2 -13 1296 41" style="background:#1377c5ff;"/>
        <PopupMenu id="pmu_menu" innerdataset="@ds_Menu_Popup" idcolumn="menuCd" captioncolumn="menuNm" levelcolumn="menuLvlVl" onmouseleave="pmu_menu_onmouseleave" position2="absolute l:4 w:123 t:46 h:174" positiontype="position2" transparenthittest="false" onmenuclick="pmu_menu_onmenuclick" class="popmenu_TF_subMenu"/>
        <Button id="btn_Focus" taborder="1" position2="absolute l:3 w:9 t:26 h:8" positiontype="position2" style="background:transparent stretch 5,5;" transparenthittest="true"/>
        <Static id="stc_incomingCall" position="absolute 25 10 43 25" style="background:transparent URL('IMG::ico_state.png');" onclick="stc_incomingCall_onclick"/>
        <Static id="stc_txt_ctiStatus" text="로그아웃" position="absolute 49 7 113 28" style="color:white;font:맑은 고딕,11,bold antialias;"/>
        <Static id="Static10" position="absolute 128 1 130 35" style="background:transparent URL('IMG::img_top_line.png') repeat-y;"/>
        <Static id="Static11" position="absolute 258 1 260 35" style="background:transparent URL('IMG::img_top_line.png') repeat-y;"/>
        <Static id="Static12" position="absolute 137 15 141 21" style="background:transparent URL('IMG::ico_ivr.png');"/>
        <Static id="stc_txt_qdn_nm" position="absolute 149 2 249 35" style="color:#bbdff2ff;font:Dotum,9;"/>
        <Static id="Static14" position="absolute 264 15 268 21" style="background:transparent URL('IMG::ico_ivr.png');"/>
        <Static id="stc_txt_tlno" position="absolute 276 8 360 29" style="color:#bbdff2ff;font:Dotum,9;"/>
        <Button id="btn_makeCallPop" taborder="1" class="btn_Top_Cti01" position="absolute 448 1 531 34" enable="false" onclick="btn_cti_onclick"/>
        <Button id="btn_clearCall" taborder="1" class="btn_Top_Cti02" enable="false" position="absolute 614 1 697 34" onclick="btn_cti_onclick"/>
        <Static id="Static00" position="absolute 365 1 367 35" style="background:transparent URL('IMG::img_top_line.png') repeat-y;"/>
        <Button id="btn_answer" taborder="1" class="btn_Top_Cti03" enable="false" position="absolute 531 1 614 34" onclick="btn_cti_onclick"/>
        <Button id="btn_ready" taborder="1" class="btn_Top_Cti04" enable="false" position="absolute 366 1 449 34" onclick="btn_cti_onclick"/>
        <Button id="btn_hold" taborder="1" class="btn_Top_Cti05" enable="false" position="absolute 697 1 798 34" onclick="btn_cti_onclick" style=":disabled {background:URL('IMG::btn_cti05_D.png');}"/>
        <Button id="btn_transfer" taborder="1" class="btn_Top_Cti06" enable="false" position="absolute 798 1 899 34" onclick="btn_cti_onclick" visible="false"/>
        <PopupDiv id="pdv_LoginInfo" style="background:white;border:1 solid #231916ff ;" onmouseleave="pdv_FamilySite_onmouseleave" class="popdiv_FamilySite" visible="false" position="absolute 12 50 285 257">
          <Layouts>
            <Layout>
              <Static id="sta_userNm" position="absolute 115 19 257 44" style="align:left top;font:맑은 고딕,13,bold antialias;" anchor="default" text="Name"/>
              <Static id="sta_lgnId" position="absolute 115 45 257 70" style="align:left top;font:맑은 고딕,13,bold antialias;" anchor="default" text="(ID)"/>
              <Static id="sta_teamNm" position="absolute 116 71 263 96" style="font:맑은 고딕,10,antialias;" anchor="default" text="team"/>
              <Static id="sta_cti" text="CTI ID :" position="absolute 116 93 163 118" style="font:맑은 고딕,10,antialias;" anchor="default"/>
              <Static id="sta_ctiID" position="absolute 168 93 255 118" style="font:맑은 고딕,10,antialias;" anchor="default" text="N/A"/>
              <Static id="sta_loginTime" position="absolute 98 137 255 162" style="font:맑은 고딕,10,antialias;" anchor="default"/>
              <Static id="Static07" text="로그인시간 :" position="absolute 18 138 124 163" style="font:맑은 고딕,10,antialias;" anchor="default"/>
              <Static id="sta_callNo" position="absolute 183 115 251 140" style="font:맑은 고딕,10,antialias;" anchor="default" text="N/A"/>
              <Static id="Static04" text="내선번호 :" position="absolute 116 115 179 140" style="font:맑은 고딕,10,antialias;" anchor="default"/>
              <Button id="btn_logout" taborder="3" text="로그아웃" onclick="btn_logout_onclick" class="btn_WF_Common" position="absolute 165 172 257 192" style="padding:0 0 0 0;" anchor="default"/>
              <Button id="btn_userInfo" taborder="4" text="상세정보" onclick="btn_userInfo_onclick" class="btn_WF_Common" position="absolute 16 172 108 192" style="padding:0 0 0 0;" anchor="default"/>
              <ImageViewer id="img_user" taborder="5" position="absolute 15 17 106 126" stretch="fit"/>
            </Layout>
          </Layouts>
        </PopupDiv>
        <Button id="btn_ctiLogin" taborder="2" class="btn_Top_CtiLogin" enable="true" position2="absolute r:5px w:100 t:1px h:35" positiontype="position2" onclick="btn_cti_onclick"/>
        <PopupDiv id="pdv_makeCall" visible="false" position="absolute 421 102 599 135" scrollbars="none">
          <Layouts>
            <Layout>
              <Edit id="edt_makeCall" taborder="7" inputtype="number,symbol" lengthunit="utf8" maxlength="14" position="absolute 3 3 103 23" onkeydown="edt_onkeydown"/>
              <Button id="btn_makeCall" taborder="8" text="걸기" position="absolute 105 3 145 23" class="btn_WF_Common" onclick="btn_cti_onclick"/>
            </Layout>
          </Layouts>
        </PopupDiv>
        <PopupDiv id="pdv_notReady" scrollbars="none" visible="false" position="absolute 421 158 503 247">
          <Layouts>
            <Layout>
              <ListBox id="lb_notReady" taborder="0" position="absolute 3 5 66 77" anchor="default" codecolumn="codecolumn" datacolumn="datacolumn" onitemchanged="lb_onitemchanged">
                <Dataset id="innerdataset">
                  <ColumnInfo>
                    <Column id="codecolumn" size="256"/>
                    <Column id="datacolumn" size="256"/>
                  </ColumnInfo>
                  <Rows>
                    <Row>
                      <Col id="codecolumn">0</Col>
                      <Col id="datacolumn">휴식</Col>
                    </Row>
                    <Row>
                      <Col id="codecolumn">2</Col>
                      <Col id="datacolumn">식사</Col>
                    </Row>
                    <Row>
                      <Col id="codecolumn">4</Col>
                      <Col id="datacolumn">교육</Col>
                    </Row>
                  </Rows>
                </Dataset>
              </ListBox>
            </Layout>
          </Layouts>
        </PopupDiv>
        <ActiveX id="VTMAPI" visible="false" position="absolute 546 48 625 75" progid="{C0A99929-F5A1-4549-8511-A42206826C0D}" windowed="true" useautobitmapcache="1" anchor="default" taborder="5" tabstop="false" ctmpeventget=""/>
        <ActiveX id="CAPI3X" visible="false" position="absolute 376 48 455 75" progid="{3598E614-E72D-4EDA-864C-E1547FDEE2CD}" useautobitmapcache="1" anchor="default" taborder="6" tabstop="false" LogTrace="1" LogPath="C:\inwooLog\"/>
        <ActiveX id="CAPI3XEvt" visible="false" position="absolute 461 48 540 75" progid="{E51C1DAD-2F38-4AA2-B4DC-3836F31CA80D}" windowed="true" useautobitmapcache="1" anchor="default" taborder="7" tabstop="false" ctmpeventget="CAPI3XEvt_ctmpeventget"/>
        <ActiveX id="VtmApiCtrl" visible="false" position="absolute 631 48 710 75" progid="{93A3D61B-C992-4A52-91BE-917A38BBEE6B}" windowed="true" useautobitmapcache="1" anchor="default" taborder="8" tabstop="false" ctmpeventget=""/>
        <Button id="btn_notReady" taborder="1" class="btn_Top_Cti07" enable="false" position="absolute 798 1 881 34" onclick="btn_cti_onclick"/>
        <Combo id="cbo_tac_cd" taborder="9" displaynulltext="선택" codecolumn="cd" datacolumn="cd_nm" innerdataset="@ds_tacCd" visible="false" anchor="default" position="absolute 905 8 1085 28" positiontype="position"/>
      </Layout>
    </Layouts>
    <Objects>
      <Dataset id="ds_trans_info" firefirstcount="0" firenextcount="0" useclientlayout="false" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="strSvcID" type="STRING" size="256"/>
          <Column id="strURL" type="STRING" size="256"/>
          <Column id="strInDatasets" type="STRING" size="256"/>
          <Column id="strOutDatasets" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_callInfo" firefirstcount="0" firenextcount="0" useclientlayout="false" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="mem_no" type="STRING" size="256"/>
          <Column id="consno_grop_no" type="STRING" size="256"/>
          <Column id="call_id" type="STRING" size="256"/>
          <Column id="call_typ" type="STRING" size="256"/>
          <Column id="inco_qdn" type="STRING" size="256"/>
          <Column id="inco_qdn_nm" type="STRING" size="256"/>
          <Column id="inco_tlno" type="STRING" size="256"/>
          <Column id="ars_srvc_addr" type="STRING" size="256"/>
          <Column id="ars_srvc_addr_nm" type="STRING" size="256"/>
          <Column id="uei_cntn" type="STRING" size="256"/>
          <Column id="cons_dspsmddl_dtpt_cd" type="STRING" size="256"/>
          <Column id="fist_call_inco_yn" type="STRING" size="256"/>
          <Column id="totl_cons_hr" type="STRING" size="256"/>
          <Column id="cti_crnc_dtl_id" type="STRING" size="256"/>
          <Column id="chk_dept_yn" type="STRING" size="256"/>
          <Column id="mem_cnt" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_incommingCall" firefirstcount="0" firenextcount="0" useclientlayout="false" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="consno_sqno" type="STRING" size="256"/>
          <Column id="consno" type="STRING" size="256"/>
          <Column id="consno_grop_no" type="STRING" size="256"/>
          <Column id="mem_no" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_basVlInfo" firefirstcount="0" firenextcount="0" useclientlayout="false" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="bas_vl_id" type="STRING" size="256"/>
          <Column id="bas_vl_nm" type="STRING" size="256"/>
          <Column id="bas_vl" type="STRING" size="256"/>
          <Column id="bas_vl_expi" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_ctiCrncHstr" firefirstcount="0" firenextcount="0" useclientlayout="false" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="cti_crnc_dtl_id" type="STRING" size="256"/>
          <Column id="call_typ_cd" type="STRING" size="256"/>
          <Column id="call_typ_dtl_cd" type="STRING" size="256"/>
          <Column id="call_id" type="STRING" size="256"/>
          <Column id="uei" type="STRING" size="256"/>
          <Column id="rec_id" type="STRING" size="256"/>
          <Column id="anino" type="STRING" size="256"/>
          <Column id="operation" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_tacCd" firefirstcount="0" firenextcount="0" useclientlayout="false" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="cd_set_cd" type="STRING" size="256"/>
          <Column id="cd" type="STRING" size="256"/>
          <Column id="cd_nm" type="STRING" size="256"/>
          <Column id="adtl_cd" type="STRING" size="256"/>
          <Column id="adtl_cd_nm" type="STRING" size="256"/>
          <Column id="use_yn" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
    </Objects>
    <Style url="CSS::main.css"/>
    <Bind/>
    <Script type="xscript4.0"><![CDATA[/********************************************************************************************/
/* 1. Include Library include, variables Declaration 영역                                  */
/********************************************************************************************/
include "LIB::lib_All.xjs";
include "LIB::lib_CTI.xjs";
include "LIB::lib_CTIControl.xjs";
include "LIB::lib_CTIButton.xjs";

var gv_ctiSrvrConnYn = "N";  	// CTI서버 접속시도 여부
var gv_ctiSrvrConnSucc = -1; 	// CTI서버 접속 성공여부
var gv_custCCFlag = false;   	// 회원이 먼저 끊은 경우
var gv_userCCFlag = false;

var gv_cti_crnc_dtl_id = "";	// CTI통화이력 ID
var gv_rec_id    = "";			// 녹취ID

/********************************************************************************************/
/* 2. Form 관련(onload 및 Form 이벤트) 처리                                           	*/
/********************************************************************************************/

/********************************************************************************************/
/* 3. Callback(gfn_Transaction 호출 후 처리내용)                                   		*/
/********************************************************************************************/
function fn_callBack(svcid, errcd, errmsg) 
{
	if (errcd != 0) {
		trace(errcd)
		return false;
	} else {
		switch (svcid) {
			case "saveIncommingCallCons":
			//trace(ds_incommingCall.saveXML());
			fn_movePageIbound(); // 인바운드 화면이동
			
			var sMemNo = ds_incommingCall.getColumn(0, "mem_no");
			var sConsnoGropNo = ds_incommingCall.getColumn(0, "consno_grop_no");
			var sConsnoSqno = ds_incommingCall.getColumn(0, "consno_sqno");
			fn_srchInboundMain(sMemNo, sConsnoGropNo, sConsnoSqno); // 인바운드 설정
			gfn_answerCall(); // 전화받기 호출
			
			// 회원이 없을 경우 신규고객등록 팝업 호출
			if (gfn_isNull(sMemNo)) {
				var sHomeTel = "";
				var sCell = "";
				var sIncoTlno = ds_incommingCall.getColumn(0, "inco_tlno")
				if (!gfn_isNull(sIncoTlno)) {
					if (gfn_isHpno(sIncoTlno) == -1) {	// 일반전화
						sHomeTel = sIncoTlno;
					} else {							// 휴대전화
						sCell = sIncoTlno;
					}
				}
				var sPrmr = {p_home_tel:sHomeTel, p_cell:sCell};
				var reVal = gfn_diaLog("회원 등록", -1, -1, 884, 601, "PS020000::PS020408.xfdl", false, sPrmr, false, false, true);
			}
			break;
			
			case "Frame_Top_BasVl":
			fn_initCti();
			break;
			
			case "saveCtiCrncHstr":
			gv_tm_yn = "N";
			
			for (var i=0;i<ap_WorkFrame.all.length; i++){
				if (ap_WorkFrame.all[i].prgmCode =='PS210001') { // 아웃바운드 화면
					ap_WorkFrame.all[i].form.div_Work.div_cust_info.fn_updateCtiCrncDtlId();
				}
			}
			break;
			
			case "FRAMETOPCD":
			ds_tacCd.insertRow(0);
			ds_tacCd.setColumn(0, "cd", "");
			ds_tacCd.setColumn(0, "cd_nm", "선택");
			
			cbo_tac_cd.value = "9";
			cbo_tac_cd.visible = true;
			break;
			
			case "logout":
			exit();
			break;
		}
	}
}

/********************************************************************************************/
/* 4. Validation 처리                                                                   	*/
/********************************************************************************************/
// CTI 통화이력 저장 전
function fn_preSaveCtiCrncHstr(p_operation)
{
	trace("[Frame_Top] fn_preSaveCtiCrncHstr CALL_TYP_CD-[" + gCallTyp + "] INCO_PATH_CD-[" + gCallTyp + "] CALL_ID-[" 
	       + gCtiId + "] UEI-[" + gUei + "] REC_ID-[" + gv_rec_id + "] ANINO-[" + gIncoTlno + " / " + gTelNo + "] OPERATION-[" 
	       + p_operation + "] CTI_CRNC_DTL_ID-[" + gv_cti_crnc_dtl_id + "]");

	trace("CALL_ID-[" + gCtiId + " / " + gCallRefId + "]");
	trace("ANINO-[인입번호 : " + gOtherParty + " / 인입번호 : " + gIncoTlno + " / 발신번호 : " + gTelNo + "]");
	trace("CALL_TYP_CD-[" + gInOutFlag + "] CALL_TYP_DTL_CD-[" + gCallTyp + "]");

	ds_ctiCrncHstr.clearData();
	ds_ctiCrncHstr.addRow();
	
	if (p_operation == "delivered") {
		gv_rec_id = "";
	}
	
	ds_ctiCrncHstr.setColumn(0, "cti_crnc_dtl_id" , gv_cti_crnc_dtl_id);
	ds_ctiCrncHstr.setColumn(0, "call_typ_cd"     , gInOutFlag);
	ds_ctiCrncHstr.setColumn(0, "call_typ_dtl_cd" , gCallTyp);
	ds_ctiCrncHstr.setColumn(0, "call_id"         , gCallRefId);
	ds_ctiCrncHstr.setColumn(0, "uei"             , gUei);
	
	ds_ctiCrncHstr.setColumn(0, "rec_id"          , gv_rec_id);
	ds_ctiCrncHstr.setColumn(0, "anino"           , gOtherParty);
	ds_ctiCrncHstr.setColumn(0, "operation"       , p_operation);
	
	/* 통화 종료 후에도 통화이력 및 녹취 데이터 전송 가능하도록 초기화 막음
	if (p_operation == "clear") {
		gv_rec_id = "";
		gv_cti_crnc_dtl_id = "";
		gv_tm_yn = "N";
	}
	*/
	
	return true;
}

/********************************************************************************************/
/**   5. 서비스 호출(gfn_Transaction)                                                   	*/
/********************************************************************************************/
// 전화 인입시 호출
function fn_incomingCall()
{
	trace("[Frame_top] 전화인입에 따른 상담저장");
	ds_callInfo.setColumn(0, "cti_crnc_dtl_id", gv_cti_crnc_dtl_id);
	
	ds_callInfo.setColumn(0, "chk_dept_yn", "Y");	// 엔컴 부서코드 조건여부
	
	var szSvcid       = "saveIncommingCallCons";
    var szController  = "/cons/save";
    var szInDs        = "ds_input=ds_callInfo";
    var szOutDs       = "ds_incommingCall=ds_output";
    var szParam       = ""
    var szRetCallback = "fn_callBack";
	
    // 트랜젝션 공통함수 호출
    gfn_transaction(this, szSvcid, szController, szInDs, szOutDs, szParam, szRetCallback);
}

// CTI 통화이력 저장
function fn_saveCtiCrncHstr(p_operation)
{
	trace("[Frame_top] fn_saveCtiCrncHstr CTI 통화이력 저장");
	
	if (!fn_preSaveCtiCrncHstr(p_operation)) return false;
	
	var szSvcid       = "saveCtiCrncHstr";
    var szController  = "/cti-hstr/save";
    var szInDs        = "ds_input=ds_ctiCrncHstr";
    var szOutDs       = "";
    var szParam       = "";
    
    var sCallback = "";
    if (gv_tm_yn == "Y") {
		sCallback = "fn_callBack";
    }
    var szRetCallback = sCallback;
	
    // 트랜젝션 공통함수 호출
    gfn_transaction(this, szSvcid, szController, szInDs, szOutDs, szParam, szRetCallback);
}

// 전화 연결시 호출
function fn_establishedCall()
{
	trace("[Frame_top] 전화연결에 따른 고객조회 및 신규등록");
    var sCallTyp = ds_callInfo.getColumn(0, "call_typ");
    if (sCallTyp != "I") {
        return;
    }
    var nMemCnt = ds_callInfo.getColumn(0, "mem_cnt");
	if (gfn_isNull(nMemCnt)) {
	    return;
	}
	// 상담메인 초기화
	fn_srchInboundMain();
	
    var sIncoTlno = ds_callInfo.getColumn(0, "inco_tlno");
  
    var arrUEI = gfn_Split(ds_callInfo.getColumn(0, "uei_cntn"),"^");    
    if (arrUEI.length == 3){
		sIncoTlno = arrUEI[0] ;
    }            
      
	var sHomeTel = "";
	var sCell = "";
	if (!gfn_isNull(sIncoTlno)) {
		if (gfn_isHpno(sIncoTlno) == -1) {	// 일반전화
			sHomeTel = sIncoTlno;
		} else {							// 휴대전화
			sCell = sIncoTlno;
		}
	}
	if (nMemCnt > 0) { // 고객이 있는 경우 고객조회 팝업
	    var sPrmr = {p_mem_nm: "", p_home_tel: sHomeTel, p_cell: sCell};
		for (var i = 0; i < ap_WorkFrame.all.length; i++) {
			if (ap_WorkFrame.all[i].prgmCode == "DL500001") {//if (ap_WorkFrame.all[i].prgmCode == "PS020001") { // 인바운드 화면
				ap_WorkFrame.all[i].form.div_Work.div_member.fn_srch_mem_popup(sPrmr);
				break;
			}
		}
	} else { // 고객이 없는 경우 회원등록 팝업
	    var sPrmr = {p_home_tel: sHomeTel, p_cell: sCell};
		var reVal = gfn_diaLog("회원 등록", -1, -1, 884, 601, "PS020000::PS020408.xfdl", false, sPrmr, false, false, true);
	}
}

/********************************************************************************************/
/* 6. 사용자 함수                                                                   	*/
/********************************************************************************************/
function fn_setBasVlCTI()
{	
	if (gv_ctiSrvrConnYn == "Y") {
		return false;
	}
	gv_ctiSrvrConnYn = "Y";
	
	gfn_initSoftPhoneData();                // 상태에 따른 버튼 제어 초기화
	gfn_changeCtiStatus(CTI_STATUS_LOGOUT); // CTI 버튼제어 및 상담원 상태 저장
	
	gfn_getList("basVl", "cti_ip1,cti_port1,rec_ip1,rec_port1,rec_dual_ip,rec_dual_port,rec_dual_play_port,tac_id", null, null, "Frame_Top_BasVl", "ds_basVlInfo");  // 공통코드조회
}

// CTI 초기화
function fn_initCti()
{		
	// 녹취 정보(CTI사용여부 상관없이 녹취IP설정)
	gRecIp1 = ds_basVlInfo.getColumn(ds_basVlInfo.findRow("bas_vl_nm", "rec_ip1"), "bas_vl");
	gRecPort1 = ds_basVlInfo.getColumn(ds_basVlInfo.findRow("bas_vl_nm", "rec_port1"), "bas_vl");
		
	if (gds_UserInfo.getColumn(0, "cti_use_yn") == "Y") {
		// CTI 접속정보
        gCtiIp1   = ds_basVlInfo.getColumn(ds_basVlInfo.findRow("bas_vl_nm", "cti_ip1"), "bas_vl");
        gCtiPort1 = ds_basVlInfo.getColumn(ds_basVlInfo.findRow("bas_vl_nm", "cti_port1"), "bas_vl");
        
		gExtnNo   = gds_UserInfo.getColumn(0, "extn_no"); 	// 내선번호"3051";
		gCtiId    = gds_UserInfo.getColumn(0, "cti_id");   	// CTI ID "44701";
		gCtiParty = gds_UserInfo.getColumn(0, "pty_grop_no");
		gCtiGroup = gds_UserInfo.getColumn(0, "acd_grop_no"); 
		
		// 부분 녹취 정보
		gRecDualIp = ds_basVlInfo.getColumn(ds_basVlInfo.findRow("bas_vl_nm", "rec_dual_ip"), "bas_vl");
        gRecDualPort = ds_basVlInfo.getColumn(ds_basVlInfo.findRow("bas_vl_nm", "rec_dual_port"), "bas_vl");
        gRecDualPlayPort = ds_basVlInfo.getColumn(ds_basVlInfo.findRow("bas_vl_nm", "rec_dual_play_port"), "bas_vl");
        
		gv_ctiSrvrConnSucc = gfn_connectCTI(); // CTI 서버 접속
		
		// TAC
		//cbo_tac_cd
		var sUserId = gds_UserInfo.getColumn(0, "user_id");
		var sBzptDiv = gds_UserInfo.getColumn(0, "bzpt_div");
//		var sTacIds = ds_basVlInfo.getColumn(ds_basVlInfo.findRow("bas_vl_nm", "tac_id"), "bas_vl");
//		var sTacId = sTacIds.split(",");
		
// 		for (var i=0; i<sTacId.length; i++) {
// 			if (sUserId == sTacId[i]) {
// 				gfn_getList("cd", "CNS190", null, null, "FRAMETOPCD", "ds_tacCd");  // 공통코드조회
// 				break;
// 			}
// 		}
		
		/******************************************************************
		 모든이에
		 2018120008 최해리 센터장님 (2019.02.28 추가)
		 2019030024 민혜경 (2020.01.21 추가)
		 2019010003 김민우 (2020.01.21 추가)
		 2018120011 이민순 (2020.01.21 추가)
		 2019010002 장택진 (2020.01.21 추가)
		 2019040004 박서영 (2020.01.21 추가)
		 2019110006 김정자 (2020.01.21 추가)
		 2019010023 박가연 (2020.01.21 추가)
		 2019100018 조영자 (2020.01.21 추가)
		 2019040037 채희원 (2020.01.21 추가)
		 
		 모든이에 전체적용(2020.02.19)
		******************************************************************/		
		if (sBzptDiv == "T20300") {                    // 비투퀄리티
			gfn_getList("cd", "CNS190", null, null, "FRAMETOPCD", "ds_tacCd");  // 공통코드조회
		} else if (sBzptDiv == "T20400") {             // 더블루라인 (** 2018.08.07 추가)
			gfn_getList("cd", "CNS191", null, null, "FRAMETOPCD", "ds_tacCd");  // 공통코드조회
		} else if ( sBzptDiv == "T20200") {
			gfn_getList("cd", "CNS192", null, null, "FRAMETOPCD", "ds_tacCd");  // 공통코드조회
		}
	}
}

// 로그아웃 처리
function processLogout()
{
	trace("Frame_top [processLogout] 로그아웃 처리 ctiStatus=> " + ctiStatus);
	stc_txt_tlno.text = "";
	if (ctiStatus != "로그아웃") {
        gfn_agentLogout();
    }
    gfn_disconnectCTI(); // CTI 서버 연결 해제
    
    
	// 로그아웃 요청
	var szSvcid       = "logout";
	var szController  = "/logout";
	var szInDs        = "";
	var szOutDs       = "";
	var szParam       = "";
	var szRetCallback = "fn_callBack";

	// 트랜젝션 공통함수 호출
	gfn_transaction(this, szSvcid, szController, szInDs, szOutDs, szParam, szRetCallback);
}

// 전화 수신 알림 팝업
function fn_setInComingPop()
{	
	var reVal = gfn_diaLog("전화수신알림", -1, -1, 884, 601, "PS020000::PS020201.xfdl", false, {}, false, false, true);
}

/****************************************************************************************************
 함수명 변경해서 개발 상단 타이틀바 상담사정보 클릭시 팝업레이어 호출 FN

******************************************************************************************************/
function fn_openFamilySite(obj)
{
	//var nX   = system.clientToScreenX(obj, 0)+obj.position.width-pdv_FamilySite.position.width;
	var nX   = system.clientToScreenX(obj, 0);
	var nY   = system.clientToScreenY(obj, 0) + obj.position.height;
	
	if(!pdv_FamilySite.isPopup()) {
		//this.pdv_FamilySite.grd_FamilySite.vscrollbar.pos = 0;
		var RetVal = pdv_FamilySite.trackPopup(nX, nY);
	} else {
		pdv_FamilySite.closePopup();
	}
}

/***************************************************************************
 * 함  수  명		: fn_showNmsg()
 * 기      능		: 쪽지팝업호출
 ***************************************************************************/
function fn_showNmsg()
{
	var strParam = "";
	var rtn = gfn_diaLog("Comm_UserInfo", -1, -1, 719, 469, "MAIN::noteBox.xfdl", false, strParam, true, true, true);
}

//개인정보변경
function fn_showUserEnvrStup()
{

}

//로그인 사용자 정보
function fn_showUserInfo(obj)
{	
	//trace(gds_UserInfo.getColumn(0, 'user_id')+":::::::::::::::::");
	var sFileId = gds_UserInfo.getColumn(0, 'file_id');
	var sFilePath = "/theme/images/xxx.jpg";
	if (!gfn_isNull(sFileId)) sFilePath = "/file/download?file_id="+sFileId;
	pdv_LoginInfo.img_user.image = "URL('fileUrl::"+sFilePath+"')";
	
	pdv_LoginInfo.sta_lgnId.text = "(" + gds_UserInfo.getColumn(0, 'lgn_id') + ")";
	pdv_LoginInfo.sta_userNm.text = gds_UserInfo.getColumn(0, 'user_nm');
	var teamNm = gds_UserInfo.getColumn(0, 'team_nm');
	if (teamNm == undefined || teamNm == "") teamNm = "";
	pdv_LoginInfo.sta_teamNm.text = teamNm;
	var ctiId = gds_UserInfo.getColumn(0, 'cti_id');
	if (gfn_isNull(ctiId)) ctiId = "N/A";
	pdv_LoginInfo.sta_ctiID.text =  ctiId;
	var extnNo = gds_UserInfo.getColumn(0, 'extn_no');
	if (gfn_isNull(extnNo)) extnNo = "N/A";
	pdv_LoginInfo.sta_callNo.text = extnNo;
	pdv_LoginInfo.sta_loginTime.text = gfn_getFullDateFormat(GV_LOGINTIME);

	var nX   = system.clientToScreenX(obj, 0);
	var nY   = system.clientToScreenY(obj, 0) + obj.position.height;
	
	if(!pdv_LoginInfo.isPopup()) {
		var RetVal = pdv_LoginInfo.trackPopup(nX, nY);
	} else {
		pdv_LoginInfo.closePopup();
	}
}

// 상담 시간설정 종료
function fn_endTotalConsHr()
{
	for(var i=0;i<ap_WorkFrame.all.length; i++){
		if (ap_WorkFrame.all[i].prgmCode =='DL500001') {//if (ap_WorkFrame.all[i].prgmCode =='PS020001') { //인바운드 화면
			ap_WorkFrame.all[i].form.div_Work.div_cons_memo.fn_endTotalConsHr(); // 상담 시간설정 종료
		}
	}
}

// 인바운드 정보 조회
function fn_srchInboundMain(pMemNo, pConsnoGropNo, pConsnoSqno, pTotlConsHr)
{
	for(var i=0;i<ap_WorkFrame.all.length; i++){
		if (ap_WorkFrame.all[i].prgmCode =='DL500001') {//if (ap_WorkFrame.all[i].prgmCode =='PS020001') { 												// 인바운드 화면
			if (gfn_isNull(pMemNo)) {
				ap_WorkFrame.all[i].form.div_Work.div_member.fn_init("init");							// 회원 초기화
				ap_WorkFrame.all[i].form.div_Work.div_cons_memo.fn_init();                              // 상담 초기화
			} else {
				ap_WorkFrame.all[i].form.div_Work.div_member.fn_srch_cust(pMemNo, "", true); 			// 회원 조회
				ap_WorkFrame.all[i].form.div_Work.div_cons_memo.fn_setConsGrop(pConsnoGropNo, pConsnoSqno); // 상담 조회
			}
			ap_WorkFrame.all[i].form.div_Work.div_cons_memo.fn_clearTotalConsHr(); 						// 상담 시간설정 초기화
			ap_WorkFrame.all[i].form.div_Work.div_product.edt_rec_dual_hr.value = "";					// 녹취 초기화
			if (!gfn_isNull(pTotlConsHr)) {
				ap_WorkFrame.all[i].form.div_Work.div_cons_memo.edt_totl_cons_hr.value = pTotlConsHr;
			}
		}
	}
}

// 인바운드 정보 초기화
function fn_initInboundMain()
{
	for(var i=0;i<ap_WorkFrame.all.length; i++){
		if (ap_WorkFrame.all[i].prgmCode =='DL500001') {//if (ap_WorkFrame.all[i].prgmCode =='PS020001') { 								// 인바운드 화면
			ap_WorkFrame.all[i].form.div_Work.div_member.fn_init("init");     			// 고객정보 초기화
			ap_WorkFrame.all[i].form.div_Work.div_cons_memo.fn_init();           		// 상담정보 초기화
			ap_WorkFrame.all[i].form.div_Work.div_cons_memo.fn_endTotalConsHr(); 		// 시간 설정 종료
			ap_WorkFrame.all[i].form.div_Work.div_cons_memo.edt_totl_cons_hr.value = "";// 상담 시간 초기화
		}
	}
}

// 인바운드 화면이동
function fn_movePageIbound()
{
	if (ap_WorkFrame.all[ap_activeWinKey].prgmCode != "DL500001") {//if (ap_WorkFrame.all[ap_activeWinKey].prgmCode != "PS020001") { 				// 현재 프로그램 코드 비교
		ap_MDITabFrame.form.lfn_activeTabpage(gds_OpenList.getColumn(0, 'WINKEY')); // 탭페이지 이동
	}
}

// 팝업 체크
function fn_openPopupChk(chkPupupId, sType)
{
	for (var i=application.popupframes.length-1 ; i>=0 ; i--) 
	{
		var strPopupId = String(application.popupframes[i].name);

		if (strPopupId.indexOf(chkPupupId) != -1) {
			var objChildFrame = application.popupframes[i];
			if (sType == "CC") { // 호전환팝업 상담사B가 끊은 경우
				objChildFrame.form.fn_setBtn("Y");
			} else {
				objChildFrame.form.btn_close_onclick(); // 전화받기 팝업 닫기
			}
			break;;
		}
	}
}

function fn_initRecDual()
{
	for(var i=0;i<ap_WorkFrame.all.length; i++){
		if (ap_WorkFrame.all[i].prgmCode =='DL500001') { //if (ap_WorkFrame.all[i].prgmCode =='PS020001') { 								// 인바운드 화면
			ap_WorkFrame.all[i].form.div_Work.div_product.btn_recDual.visible = false;	// 부분녹취 시작 버튼
			ap_WorkFrame.all[i].form.div_Work.div_product.btn_concCmpl.visible = true;	// 계약완료 버튼
			ap_WorkFrame.all[i].form.div_Work.div_product.btn_concCmpl.enable = false;
		}
	}
}

/********************************************************************************************/
/* 7. 이벤트(Event) Function                                                          	*/
/********************************************************************************************/
// 로그아웃 버튼 클릭
function btn_logout_onclick(obj:Button,  e:ClickEventInfo)
{
	exit();
}

// 상세정보 버튼 클릭
function btn_userInfo_onclick(obj:Button,  e:ClickEventInfo)
{
	var reVal = gfn_diaLog("사용자 상세", -1, -1,  560, 719, "PS990000::PS992300.xfdl", false, {}, false, false, true);
	//var reVal = gfn_diaLog("사용자 상세", -1, -1, -1, -1, "PS050000::PS050100.xfdl", true, {}, false, false, true);
}

//
function fn_Nmsg(obj){
	
	var reVal = gfn_diaLog("쪽지함", -1, -1, 560, 719, "PS020000::PS020101.xfdl", false, "", false, false, true);
}

// CTI 버튼 클릭
function btn_cti_onclick(obj:Button,  e:ClickEventInfo)
{
	gfn_setCtiStatus(obj.name);
}

// ocx 이벤트 수신
function CAPI3XEvt_ctmpeventget(obj:ActiveX, eventKind)
{
	gMonitorParty = CAPI3XEvt.MonitorParty;
    gOtherParty = CAPI3XEvt.OtherParty;
    gQueueDn = CAPI3XEvt.queuedn;
    gArgs = "";
    
    var eventType = eventKind.EventKind;
    
    trace("[Frame_Top] eventType => " + eventType);
    
	switch(eventType) {
		// 10 : 호 발생
		case ctmpEK_Originated:		
			gCallRefId = CAPI3XEvt.CallRefID;
			gActiveCallId = CAPI3XEvt.CallRefID;
			gActiveDevice = gMonitorParty;

			gMakeCallTlno = CAPI3XEvt.CalledParty;
			
			gArgs = "ctmpEK_Originated.";
		break;

		// 4 : 착/수신 - 전화벨이 울리는 상태
		case ctmpEK_Delivered:
			gCallId = CAPI3XEvt.CallRefID;
			gCallRefId = CAPI3XEvt.CallRefID;
			gActiveCallId = CAPI3XEvt.CallRefID;
			gUei = CAPI3XEvt.uei;
			gArgs = "ctmpEK_Delivered.";
    
			if (CAPI3XEvt.LocalConnState == ctmpES_Altering) { // 상대방이 전화를 걸었을 때
				trace("상대방이 전화를 걸었을 때");
				trace("[Frame_Top] ctmpEK_Delivered gUei => " + gUei);
				
				if (gHeldFlag == 0) { // 보류중이 아니라면
					gInOutFlag = "I";
				}
				
				gfn_changeCtiStatus(CTI_STATUS_RINGING, gOtherParty);
				trace("[event] changeCtiStatus [CTI_STATUS_RINGING]");
			} else {                                          // 내가 전화를 걸었을 때(ctmpES_Connect)
				trace("내가 전화를 걸었을 때");
				if (gHeldFlag == 0) {
					gInOutFlag = "O";
				}
				
				trace("[Frame_Top] ctmpEK_Delivered gUei => " + gUei);
				if (!gfn_isNull(gUei)) {
					gCallTyp = gUei.substring(0, 1);
					// 호전환시도
					if (gCallTyp == "T") {
						gfn_changeCtiStatus(CTI_STATUS_CONSULTATION_1);
						trace("[event] gfn_changeCtiStatus [CTI_STATUS_CONSULTATION_1]");
					} 
					// 3자통화 시도
					else if (gCallTyp == "C") {
						gfn_changeCtiStatus(CTI_STATUS_CONSULTATIONCONF_1);
						trace("[event] gfn_changeCtiStatus [CTI_STATUS_CONSULTATIONCONF_1]");
					} 
					// 호전환시도 3자통화가 아닌 경우
					else {
						gfn_changeCtiStatus(CTI_STATUS_INITIATED, gOtherParty);
						trace("[event] gfn_changeCtiStatus [CTI_STATUS_INITIATED]");
					}
				} else {
					gfn_changeCtiStatus(CTI_STATUS_INITIATED, gOtherParty);
					trace("[event] gfn_changeCtiStatus [CTI_STATUS_INITIATED]");
				}
			}
			
			if (gHeldFlag == 0) {
				fn_saveCtiCrncHstr("delivered");// CTI통화이력 저장
				gfn_CTIDeliveredHandler(); 		// 콜발생 처리
			}
		break;
	
		// 6 : 전화 연결
		case ctmpEK_Established:
			gCallId = CAPI3XEvt.CallRefID;
			gCallRefId = CAPI3XEvt.CallRefID;
			gActiveCallId = CAPI3XEvt.CallRefID;
			gActiveDevice = gMonitorParty;
			gArgs = "ctmpEK_Established.";
        
			if (gHeldFlag == 1) { 		// 보류중 일 경우
				if (gCallTyp == "T") {  		// 호전환시도
					gfn_changeCtiStatus(CTI_STATUS_CONSULTATION_2);
					trace("[event] gfn_changeCtiStatus [CTI_STATUS_CONSULTATION_2]");
				} else if (gCallTyp == "C") {   // 3자통화시도
					gfn_changeCtiStatus(CTI_STATUS_CONSULTATIONCONF_2);
					trace("[event] gfn_changeCtiStatus [CTI_STATUS_CONSULTATIONCONF_2]");
				}
			} else {
				gv_rec_id = gfn_getTodayFull() + "" + gExtnNo;	// 녹취ID 생성
				trace("[Frame_Top] ctmpEK_Established-gv_rec_id [" + gv_rec_id + "]");
				
				if (gCallTyp == "T") {	// 호전환시도
					gfn_changeCtiStatus(CTI_STATUS_CONSULTATION_3); // 협의통화
					trace("[event] gfn_changeCtiStatus [CTI_STATUS_CONSULTATION_3]");
				} else {
					gfn_changeCtiStatus(CTI_STATUS_BUSY); 			// 통화중
					trace("[event] gfn_changeCtiStatus [CTI_STATUS_BUSY]");
				}
				
				// 2016. 07. 12 추가
				for(var i=0;i<ap_WorkFrame.all.length; i++){
					if (ap_WorkFrame.all[i].prgmCode =='DL500001') {//if (ap_WorkFrame.all[i].prgmCode =='PS020001') { // 인바운드 화면
						ap_WorkFrame.all[i].form.div_Work.div_product.btn_recDual.visible = true;	// 부분녹취 시작 버튼
						ap_WorkFrame.all[i].form.div_Work.div_product.btn_concCmpl.visible = false;	// 계약완료 버튼
						ap_WorkFrame.all[i].form.div_Work.div_product.btn_concCmpl.enable = false;
					}
				}
				
				// gfn_startRec();	// 녹취시작
				fn_saveCtiCrncHstr("established");	// CTI통화이력 저장
				gfn_CTIEstablishedHandler(); 		// 콜연결 처리
			}
        break;
        
        // 8 : 보류
		case ctmpEK_Held:
			gArgs = "ctmpEK_Held.";
			gHeldFlag = 1;
			gHeldCallId = CAPI3XEvt.CallRefID;
			gHeldDevice = CAPI3XEvt.MonitorParty;
			
			gfn_changeCtiStatus(CTI_STATUS_HELD);
            trace("[event] gfn_changeCtiStatus [CTI_STATUS_HELD]");
		break;
		
		// 12 : 보류 해제
		case ctmpEK_Retrieved:
			gArgs = "ctmpEK_Retrieved.";
			gActiveCallId = gHeldCallId;
			gActiveDevice = gHeldDevice;
			gCallRefId = CAPI3XEvt.CallRefID;
			
			if (CAPI3XEvt.MonitorParty == CAPI3XEvt.OtherParty) {
				gHeldFlag = 0;

				gfn_changeCtiStatus(CTI_STATUS_BUSY);
				trace("[event] gfn_changeCtiStatus [CTI_STATUS_BUSY]");
			}
		break;
		
		// 14 : 전환 통화
		case ctmpEK_Transferred:
			gArgs = "ctmpEK_Transferred.";
			
			// 전환넘김
			if (CAPI3XEvt.ThirdPartyCause == ctmpV_AddedParty) {
				trace("[event] Transfered");
				gHeldFlag = 0;
				
				gfn_agentACW(); 		// 후처리
				
				fn_initInboundMain(); 	// 인바운드 초기화
			}
			// 전환받음
			else {
				trace("[event] Transfering gUei => " + gUei);
				gActiveCallId = CAPI3XEvt.CallRefID;
				gActiveDevice = CAPI3XEvt.MonitorParty;
				
				trace("[Frame_Top] Transfering gActiveCallId => "+gActiveCallId+", gActiveDevice => "+gActiveDevice);
				
				gCallId = gUei.substring(1, 7).trim();        // 콜ID
				//gv_memNo = gUei.substring(7, 19).trim();      // 회원고유번호
				gIncoTlno = gUei.substring(19, 33).trim();    // 인입번호
				//gv_consGrpNo = gUei.substring(33, 53).trim(); // 상담그룹번호
				//gv_totl_cons_hr = gUei.substring(53, 61).trim(); // 상담시간
				
				ds_callInfo.setColumn(0, "call_id", gCallId);
				ds_callInfo.setColumn(0, "inco_tlno", gIncoTlno);
				
				if (ctiStatus == CTI_STATUS_CONSULTATION_3) { // 협의통화
					gfn_changeCtiStatus(CTI_STATUS_BUSY); // 통화 중
					trace("[event] gfn_changeCtiStatus [CTI_STATUS_BUSY]");
				}
				
				// ds_callInfo 재설정
				trace("[Frame_Top] Transfering gCallId => "+gCallId+", gIncoTlno => "+gIncoTlno);
				if (gIncoTlno.length != 4) { // 내선번호
					// fn_incomingCall(); // 상담저장 호출
					fn_srchInboundMain(gv_memNo, gv_consGrpNo, 1, gv_totl_cons_hr); // 고객 및 상담 조회
				}
				stc_txt_tlno.text = gfn_phoneNumStr(gIncoTlno);    // 인입번호 재설정
			}
		break;
		
		// 2 : 회의 통화
		case ctmpEK_Confernced:
			gArgs = "ctmpEK_Confernced.";
			gActiveCallId = CAPI3XEvt.CallRefID;
			gActiveDevice = CAPI3XEvt.MonitorParty;

			// Conferencing
			if (CAPI3XEvt.MonitorParty == CAPI3XEvt.CalledParty) {
				trace("[event] Conferencing");
				gActiveCallId = CAPI3XEvt.CallRefID;
				gActiveDevice = CAPI3XEvt.MonitorParty;
				
				gfn_changeCtiStatus(CTI_STATUS_CONSULTATIONCONF_3); // 3자통화
				trace("[event] gfn_changeCtiStatus [CTI_STATUS_CONSULTATIONCONF_3]");
			}
			// Conferenced
			else {
				trace("[event] Conferenced");
				trace("[event] Conferenced gUei => " + gUei);
				trace("[Frame_Top] Conferenced gActiveCallId => "+gActiveCallId+", gActiveDevice => "+gActiveDevice);
				
				gHeldFlag = 0;
				
				gCallId = gUei.substring(1, 7).trim(); // 콜ID
				//gv_memNo = gUei.substring(7, 19).trim(); // 회원고유번호
				gIncoTlno = gUei.substring(19, 33).trim(); // 인입번호
				ds_callInfo.setColumn(0, "call_id", gCallId);
				ds_callInfo.setColumn(0, "inco_tlno", gIncoTlno);
				
				// ds_callInfo 재설정
				trace("[Frame_Top] Conferenced gCallId => "+gCallId+", gIncoTlno => "+gIncoTlno);
				/*if (gIncoTlno.length != 4) { // 내선번호
					fn_incomingCall(); // 상담저장 호출
				}*/
				gfn_answerCall(); // 전화받기 호출
				
				gfn_changeCtiStatus(CTI_STATUS_CONSULTATIONCONF_3); // 3자통화
				trace("[event] gfn_changeCtiStatus [CTI_STATUS_CONSULTATIONCONF_3]");
				
				stc_txt_tlno.text = gfn_phoneNumStr(gIncoTlno);   // 인입번호
			}
		break;

        // 3 : 전화 끊기
		case ctmpEK_ConnectionCleared:
			gArgs = "ctmpEK_ConnectionCleared.";
						
			gClickButton = ""; // 클릭 버튼 초기화
			gCallId = CAPI3XEvt.CallRefID;
			
			trace("CAPI3XEvt.LocalConnState => " + CAPI3XEvt.LocalConnState);
			trace("ctiStatus => " + ctiStatus + ", gHeldFlag => " + gHeldFlag);
			
			if(gHeldFlag == 0) {
				gActiveCallId 	= CAPI3XEvt.CallRefID;
				gActiveDevice 	= gMonitorParty;
			} else {
				gActiveCallId = gHeldCallId;
				gActiveDevice = gHeldDevice;
				gHeldFlag = 0;
			}
			
			trace("gCallRefId => " + gCallRefId);
			
			// 전화를 건 사람이 끊었을 때
			if (CAPI3XEvt.LocalConnState == ctmpES_Connect) {
				trace("[event] 전화 건 사람이 끊음");
				
				if (ctiStatus == CTI_STATUS_CONSULTATIONCONF_3) { 	// 3자통화
					gfn_changeCtiStatus(CTI_STATUS_BUSY); 			// 통화 중
					trace("[event] gfn_changeCtiStatus [CTI_STATUS_BUSY]");
				}
				
				fn_openPopupChk("전화수신알림"); // 팝업 닫기
			}
			/*
			// 전환시도, 협의 중 고객이 끊었을 때
			else if (CAPI3XEvt.LocalConnState == ctmpES_Hold && (ctiStatus == CTI_STATUS_CONSULTATION_1 || ctiStatus == CTI_STATUS_CONSULTATIONCONF_1)) {
				trace("[event] 전환시도 중 회원이 전화를 끊음");
				gv_custCCFlag = true; 						// 회원 끊음
				
				gfn_changeCtiStatus(CTI_STATUS_INITIATED); 	// 발신 중
				trace("[event] gfn_changeCtiStatus [CTI_STATUS_INITIATED]");
				btn_transfer.class = "btn_Top_Cti06"; 		// 전환 class 변경
				
				alert("회원이 전화를 끊었습니다.");
			}
			else if (CAPI3XEvt.LocalConnState == ctmpES_Hold && (ctiStatus == CTI_STATUS_CONSULTATION_2 || ctiStatus == CTI_STATUS_CONSULTATIONCONF_2)) {
				trace("[event] 협의 중 회원이 전화를 끊음");
				gv_custCCFlag = true; 						// 회원 끊음
				
				gfn_changeCtiStatus(CTI_STATUS_BUSY); 		// 통화 중
				trace("[event] gfn_changeCtiStatus [CTI_STATUS_BUSY]");
				btn_transfer.class = "btn_Top_Cti06"; 		// 전환 class 변경
				
				alert("회원이 전화를 끊었습니다.");
			}
			*/
			// 전화를 받은 사람이 끊었을 때(ctmpES_Null)
			else if (CAPI3XEvt.LocalConnState == ctmpES_Null) {
				trace("[event] 전화 받은 사람이 끊음 gHeldFlag => "+gHeldFlag+", gv_userCCFlag => "+gv_userCCFlag+", ctiStatus => "+ctiStatus+", gv_custCCFlag => "+gv_custCCFlag);
				/*
				if ((ctiStatus == CTI_STATUS_CONSULTATION_1 || ctiStatus == CTI_STATUS_CONSULTATIONCONF_1 || 
				     ctiStatus == CTI_STATUS_CONSULTATION_2 || ctiStatus == CTI_STATUS_CONSULTATIONCONF_2) 
				     && !gv_custCCFlag && !gv_userCCFlag) {	// 호전환협의 중 상담사가 끊었을 경우
					trace("[Frame_Top] 호전환 협의중 상담사가 끊었을 경우 또는 Reconnect(CC)");
				
					btn_transfer.class = "btn_Top_Cti06"; 	// 전환 class 변경
					fn_openPopupChk("호전환", "CC");
					
					gfn_retrieveCall(); 					// retrieved
// clearConnect 한 후에 retrieved 하지 않고 consultationTrans 할 수 없다.
// 					gfn_changeCtiStatus(CTI_STATUS_HELD, gIncoTlno); // 보류 중
// 					trace("[event] gfn_changeCtiStatus [CTI_STATUS_HELD]");
				} else if(gHeldFlag == 0 && !gv_custCCFlag) {
					trace("[Frame_Top] 일반 인바운드 끊기");
						
					fn_endTotalConsHr(); // 상담 시간설정 종료
					gfn_agentACW();      // 후처리
					
					gv_userCCFlag = false;
				} else if (ctiStatus == CTI_STATUS_CONSULTATION_1 || ctiStatus == CTI_STATUS_CONSULTATION_2
				       || ctiStatus == CTI_STATUS_CONSULTATIONCONF_1 || ctiStatus == CTI_STATUS_CONSULTATIONCONF_2) {
					btn_transfer.class = "btn_Top_Cti06"; 	// 전환 class 변경
					gv_userCCFlag = true;                 	// 고객이 끊고 전환대상자가 끊은 경우
				}
				
				gv_custCCFlag = false;
				*/
				
				fn_endTotalConsHr(); // 상담 시간설정 종료
				gfn_agentACW();      // 후처리
				
				// gfn_endRec(); // 녹취종료
				if (gv_rec_dual_yn == "Y") {
					gv_rec_dual_id = gv_rec_id;
				}
				
				// 부분녹취종료
				for(var i=0;i<ap_WorkFrame.all.length; i++){
					if (ap_WorkFrame.all[i].prgmCode =='DL500001') {//if (ap_WorkFrame.all[i].prgmCode =='PS020001') { 								// 인바운드 화면
						if (ap_WorkFrame.all[i].form.div_Work.div_product.btn_recDual.text == CTI_STATUS_CANCELRECDUAL) {
							ap_WorkFrame.all[i].form.div_Work.div_product.fn_endRecHr();			// 부분녹취 종료
						}
						ap_WorkFrame.all[i].form.div_Work.div_product.btn_recDual.visible = false;	// 부분녹취 시작 버튼
						ap_WorkFrame.all[i].form.div_Work.div_product.btn_concCmpl.visible = true;	// 계약완료 버튼
						if (gv_rec_dual_yn == "Y") {
							ap_WorkFrame.all[i].form.div_Work.div_product.btn_concCmpl.enable = true;
						}
					}
				}
				
				gfn_recConsData(CTI_STATUS_ACW); // 녹취 상담 데이터 전송
			
			    fn_saveCtiCrncHstr("clear"); // CTI통화이력 저장
			}
		break;
		
		case ctmpEK_Popup:
			gArgs = "ctmpEK_Popup.";
		break;
			
		default:
			if (eventType == 1) {        // 호 끊김
				gArgs = "ctmpEK_CallCleared.";
			}
			else if (eventType == 5) {   // 가로채기
				gArgs = "ctmpEK_Diverted.";
			}
			else if (eventType == 7) {   // 실패
				gArgs = "ctmpEK_Failed.";
			}
			else if (eventType == 9) {   // 국선점유
				gArgs = "ctmpEK_NetworkReached.";
			}
			else if (eventType == 11) {  // Queue 발생
				gArgs = "ctmpEK_Queued.";
			}
			else if (eventType == 13) {  // 새로운 호 초기화
				gCallRefId = CAPI3XEvt.CallRefID;
				gActiveCallId = CAPI3XEvt.CallRefID;
				gActiveDevice = gMonitorParty;
				
				gArgs = "ctmpEK_ServiceInitated.";
    
				if (CAPI3XEvt.LocalConnState == ctmpES_Altering) { // 상대방이 전화를 걸었을 때
					trace("[Frame_Top] ctmpEK_ServiceInitated => 상대방이 전화를 걸었을 때");
					
					gfn_changeCtiStatus(CTI_STATUS_RINGING, gOtherParty);
					trace("[event] changeCtiStatus [CTI_STATUS_RINGING]");
				} else { // 내가 전화를 걸었을 때(ctmpES_Connect)
					trace("[Frame_Top] ctmpEK_ServiceInitated => 내가 전화를 걸었을 때");
					
					gfn_changeCtiStatus(CTI_STATUS_INITIATED, gOtherParty);
					trace("[event] gfn_changeCtiStatus [CTI_STATUS_INITIATED]");
				}
			}
			else if (eventType == 201) { // CTI 로그인
				gArgs = "ctmpEK_LoggedOn.";
				btn_ctiLogin.class = "btn_Top_CtiLogout"; // 버튼 이미지 변경
			}
			else if (eventType == 202) { // 로그오프
				gActiveCallId = CAPI3XEvt.CallRefID;
				gActiveDevice = CAPI3XEvt.CalledParty;

				callCtmpMethod("MonitorStop"); // 모니터링 중지
				
				btn_ctiLogin.class = "btn_Top_CtiLogin"; // 버튼 이미지 변경
				
				trace("[event] gfn_changeCtiStatus [CTI_STATUS_LOGOUT]");
				gArgs = "ctmpEK_LoggedOff.";
				
				for (var i = 0; i < ap_WorkFrame.all.length; i++) {
					if (ap_WorkFrame.all[i].prgmCode == "DL500001") {//if (ap_WorkFrame.all[i].prgmCode == "PS020001") { // 인바운드 화면
						ap_WorkFrame.all[i].form.div_Work.div_member.fn_init("click");
						ap_WorkFrame.all[i].form.div_Work.div_cons_memo.fn_init();
						break;
					}
				}
			}
			else if (eventType == 203) { // 휴식
				if (gReasonCd == 0) {
					gfn_changeCtiStatus(CTI_STATUS_NOT_READY_0);
				} else if (gReasonCd == 2) {
					gfn_changeCtiStatus(CTI_STATUS_NOT_READY_2);
				} else if (gReasonCd == 4) {
					gfn_changeCtiStatus(CTI_STATUS_NOT_READY_4);
				}
				gArgs = "ctmpEK_NotReady.";
			}
			else if (eventType == 204) { // 통화대기
				gClickButton = ""; // 클릭 버튼 초기화

				gHeldFlag = 0;
				gActiveCallId = CAPI3XEvt.CallRefID;
				gActiveDevice = CAPI3XEvt.CalledParty;

				gfn_changeCtiStatus(CTI_STATUS_READY);				
				trace("[event] gfn_changeCtiStatus [CTI_STATUS_READY]");
				
				gArgs = "ctmpEK_Ready.";
			}
			else if (eventType == 205) { // 통화중
				gArgs = "ctmpEK_OtherWork.";
			}
			else if (eventType == 206) { // 후처리
				gfn_changeCtiStatus(CTI_STATUS_ACW);
				trace("[event] gfn_changeCtiStatus [CTI_STATUS_ACW]");
			
				gArgs = "ctmpEK_AfterCallWork.";
			}
			else if (eventType == 999) {
				gArgs = "ctmpEK_CCSEDown.";
			}
			else {
				gArgs = ""+eventType+".";
			}
							
			gActiveCallId = CAPI3XEvt.CallRefID;
			gActiveDevice = CAPI3XEvt.CalledParty;
		break;
	}
	
	trace("Event[ "+gArgs+" ] Occurred..");
}

// ListBox 선택 : 사유코드
function lb_onitemchanged(obj:ListBox, e:ItemChangeEventInfo)
{
	gfn_agentNotReady(obj.value);
	pdv_notReady.closePopup();
	obj.value = "";
}

// edit onkeydown
function edt_onkeydown(obj:Edit, e:KeyEventInfo)
{
	if (obj.name == "edt_makeCall") { // 전화걸기
		if (e.keycode == 13) { // 엔터
			gfn_setCtiStatus("btn_makeCall");
		}
	}
}

// 콜인입 테스트
function stc_incomingCall_onclick(obj:Static,  e:ClickEventInfo)
{
	if (gds_UserInfo.getColumn(0, "athr_cd") != "AT01") {
	    return;
	}

	// 전화받기 파라미터 설정
	ds_callInfo.clearData();
	ds_callInfo.addRow();
	ds_callInfo.setColumn(0, "call_typ", "I");
	ds_callInfo.setColumn(0, "inco_tlno", gfn_phoneNumStr("01011111111"));
	ds_callInfo.setColumn(0, "inco_qdn", "2698");
	ds_callInfo.setColumn(0, "inco_qdn_nm", "1588-8511");

	fn_setInComingPop(); // 전화받기 팝업
}
]]></Script>
  </Form>
</FDL>
