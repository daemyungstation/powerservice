<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="DlwDeductionMap">

    <!-- ================================================================
     * 날짜 : 20190124
     * 이름 : 송준빈
     * 추가내용 : 공제 데이터 전송 기준데이터 리스트 (신규/타사 페이지)
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_DAY_EXT
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getGongjeDayExtCount" parameterType="map" resultType="int">
        SELECT /* DlwDeductionMap.getGongjeDayExtCount */
               COUNT(*) AS ICNT
          FROM ( SELECT ROW_NUMBER() OVER(ORDER BY ${orderBy} ${orderDirection}) AS PAGE_INDX
                       ,GDATE
                       ,ACCNT_NO
                       ,CL
                       ,GBIT
                       ,SI_DATE
                   FROM LF_DMUSER.TB_GONGJE_DAY_EXT
                  WHERE 1=1
                    AND GDATE = #{srchDt}
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_createAndOtherCorp')">
                      AND CL = 'D'
                    </if>
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_rescission')">
                      AND CL = 'R'
                    </if>
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_infoUpdate')">
                      AND CL = 'U'
                    </if>
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_transferBrkdn')">
                      AND CL = 'T'
                    </if>
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_event')">
                      AND CL = 'E'
                    </if>
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_prePayment')">
                      AND CL = 'P'
                    </if>
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_prePaymentCancel')">
                      AND CL = 'P_C'
                    </if>
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_rescissionCancel')">
                      AND CL = 'R_C'
                    </if>
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_eventCancel')">
                      AND CL = 'E_C'
                    </if>
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_readyCash')">
                      AND CL = 'C'
                    </if>
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_readyCashCancel')">
                      AND CL = 'C_C'
                    </if>
               ) MAIN_TBL
         WHERE 1=1
    </select>

    <!-- ================================================================
     * 날짜 : 20190124
     * 이름 : 송준빈
     * 추가내용 : 공제 데이터 전송 기준데이터 리스트 (신규/타사 페이지)
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_DAY_EXT
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getGongjeDayExtList" parameterType="map" resultType="resultMap">
        SELECT /* DlwDeductionMap.getGongjeDayExtList */
               MAIN_TBL.*
          FROM ( SELECT ROW_NUMBER() OVER(ORDER BY ${orderBy} ${orderDirection}) AS PAGE_INDX
                       ,GDATE
                       ,ACCNT_NO
                       ,CL
                       ,GBIT
                       ,SI_DATE
                   FROM LF_DMUSER.TB_GONGJE_DAY_EXT
                  WHERE 1=1
                    AND GDATE = #{srchDt}
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_createAndOtherCorp')">
                      AND CL = 'D'
                    </if>
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_rescission')">
                      AND CL = 'R'
                    </if>
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_infoUpdate')">
                      AND CL = 'U'
                    </if>
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_transferBrkdn')">
                      AND CL = 'T'
                    </if>
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_event')">
                      AND CL = 'E'
                    </if>
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_prePayment')">
                      AND CL = 'P'
                    </if>
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_prePaymentCancel')">
                      AND CL = 'P_C'
                    </if>
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_rescissionCancel')">
                      AND CL = 'R_C'
                    </if>
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_eventCancel')">
                      AND CL = 'E_C'
                    </if>
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_readyCash')">
                      AND CL = 'C'
                    </if>
                    <if test="svc_id != null and svc_id != '' and svc_id.equalsIgnoreCase('tp_readyCashCancel')">
                      AND CL = 'C_C'
                    </if>
               ) MAIN_TBL
         WHERE 1=1
         <if test="startLine != null and startLine != '' and endLine != null and endLine != ''">
           AND PAGE_INDX <![CDATA[>=]]> #{startLine}
           AND PAGE_INDX <![CDATA[<]]> #{endLine}
         </if>
    </select>

    <!-- ================================================================
     * 날짜 : 20190124
     * 이름 : 송준빈
     * 추가내용 : 공제 데이터 전송 기준데이터 산출
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_DAY_EXT
     * ================================================================
     * -->
    <insert id="DlwDeductionMap.insertGongjeDayExt" parameterType="map">

    BEGIN

        /*
            DlwDeductionMap.insertGongjeDayExt
        */

        INSERT INTO LF_DMUSER.TB_GONGJE_DAY_EXT
        /* [001] [공제 전송 기초 대상 데이터] 신규 회원 등록 */
        SELECT
            GDATE,
            ACCNT_NO,
            CL,
            GBIT,
            WORK_DM,
            PAY_NO,
            SUBSTR(('0000000' || ROWNUM),-8) AS RESULT_KEY,
            EXT_INFO,
            EXT_INFO2
        FROM
        (
            SELECT
                TO_CHAR(SYSDATE, 'YYYYMMDD') AS GDATE,
                MBID.ACCNT_NO,
                'D' AS CL,
                '00' AS GBIT,
                MBID.JOIN_DT AS WORK_DM,
                MBID.TRUE_CNT  AS PAY_NO,
                MBID.PAY_MTHD AS EXT_INFO,
                '' AS EXT_INFO2
            FROM LF_DMUSER.TB_MEMBER_BASIC_INFO_DAY MBID
            WHERE 1=1
                AND KSTBIT = '02'
                AND PROD_CD NOT IN ('NA','NB','NC','ND')
                AND STAT IN ('01','11','011')
                AND NOT EXISTS (SELECT ACCNT_NO FROM LF_DMUSER.TB_GONGJE_ASIS_DATA WHERE ACCNT_NO = MBID.ACCNT_NO)

            UNION ALL

            /* [001-1] [공제 전송 기초 대상 데이터] 신규 회원 등록 (장례이행보증제도) */
            SELECT
                TO_CHAR(SYSDATE, 'YYYYMMDD') AS GDATE,
                MBID.ACCNT_NO,
                'D' AS CL,
                '00' AS GBIT,
                MBID.JOIN_DT AS WORK_DM,
                MBID.TRUE_CNT  AS PAY_NO,
                MBID.PAY_MTHD AS EXT_INFO,
                TO_CHAR((SELECT PERF_AMT FROM TB_PERF_MAIN WHERE ACCNT_NO = MBID.ACCNT_NO AND DEL_FG = 'N')) AS EXT_INFO2
            FROM LF_DMUSER.TB_MEMBER_BASIC_INFO_DAY MBID
            WHERE 1=1
                AND KSTBIT = '02'
                AND STAT IN ('23')
                AND NOT EXISTS (SELECT ACCNT_NO FROM LF_DMUSER.TB_GONGJE_ASIS_DATA WHERE ACCNT_NO = MBID.ACCNT_NO)

            UNION ALL

            /* [002] [공제 전송 기초 대상 데이터] 회원 정보 변경 등록
                20190313 양도양수의 경우 회원의 정보가 넘어가기 때문에 별도로 정보변경 하지 않는다 넘길시 에러
            */
            SELECT
                TO_CHAR(SYSDATE, 'YYYYMMDD') AS GDATE,
                TBL.ACCNT_NO,
                'U' AS CL,
                '00' AS GBIT,
                TBL.WORK_DM,
                0 AS PAY_NO,
                '' AS EXT_INFO,
                '' AS EXT_INFO2

            FROM
            (
                SELECT
                    ACCNT_NO,
                    MAX(WORK_DM) AS WORK_DM
                FROM REG_UPD_DEL_INF RUDI
                    WHERE 1=1
                      AND NEW_YN = 'Y'
                      AND CL1 = 'U'
                      AND EXISTS (SELECT ACCNT_NO FROM LF_DMUSER.TB_GONGJE_ASIS_DATA WHERE ACCNT_NO = RUDI.ACCNT_NO AND KSTBIT  = '정상')
                      AND WORK_DM != TO_CHAR(SYSDATE,'YYYYMMDD')
                      AND DAT1 IN('자택우편번호','자택주소','생년월일','성명','휴대폰','주민번호','이메일')
                GROUP BY ACCNT_NO
            ) TBL
            WHERE 1=1
                AND NOT EXISTS (
                    SELECT ACCNT_NO
                    FROM TRANSFER_BRKDN TR
                    WHERE 1=1
                        AND ACCNT_NO = TBL.ACCNT_NO
                        AND TR.NEW_YN = 'Y'
                        AND HANOV_DT != TO_CHAR(SYSDATE,'YYYYMMDD')
                        AND EXISTS (SELECT ACCNT_NO FROM LF_DMUSER.TB_GONGJE_ASIS_DATA WHERE ACCNT_NO = TR.ACCNT_NO AND KSTBIT  = '정상')
                    )

            UNION ALL

            /* [003] [공제 전송 기초 대상 데이터] 해약 회원 등록 */
            SELECT
                TO_CHAR(SYSDATE, 'YYYYMMDD') AS GDATE,
                RS.ACCNT_NO,
                'R' AS CL,
                '00' AS GBIT,
                --NVL(D.PAY_AMT,0) PAY_AMT,
                RESN_PROC_DAY AS WORK_DM,
                0 AS PAY_NO,
                '' AS EXT_INFO,
                '' AS EXT_INFO2
            FROM RESCISSION RS
            WHERE 1=1
            AND EXISTS (SELECT ACCNT_NO FROM LF_DMUSER.TB_GONGJE_ASIS_DATA WHERE ACCNT_NO = RS.ACCNT_NO AND KSTBIT  = '정상')
            AND DEL_FG = 'N'
            AND (RESN_CL = '02' OR (RESN_CL != '02' AND  NVL(RESN_PROC_YN,'N') = 'Y'))

            UNION ALL

            /* [004] [공제 전송 기초 대상 데이터] 양도양수 회원 등록 */
            SELECT
                DISTINCT
                TO_CHAR(SYSDATE, 'YYYYMMDD') AS GDATE,
                TR.ACCNT_NO,
                'T' AS CL,
                '00'  AS GBIT,
                HANOV_DT AS WORK_DM,
                0 AS PAY_NO,
                '' AS EXT_INFO,
                '' AS EXT_INFO2
            FROM TRANSFER_BRKDN TR
            WHERE 1=1
                AND TR.NEW_YN = 'Y'
                AND HANOV_DT != TO_CHAR(SYSDATE,'YYYYMMDD')
                AND EXISTS (SELECT ACCNT_NO FROM LF_DMUSER.TB_GONGJE_ASIS_DATA WHERE ACCNT_NO = TR.ACCNT_NO AND KSTBIT  = '정상')

            UNION ALL

            /* [005] [공제 전송 기초 대상 데이터] 행사 회원 등록 */
            SELECT
                TO_CHAR(SYSDATE, 'YYYYMMDD') AS GDATE,
                EV.ACCNT_NO,
                'E' AS CL,
                '00' AS GBIT,
                EV.EVENT_PROC_DAY AS WORK_DM,
                0 AS PAY_NO,
                '' AS EXT_INFO,
                '' AS EXT_INFO2
            FROM EVENT EV
            WHERE 1=1
            AND EV.DEL_FG = 'N'
            AND EXISTS (SELECT ACCNT_NO FROM LF_DMUSER.TB_GONGJE_ASIS_DATA WHERE ACCNT_NO = EV.ACCNT_NO AND KSTBIT  = '정상')

            UNION ALL

            /* [006] [공제 전송 기초 대상 데이터] 입금정보등록 */

            SELECT
                TO_CHAR(SYSDATE,'YYYYMMDD') AS GDATE,
                MBID.ACCNT_NO,
                'P' AS CL,
                '00' AS GBIT,
                MBID.TRUE_DAY AS WORK_DM,
                (NVL(GONGJE_CNT,0) + LVL.ROW_CNT) AS PAY_NO,
                MBID.TRUE_MTHD AS EXT_INFO,
                '' AS EXT_INFO2
            FROM TB_MEMBER_BASIC_INFO_DAY MBID INNER JOIN
                TB_GONGJE_ASIS_DATA GAD ON MBID.ACCNT_NO = GAD.ACCNT_NO AND GAD.KSTBIT = '정상' INNER JOIN
                (
                    SELECT LEVEL ROW_CNT
                    FROM DUAL
                    CONNECT BY LEVEL <![CDATA[<=]]> 1000
                ) LVL ON LVL.ROW_CNT BETWEEN 1 AND (NVL(MBID.TRUE_CNT,0) - NVL(GAD.GONGJE_CNT,0))
            WHERE 1=1
            AND MBID.KSTBIT = '02'
            AND NVL(MBID.TRUE_CNT,0) > NVL(GAD.GONGJE_CNT,0)

            UNION ALL

            /* [007] [공제 전송 기초 대상 데이터] 입금취소정보등록 */
            SELECT
                TO_CHAR(SYSDATE,'YYYYMMDD') AS GDATE,
                ACCNT_NO,
                'P_C' AS CL,
                '00' AS GBIT,
                WORK_DM,
                NVL(PAY_NO,0)  AS PAY_NO,
                TO_CHAR(ROW_CNT) AS EXT_INFO,
                TO_CHAR(AMT) AS EXT_INFO2
            FROM
            (
                SELECT
                    MBID.ACCNT_NO,
                    TO_CHAR(SYSDATE,'YYYYMMDD') AS WORK_DM,
                    ((NVL(GONGJE_CNT,0) + 1) - LVL.ROW_CNT) AS PAY_NO,
                    ROW_CNT,
                    PND.AMT
                FROM TB_MEMBER_BASIC_INFO_DAY MBID INNER JOIN
                    TB_GONGJE_ASIS_DATA GAD ON MBID.ACCNT_NO = GAD.ACCNT_NO AND GAD.KSTBIT = '정상' INNER JOIN
                    (
                        SELECT LEVEL ROW_CNT
                        FROM DUAL
                        CONNECT BY LEVEL <![CDATA[<=]]> 1000
                    ) LVL ON LVL.ROW_CNT BETWEEN 1 AND (NVL(GAD.GONGJE_CNT,0) - NVL(MBID.TRUE_CNT,0)) INNER JOIN
                    PRODUCT_NO_DATA PND ON MBID.PROD_CD = PND.PROD_CD AND PND.NO = ((NVL(GONGJE_CNT,0) + 1) - LVL.ROW_CNT)
                WHERE 1=1
                AND MBID.KSTBIT = '02'
                AND NVL(MBID.TRUE_CNT,0) <![CDATA[<]]> NVL(GAD.GONGJE_CNT,0)
            )


            UNION ALL

            /* [008] [공제 전송 기초 대상 데이터] 해약 취소 회원 */
            SELECT
                TO_CHAR(SYSDATE, 'YYYYMMDD') AS GDATE,
                RS.ACCNT_NO,
                'R_C' AS CL,
                '00' AS GBIT,
                --NVL(D.PAY_AMT,0) PAY_AMT,
                TO_CHAR(RS.UPD_DM ,'YYYYMMDD') AS WORK_DM,
                0 AS PAY_NO,
                '' AS EXT_INFO,
                '' AS EXT_INFO2
            FROM RESCISSION RS INNER JOIN
                MEM_PROD_ACCNT MPA ON RS.ACCNT_NO = MPA.ACCNT_NO AND MPA.DEL_FG = 'N'
            WHERE 1=1
            AND EXISTS (SELECT ACCNT_NO FROM LF_DMUSER.TB_GONGJE_ASIS_DATA WHERE ACCNT_NO = RS.ACCNT_NO AND KSTBIT  IN ('청약철회','청약해지'))
            AND NOT EXISTS (SELECT ACCNT_NO FROM LF_DMUSER.RESCISSION WHERE ACCNT_NO = RS.ACCNT_NO AND DEL_FG = 'N')
            AND (RESN_CL = '02' OR (RESN_CL != '02' AND  NVL(RESN_PROC_YN,'N') = 'Y'))

            UNION ALL

            /* [009] [공제 전송 기초 대상 데이터] 행사 취소 회원 */
            SELECT
                TO_CHAR(SYSDATE, 'YYYYMMDD') AS GDATE,
                ACCNT_NO,
                'E_C' AS CL,
                '00' AS GBIT,
                --NVL(D.PAY_AMT,0) PAY_AMT,
                TO_CHAR(WORK_DM ,'YYYYMMDD') AS WORK_DM,
                0 AS PAY_NO,
                '' AS EXT_INFO,
                '' AS EXT_INFO2
            FROM
            (
                SELECT
                    EV.ACCNT_NO,
                    MAX(EV.CANCL_REG_DM) AS WORK_DM
                FROM EVENT EV INNER JOIN
                MEM_PROD_ACCNT MPA ON EV.ACCNT_NO = MPA.ACCNT_NO AND MPA.DEL_FG = 'N'
                WHERE 1=1
                AND EXISTS (SELECT ACCNT_NO FROM LF_DMUSER.TB_GONGJE_ASIS_DATA WHERE ACCNT_NO = EV.ACCNT_NO AND KSTBIT = '행사')
                AND NOT EXISTS (SELECT ACCNT_NO FROM LF_DMUSER.EVENT WHERE ACCNT_NO = EV.ACCNT_NO AND DEL_FG = 'N')
                GROUP BY EV.ACCNT_NO
            )

           UNION ALL

            /*[010] [공제 전송 기초 대상 데이터] 레디캐시 사용 대상자*/
            SELECT
                DISTINCT
                TO_CHAR(SYSDATE,'YYYYMMDD') AS GDATE,
                TMD.GOODS_ID,
                'C' AS CL,
                '00' AS GBIT,
                TO_CHAR(TMD.CREATE_DATE,'YYYYMMDD') AS WORK_DM,
                0 AS PAY_NO,
                '' AS EXT_INFO,
                TO_CHAR((NVL(TMD.USE_AMT,0) - NVL(GAD.READY_CASH,0))) AS EXT_INFO2
            FROM TB_MEMBER_DLWMALL TMD LEFT OUTER JOIN
                TB_GONGJE_ASIS_DATA GAD ON TMD.GOODS_ID = GAD.ACCNT_NO
            WHERE NVL(GAD.READY_CASH,0) <![CDATA[<]]> NVL(TMD.USE_AMT,0)
                AND EXISTS (SELECT ACCNT_NO FROM TB_MEMBER_BASIC_INFO_DAY WHERE ACCNT_NO = TMD.GOODS_ID AND KSTBIT = '02')
            UNION ALL

            /*[011] [공제 전송 기초 대상 데이터] 레디캐시 사용 대상자*/
            SELECT
                DISTINCT
                TO_CHAR(SYSDATE,'YYYYMMDD') AS GDATE,
                TMD.GOODS_ID,
                'C_C' AS CL,
                '00' AS GBIT,
                TO_CHAR(TMD.CREATE_DATE,'YYYYMMDD') AS WORK_DM,
                0 AS PAY_NO,
                '' AS EXT_INFO,
                TO_CHAR((NVL(GAD.READY_CASH,0) - NVL(TMD.USE_AMT,0))) AS EXT_INFO2
            FROM TB_MEMBER_DLWMALL TMD LEFT OUTER JOIN
                TB_GONGJE_ASIS_DATA GAD ON TMD.GOODS_ID = GAD.ACCNT_NO
            WHERE NVL(GAD.READY_CASH,0) > NVL(TMD.USE_AMT,0)
                AND EXISTS (SELECT ACCNT_NO FROM TB_MEMBER_BASIC_INFO_DAY WHERE ACCNT_NO = TMD.GOODS_ID AND KSTBIT = '02')
        )
        ;


        COMMIT;

    END;

    </insert>



    <!-- ================================================================
     * 날짜 : 20190130
     * 이름 : 정승철
     * 추가내용 : 공제 (신규/타사) 엑셀생성 데이터
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_DAY_EXT
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getGongjeDList" parameterType="map" resultType="resultMap">

        /* 신규 회원 데이터 조회 */
        SELECT /* DlwDeductionMap.getGongjeDList */
            '01' GUBUN,
            EXT.ACCNT_NO,
            MB.MEM_NM,
            CASE WHEN LENGTH(NVL(MB.IDN_NO,' ')) != 10 AND SUBSTR(MB.BRTH_MON_DAY,1,2) = '19' AND MB.SEX = '0001' THEN SUBSTR(MB.BRTH_MON_DAY,3,6) || '1000000'
                WHEN LENGTH(NVL(MB.IDN_NO,' ')) != 10 AND SUBSTR(MB.BRTH_MON_DAY,1,2) = '19' AND MB.SEX = '0002' THEN SUBSTR(MB.BRTH_MON_DAY,3,6) || '2000000'
                WHEN LENGTH(NVL(MB.IDN_NO,' ')) != 10 AND SUBSTR(MB.BRTH_MON_DAY,1,2) = '20' AND MB.SEX = '0001' THEN SUBSTR(MB.BRTH_MON_DAY,3,6) || '3000000'
                WHEN LENGTH(NVL(MB.IDN_NO,' ')) != 10 AND SUBSTR(MB.BRTH_MON_DAY,1,2) = '20' AND MB.SEX = '0002' THEN SUBSTR(MB.BRTH_MON_DAY,3,6) || '4000000'
                WHEN LENGTH(NVL(MB.IDN_NO,' ')) = 10 THEN MB.IDN_NO
            ELSE '' END BRTH_MON_DAY ,
            MBID.JOIN_DT,
            PD.PROD_NM,
            PD.PROD_AMT,
            PD.EXPR_NO,
            TO_CHAR(ADD_MONTHS(ADD_MONTHS(MBID.JOIN_DT, PD.EXPR_NO - MBID.NEW_CHAN_GUNSU), -1), 'YYYYMMDD') AS MDATE,
            NVL(REQ.PAY_MTHD,'01') AS CDAY,
            (CASE WHEN MBID.STAT = '23' THEN EXT.EXT_INFO2 ELSE TO_CHAR(PD.MON_PAY_AMT) END) AS MON_PAY_AMT,
            TO_CHAR(SYSDATE,'YYYYMM') AS YYYYMM,
            JOIN_DT AS PAY_DT,
            EXT.PAY_NO AS PAY_NUM,                                            /* 납입회차(기본 1회차) */
             (CASE WHEN MBID.STAT = '23' THEN EXT.EXT_INFO2 ELSE TO_CHAR(NVL((SELECT SUM(AMT) FROM PRODUCT_NO_DATA WHERE PROD_CD = MBID.PROD_CD AND NO <![CDATA[<=]]>  PAY_NO),0)) END) AS PAY_AMT,
            CASE WHEN NVL(MB.HOME_ZIP,'N') != 'N' THEN MB.HOME_ZIP ELSE MB.WRPL_ZIP END POST,        /* 우편번호 */
            CASE WHEN NVL(MB.HOME_ADDR,'N') != 'N' THEN MB.HOME_ADDR ELSE MB.WRPL_ADDR END ADDR1,    /* 주소1 */
            CASE WHEN NVL(MB.HOME_ADDR2,'N') != 'N' THEN MB.HOME_ADDR2 ELSE MB.WRPL_ADDR2 END ADDR2, /* 주소2 */
            CASE WHEN NVL(MB.CELL,'N') != 'N' THEN MB.CELL ELSE '010-0000-0000' END TEL,         /* 연락처 */
            MB.EMAIL,
            EXT.RESULT_KEY
        FROM TB_GONGJE_DAY_EXT EXT INNER JOIN
            LF_DMUSER.TB_MEMBER_BASIC_INFO_DAY MBID ON EXT.ACCNT_NO = MBID.ACCNT_NO INNER JOIN
            MEMBER MB ON MBID.MEM_NO = MB.MEM_NO AND MB.DEL_FG = 'N' INNER JOIN
            PRODUCT PD ON MBID.PROD_CD = PD.PROD_CD LEFT OUTER JOIN
            TB_MEMBER_WDRW_REQ REQ ON MBID.ACCNT_NO = REQ.ACCNT_NO AND REQ.DEL_FG = 'C' AND REQ.REQ_PAY_NO = 1
        WHERE 1=1
        AND EXT.CL = 'D'
        AND GBIT = '00'

    </select>

    <!-- ================================================================
     * 날짜 : 20190130
     * 이름 : 정승철
     * 추가내용 : 공제 (해약) 엑셀생성 데이터
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_DAY_EXT
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getGongjeRList" parameterType="map" resultType="resultMap">

        /* 해약 회원 데이터 조회 */
        SELECT /* DlwDeductionMap.getGongjeRList */
            '51' GUBUN,
            EXT.ACCNT_NO,
            (SELECT DED_NO FROM MEM_PROD_ACCNT WHERE ACCNT_NO = EXT.ACCNT_NO AND DEL_FG = 'N') AS DED_NO,
            MB.MEM_NM,
            EXT.SI_DATE  AS PROC_DAY,
            (SELECT SUM(AMT) FROM PRODUCT_NO_DATA WHERE PROD_CD = MBID.PROD_CD AND NO <![CDATA[<=]]> TRUE_CNT) AS TRUE_AMT,
            (CASE WHEN RS.RESN_CL = '02' THEN 'R' ELSE 'E' END) AS RESN_CL,
            EXT.RESULT_KEY
        FROM TB_GONGJE_DAY_EXT EXT INNER JOIN
            LF_DMUSER.TB_MEMBER_BASIC_INFO_DAY MBID ON EXT.ACCNT_NO = MBID.ACCNT_NO INNER JOIN
            MEMBER MB ON MBID.MEM_NO = MB.MEM_NO AND MB.DEL_FG = 'N' LEFT OUTER JOIN
            RESCISSION RS ON RS.ACCNT_NO = EXT.ACCNT_NO AND RS.DEL_FG = 'N'
        WHERE 1=1
        AND EXT.CL = 'R'
        AND GBIT = '00'

        UNION ALL

        /* 해약 취소된 회원 데이터 조회 */
        SELECT
            '51' GUBUN,
            EXT.ACCNT_NO,
            (SELECT DED_NO FROM MEM_PROD_ACCNT WHERE ACCNT_NO = EXT.ACCNT_NO AND DEL_FG = 'N') AS DED_NO,
            MB.MEM_NM,
            EXT.SI_DATE  AS PROC_DAY,
            (SELECT SUM(AMT) FROM PRODUCT_NO_DATA WHERE PROD_CD = MBID.PROD_CD AND NO <![CDATA[<=]]> TRUE_CNT) AS TRUE_AMT,
            'C' AS RESN_CL,
            EXT.RESULT_KEY
        FROM TB_GONGJE_DAY_EXT EXT INNER JOIN
            LF_DMUSER.TB_MEMBER_BASIC_INFO_DAY MBID ON EXT.ACCNT_NO = MBID.ACCNT_NO INNER JOIN
            MEMBER MB ON MBID.MEM_NO = MB.MEM_NO AND MB.DEL_FG = 'N' LEFT OUTER JOIN
            RESCISSION RS ON RS.ACCNT_NO = EXT.ACCNT_NO AND RS.DEL_FG = 'N'
        WHERE 1=1
        AND EXT.CL = 'R_C'
        AND GBIT = '00'

    </select>

    <!-- ================================================================
     * 날짜 : 20190130
     * 이름 : 정승철
     * 추가내용 : 공제 (정보변경) 엑셀생성 데이터
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_DAY_EXT
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getGongjeUList" parameterType="map" resultType="resultMap">

        /* 회원정보 변경 회원 데이터 조회 */
        SELECT /* DlwDeductionMap.getGongjeUList */
            '31' GUBUN,
            EXT.ACCNT_NO,
            (SELECT DED_NO FROM MEM_PROD_ACCNT WHERE ACCNT_NO = EXT.ACCNT_NO AND DEL_FG = 'N') AS DED_NO,
            MB.MEM_NM,
            CASE WHEN LENGTH(NVL(MB.IDN_NO,' ')) != 10 AND SUBSTR(MB.BRTH_MON_DAY,1,2) = '19' AND MB.SEX = '0001' THEN SUBSTR(MB.BRTH_MON_DAY,3,6) || '1000000'
                WHEN LENGTH(NVL(MB.IDN_NO,' ')) != 10 AND SUBSTR(MB.BRTH_MON_DAY,1,2) = '19' AND MB.SEX = '0002' THEN SUBSTR(MB.BRTH_MON_DAY,3,6) || '2000000'
                WHEN LENGTH(NVL(MB.IDN_NO,' ')) != 10 AND SUBSTR(MB.BRTH_MON_DAY,1,2) = '20' AND MB.SEX = '0001' THEN SUBSTR(MB.BRTH_MON_DAY,3,6) || '3000000'
                WHEN LENGTH(NVL(MB.IDN_NO,' ')) != 10 AND SUBSTR(MB.BRTH_MON_DAY,1,2) = '20' AND MB.SEX = '0002' THEN SUBSTR(MB.BRTH_MON_DAY,3,6) || '4000000'
                WHEN LENGTH(NVL(MB.IDN_NO,' ')) = 10 THEN MB.IDN_NO
            ELSE '' END BRTH_MON_DAY ,
            EXT.SI_DATE AS CHG_DT,
            CASE WHEN NVL(MB.HOME_ZIP,'N') != 'N' THEN MB.HOME_ZIP ELSE MB.WRPL_ZIP END POST,        /* 우편번호 */
            CASE WHEN NVL(MB.HOME_ADDR,'N') != 'N' THEN MB.HOME_ADDR ELSE MB.WRPL_ADDR END ADDR1,    /* 주소1 */
            CASE WHEN NVL(MB.HOME_ADDR2,'N') != 'N' THEN MB.HOME_ADDR2 ELSE MB.WRPL_ADDR2 END ADDR2, /* 주소2 */
            CASE WHEN NVL(MB.CELL,'N') != 'N' THEN MB.CELL ELSE '010-0000-0000' END TEL,         /* 연락처 */
            MB.EMAIL,
            EXT.RESULT_KEY
        FROM (
                SELECT DISTINCT ACCNT_NO, SI_DATE, RESULT_KEY FROM TB_GONGJE_DAY_EXT A
                WHERE A.CL = 'U'
                AND GBIT = '00'
              ) EXT INNER JOIN
            TB_MEMBER_BASIC_INFO_DAY MBID ON EXT.ACCNT_NO = MBID.ACCNT_NO INNER JOIN
            MEMBER MB ON MBID.MEM_NO = MB.MEM_NO AND MB.DEL_FG = 'N'
        WHERE 1=1

    </select>

    <!-- ================================================================
     * 날짜 : 20190130
     * 이름 : 정승철
     * 추가내용 : 공제 (양도양수) 엑셀생성 데이터
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_DAY_EXT
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getGongjeTList" parameterType="map" resultType="resultMap">

        /* 양도양수 회원 데이터 조회 */
        SELECT /* DlwDeductionMap.getGongjeTList */
            DISTINCT
            '41' GUBUN,
            EXT.ACCNT_NO,
            (SELECT DED_NO FROM MEM_PROD_ACCNT WHERE ACCNT_NO = EXT.ACCNT_NO AND DEL_FG = 'N') AS DED_NO,
            MBA.MEM_NM,
            EXT.SI_DATE AS TRNS_DT,
            'N' AS CHG_YN, /* 소비자번호 변경여부(변경:Y / 미변경:N) */
            EXT.ACCNT_NO AS YS_ACCNT_NO,    /* 양수소비자번호 */
            MBB.MEM_NM AS YS_MEM_NM,	  /* 양수소비자성명 */

            CASE WHEN LENGTH(NVL(MBB.IDN_NO,' ')) != 10 AND SUBSTR(MBB.BRTH_MON_DAY,1,2) = '19' AND MBB.SEX = '0001' THEN SUBSTR(MBB.BRTH_MON_DAY,3,6) || '1000000'
                WHEN LENGTH(NVL(MBB.IDN_NO,' ')) != 10 AND SUBSTR(MBB.BRTH_MON_DAY,1,2) = '19' AND MBB.SEX = '0002' THEN SUBSTR(MBB.BRTH_MON_DAY,3,6) || '2000000'
                WHEN LENGTH(NVL(MBB.IDN_NO,' ')) != 10 AND SUBSTR(MBB.BRTH_MON_DAY,1,2) = '20' AND MBB.SEX = '0001' THEN SUBSTR(MBB.BRTH_MON_DAY,3,6) || '3000000'
                WHEN LENGTH(NVL(MBB.IDN_NO,' ')) != 10 AND SUBSTR(MBB.BRTH_MON_DAY,1,2) = '20' AND MBB.SEX = '0002' THEN SUBSTR(MBB.BRTH_MON_DAY,3,6) || '4000000'
                WHEN LENGTH(NVL(MBB.IDN_NO,' ')) = 10 THEN MBB.IDN_NO
            ELSE '' END BRTH_MON_DAY ,

            PD.PROD_NM,
            'N' AS YN,     /* 상품변경여부(변경:Y / 미변경:N) */
            '' AS AMT,	  /* 총계약금액(변경시 필수) */
            '' AS NUM,     /* 총계약회차(변경시 필수) */
            '' AS EXP_DT,  /* 계약만기일자(변경시 필수) */
            '' AS PAY_DD,  /* 월납입예정일(변경시 필수) */
            '' AS PAY_AMT, /* 월납입계약금액 */
            TRUE_CNT AS TOT_NUM,
            (SELECT SUM(AMT) FROM PRODUCT_NO_DATA WHERE PROD_CD = MBID.PROD_CD AND NO <![CDATA[<=]]> TRUE_CNT) AS TOT_AMT,
            SUBSTR(SI_DATE,1,6) AS YYMM,    /* 정산년월(납부시) */
            SI_DATE AS PAY_DT,              /* 납입일자(납부시) */
            TRUE_CNT AS PAY_NUM,
            (SELECT SUM(AMT) FROM PRODUCT_NO_DATA WHERE PROD_CD = MBID.PROD_CD AND NO <![CDATA[<=]]> TRUE_CNT) AS PAY_AMT2,
            CASE WHEN NVL(MBB.HOME_ZIP,'N') != 'N' THEN MBB.HOME_ZIP ELSE MBB.WRPL_ZIP END POST,        /* 우편번호 */
            CASE WHEN NVL(MBB.HOME_ADDR,'N') != 'N' THEN MBB.HOME_ADDR ELSE MBB.WRPL_ADDR END ADDR1,    /* 주소1 */
            CASE WHEN NVL(MBB.HOME_ADDR2,'N') != 'N' THEN MBB.HOME_ADDR2 ELSE MBB.WRPL_ADDR2 END ADDR2, /* 주소2 */
            CASE WHEN NVL(MBB.CELL,'N') != 'N' THEN MBB.CELL ELSE '010-0000-0000' END TEL,         /* 연락처 */
            MBB.EMAIL,
            EXT.RESULT_KEY
        FROM TB_GONGJE_DAY_EXT EXT INNER JOIN
            TRANSFER_BRKDN TR ON EXT.ACCNT_NO = TR.ACCNT_NO AND EXT.SI_DATE = HANOV_DT AND EXT.CL = 'T' LEFT OUTER JOIN
            MEMBER MBA ON TR.TRSFO_MEM_NO = MBA.MEM_NO  LEFT OUTER JOIN
            MEMBER MBB ON TR.TRSFE_MEM_NO  = MBB.MEM_NO  LEFT OUTER JOIN
            TB_MEMBER_BASIC_INFO_DAY MBID ON EXT.ACCNT_NO = MBID.ACCNT_NO INNER JOIN
            PRODUCT PD ON MBID.PROD_CD = PD.PROD_CD
        WHERE 1=1
        AND EXT.CL = 'T'
        AND GBIT = '00'

    </select>

    <!-- ================================================================
     * 날짜 : 20190130
     * 이름 : 정승철
     * 추가내용 : 공제 (행사) 엑셀생성 데이터
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_DAY_EXT
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getGongjeEList" parameterType="map" resultType="resultMap">

        /* 행사 회원 데이터 조회 */
        SELECT /* DlwDeductionMap.getGongjeEList */
            '52' GUBUN,
            EXT.ACCNT_NO,
            (SELECT DED_NO FROM MEM_PROD_ACCNT WHERE ACCNT_NO = EXT.ACCNT_NO AND DEL_FG = 'N') AS DED_NO,
            MB.MEM_NM,
            EXT.SI_DATE AS EVENT_PROC_DAY,
            (SELECT SUM(AMT) FROM PRODUCT_NO_DATA WHERE PROD_CD = MBID.PROD_CD AND NO <![CDATA[<=]]> TRUE_CNT) AS PAY_AMT,
            'E' TYPE,
            EXT.RESULT_KEY
        FROM TB_GONGJE_DAY_EXT EXT INNER JOIN
            TB_MEMBER_BASIC_INFO_DAY MBID ON EXT.ACCNT_NO = MBID.ACCNT_NO INNER JOIN
            MEMBER MB ON MBID.MEM_NO = MB.MEM_NO AND MB.DEL_FG = 'N'
        WHERE 1=1
        AND EXT.CL = 'E'
        AND GBIT = '00'

        UNION ALL

        /* 행사 취소된 회원 데이터 조회 */
        SELECT
            '52' GUBUN,
            EXT.ACCNT_NO,
            (SELECT DED_NO FROM MEM_PROD_ACCNT WHERE ACCNT_NO = EXT.ACCNT_NO AND DEL_FG = 'N') AS DED_NO,
            MB.MEM_NM,
            EXT.SI_DATE AS EVENT_PROC_DAY,
            (SELECT SUM(AMT) FROM PRODUCT_NO_DATA WHERE PROD_CD = MBID.PROD_CD AND NO <![CDATA[<=]]> TRUE_CNT) AS PAY_AMT,
            'C' TYPE,
            EXT.RESULT_KEY
        FROM TB_GONGJE_DAY_EXT EXT INNER JOIN
            TB_MEMBER_BASIC_INFO_DAY MBID ON EXT.ACCNT_NO = MBID.ACCNT_NO INNER JOIN
            MEMBER MB ON MBID.MEM_NO = MB.MEM_NO AND MB.DEL_FG = 'N'
        WHERE 1=1
        AND EXT.CL = 'E_C'
        AND GBIT = '00'

    </select>

    <!-- ================================================================
     * 날짜 : 20190130
     * 이름 : 정승철
     * 추가내용 : 공제 (선수금) 엑셀생성 데이터
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_DAY_EXT
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getPayAccnt" parameterType="map" resultType="resultMap">
        <!--
        SELECT * FROM TB_GONGJE_DAY_EXT
        WHERE CL = 'P'
        AND ACCNT_NO = '2015N2001254'
         -->
        <!--  메모리 문제로 인하여 preparent사용됨 20190308
        /* 매일 입금된 회원 데이터 조회 */
        SELECT /* DlwDeductionMap.getPayAccnt */
            '21' GUBUN,
            EXT.ACCNT_NO,
            (SELECT DED_NO FROM MEM_PROD_ACCNT WHERE ACCNT_NO = EXT.ACCNT_NO AND DEL_FG = 'N') AS DED_NO,
            SUBSTR(NVL(SI_DATE,TO_CHAR(SYSDATE,'YYYYMMDD')),0,6) AS YYMM,
            NVL(SI_DATE,TO_CHAR(SYSDATE,'YYYYMMDD'))  AS PAY_DT,
            EXT.PAY_NO AS NO,
            PND.AMT AS PAY_AMT,
            '10' AS PAY_TYPE,
            CASE WHEN EXT.EXT_INFO = '01' THEN '수금'
                WHEN EXT.EXT_INFO = '04' THEN '자동이체'
                WHEN EXT.EXT_INFO = '06' THEN '카드'
            ELSE '기타' END TYPE,
            EXT.RESULT_KEY
        FROM TB_GONGJE_DAY_EXT EXT INNER JOIN
            TB_MEMBER_BASIC_INFO_DAY MBID ON EXT.ACCNT_NO = MBID.ACCNT_NO LEFT OUTER JOIN
            PRODUCT_NO_DATA PND ON MBID.PROD_CD = PND.PROD_CD AND NO = EXT.PAY_NO
        WHERE 1=1
        AND EXT.CL = 'P'
        AND GBIT = '00'

        UNION ALL

        /* 매일 취소된 회원 데이터 조회 */
        SELECT
            '21' GUBUN,
            EXT.ACCNT_NO,
            (SELECT DED_NO FROM MEM_PROD_ACCNT WHERE ACCNT_NO = EXT.ACCNT_NO AND DEL_FG = 'N') AS DED_NO,
            SUBSTR(NVL(SI_DATE,TO_CHAR(SYSDATE,'YYYYMMDD')),0,6) AS YYMM,
            NVL(SI_DATE,TO_CHAR(SYSDATE,'YYYYMMDD'))  AS PAY_DT,
            EXT.PAY_NO AS NO,
            EXT.EXT_INFO2  AS PAY_AMT,
            '21' AS PAY_TYPE,
            '기타' TYPE,
            EXT.RESULT_KEY
        FROM TB_GONGJE_DAY_EXT EXT INNER JOIN
            TB_MEMBER_BASIC_INFO_DAY MBID ON EXT.ACCNT_NO = MBID.ACCNT_NO
        WHERE 1=1
        AND EXT.CL = 'P_C'
        AND GBIT = '00'
         -->
    </select>

    <!-- ================================================================
     * 날짜 : 20190130
     * 이름 : 정승철
     * 추가내용 : 공제 산출스케줄 카운트조회
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_EXT_SCHED
     * ================================================================
     * -->
    <select id="DlwDeductionMap.chkGongjeSched" parameterType="map" resultType="int">

        SELECT /* DlwDeductionMap.chkGongjeSched */
            COUNT(*)
        FROM TB_GONGJE_EXT_SCHED
        WHERE 1=1
        AND EXT_DT = #{ext_dt}
        AND EXT_CHK = 'Y'

    </select>

    <!-- ================================================================
     * 날짜 : 20190130
     * 이름 : 정승철
     * 추가내용 : 공제 산출스케줄 조회
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_EXT_SCHED
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getGongjeExtDt" parameterType="map" resultType="resultMap">

        SELECT /* DlwDeductionMap.getGongjeExtDt */
               EXT_DT,
               EXT_CHK,
               DECODE(RS_PROC_YN, 'Y', '처리', 'N', '미처리', '') AS RS_PROC_YN,
               TO_CHAR(REG_DM, 'YYYYMMDD') AS REG_DM,
               REG_MAN,
               TO_CHAR(UPD_DM, 'YYYYMMDD') AS UPD_DM,
               UPD_MAN
          FROM TB_GONGJE_EXT_SCHED
         WHERE 1=1
           <if test="ext_month != null and ext_month != ''">
           AND SUBSTR(EXT_DT, 1, 6) = #{ext_month}
           </if>
           <if test="ext_chk != null and ext_chk != ''">
           AND EXT_CHK = #{ext_chk}
           </if>
         ORDER BY EXT_DT DESC

    </select>

    <!-- ================================================================
     * 날짜 : 20190207
     * 이름 : 정승철
     * 추가내용 : 공제 전송여부 카운트조회
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_DAY_EXT
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getGongjeSendCnt" parameterType="map" resultType="int">

        SELECT /* DlwDeductionMap.getGongjeSendCnt */
               COUNT(*)
          FROM TB_GONGJE_DAY_EXT
         WHERE GDATE = #{srchDt}


        <!--
        SELECT /* DlwDeductionMap.getGongjeProcessYN */
               MIN(GDATE)
          FROM TB_GONGJE_DAY_EXT
         WHERE GBIT = '01'
           AND GDATE <![CDATA[<]]> #{srchDt}
        -->

        <!--
        SELECT /* DlwDeductionMap.getGongjeProcessYN */
               COUNT(*)
          FROM TB_GONGJE_DAY_EXT
         WHERE GDATE = #{srchDt}
           AND GBIT = '01'
        -->

    </select>

    <!-- ================================================================
     * 날짜 : 20190208
     * 이름 : 정승철
     * 추가내용 : 공제산출스케줄 입력유효성체크
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_EXT_SCHED
     * ================================================================
     * -->
    <select id="DlwDeductionMap.chkGongjeExtSched" parameterType="map" resultType="int">
        SELECT /* DlwDeductionMap.chkGongjeExtSched */
               COUNT(*)
          FROM TB_GONGJE_EXT_SCHED
         WHERE 1=1
           AND EXT_DT = #{ext_dt}
    </select>

    <!-- ================================================================
     * 날짜 : 20190408
     * 이름 : 정승철
     * 추가내용 : 공제산출스케줄 입력유효성체크 (** 공제결과 미처리 조회)
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_EXT_SCHED
     * ================================================================
     * -->
    <select id="DlwDeductionMap.chkGongjeExtSched_rsProcYn" resultType="int">
        SELECT /* DlwDeductionMap.chkGongjeExtSched_rsProcYn */
               COUNT(*)
          FROM TB_GONGJE_EXT_SCHED
         WHERE 1=1
           AND RS_PROC_YN = 'N'
    </select>

    <!-- ================================================================
     * 날짜 : 20190208
     * 이름 : 정승철
     * 추가내용 : 공제산출스케줄 저장
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_EXT_SCHED
     * ================================================================
     * -->
    <insert id="DlwDeductionMap.saveGongjeExtSched" parameterType="map">
        INSERT /* DlwDeductionMap.saveGongjeExtSched */
          INTO LF_DMUSER.TB_GONGJE_EXT_SCHED
             ( EXT_DT, EXT_CHK, RS_PROC_YN
             , REG_MAN, REG_DM )
        VALUES
             ( #{ext_dt}, #{ext_chk}, 'N'
             , #{reg_man}, SYSDATE)
    </insert>

    <!-- ================================================================
     * 날짜 : 20190208
     * 이름 : 정승철
     * 추가내용 : 공제산출스케줄 삭제
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_EXT_SCHED
     * ================================================================
     * -->
    <delete id="DlwDeductionMap.delGongjeExtSched" parameterType="map">
        DELETE /* DlwDeductionMap.delGongjeExtSched */
          FROM TB_GONGJE_EXT_SCHED
         WHERE 1=1
           AND EXT_DT = #{ext_dt}
    </delete>

    <!-- ================================================================
     * 날짜 : 20190208
     * 이름 : 정승철
     * 추가내용 : 진행중인 공제데이터 조회
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_DAY_EXT
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getGongjeSendingList" parameterType="map" resultType="resultMap">

        SELECT /* DlwDeductionMap.getGongjeSendingList */
               GDATE,
               GBIT,
               CL,
               COUNT(*) AS CNT
          FROM ( SELECT GDATE,
                        GBIT,
                        --FN_COM_NM('0157', CL) AS CL,
                        DECODE(CL, 'D', '일반/일반취소', 'R', '일반/일반취소', 'U', '일반/일반취소', 'T', '일반/일반취소', 'E', '일반/일반취소', 'R_C', '일반/일반취소', 'E_C', '일반/일반취소'
                                 , 'P', '선수금/선수금취소', 'P_C', '선수금/선수금취소'
                                 , '') AS CL
                   FROM TB_GONGJE_DAY_EXT
                  WHERE GBIT = '01'
               )
         GROUP BY GDATE, GBIT, CL
         ORDER BY CL DESC

        <!--
        SELECT /* DlwDeductionMap.getGongjeSendingList */
               GDATE,
               GBIT,
               /* CL, */
               /* DECODE(GBIT, 'D', '신규/타사'
                          , 'R', '해약'
                          , 'U', '정보변경'
                          , 'T', '양도양수'
                          , 'E', '행사'
                          , 'P', '선수금'
                          , 'P_C', '선수금취소'
                          , 'R_C', '해약취소'
                          , 'E_C', '행사취소', '') AS CL,
                */
               FN_COM_NM('0157', CL) AS CL,
               COUNT(*) AS CNT
          FROM TB_GONGJE_DAY_EXT
         WHERE GBIT = '01'
         GROUP BY GDATE, GBIT, CL
         ORDER BY MIN(ROWID)
         -->

    </select>

    <!-- ================================================================
     * 날짜 : 20190208
     * 이름 : 정승철
     * 추가내용 : 공제구분별 최종결과반영 조회
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_DAY_EXT
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getGongjeTypeLastResultList" parameterType="map" resultType="resultMap">

        SELECT
            EXT.GDATE,
            SUM(CASE WHEN CL NOT IN ('P','P_C') THEN 1 ELSE 0 END) AS MEM_CNT,
            SUM(CASE WHEN CL IN ('P','P_C') THEN 1 ELSE 0 END) AS PAY_CNT,
            MAX(CASE WHEN CL NOT IN ('P','P_C') AND NVL(RST.CODE,'N') != 'N' THEN 'Y' ELSE 'N' END) AS MEM_RST_YN,
            MAX(CASE WHEN CL IN ('P','P_C') AND NVL(RST.CODE,'N') != 'N' THEN 'Y' ELSE 'N' END) AS PAY_RST_YN,
            SUM(CASE WHEN CL NOT IN ('P','P_C') AND GBIT = '01' THEN 1 ELSE 0 END) AS MEM_RST_O_CNT,
            SUM(CASE WHEN CL IN ('P','P_C') AND GBIT = '01' THEN 1 ELSE 0 END) AS PAY_RST_O_CNT,
            SUM(CASE WHEN CL NOT IN ('P','P_C') AND GBIT = '02' THEN 1 ELSE 0 END) AS MEM_RST_X_CNT,
            SUM(CASE WHEN CL IN ('P','P_C') AND GBIT = '02' THEN 1 ELSE 0 END) AS PAY_RST_X_CNT,
            NVL((SELECT MAX('Y') FROM TB_GONGJE_DAY_EXT WHERE GDATE <![CDATA[<=]]> #{gdate} AND GBIT = '00'),'N') AS EXT_YN
        FROM TB_GONGJE_DAY_EXT EXT LEFT OUTER JOIN
            TB_GONGJE_DAY_EXT_RESULT RST ON EXT.GDATE = RST.GDATE AND EXT.RESULT_KEY = RST.RESULT_KEY
        WHERE EXT.GDATE =  #{gdate}
        GROUP BY EXT.GDATE

    </select>

    <!-- ================================================================
     * 날짜 : 20190208
     * 이름 : 송준빈
     * 추가내용 : 결과반영 여부확인
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_DAY_EXT_RESULT
     * (!)참고 :: GDATE = RC_DT , ACCNT_NO = CONS_NO, PAY_NO = ADV_PAY_NUM,
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getGongjeDayExtResultCount" parameterType="map" resultType="int">
        SELECT /* DlwPayMap.getGongjeDayExtResultCount */
               COUNT(*) AS ICNT
          FROM ( SELECT *
                   FROM LF_DMUSER.TB_GONGJE_DAY_EXT_RESULT
                  WHERE 1=1
                    AND GDATE = #{gdate}
               ) A
         WHERE 1=1
    </select>

    <!-- ================================================================
     * 날짜 : 20190207
     * 이름 : 송준빈
     * 추가내용 : 공제 데이터 결과반영
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_DAY_EXT_RESULT
     * (!)참고 :: GDATE = RC_DT , ACCNT_NO = CONS_NO, PAY_NO = ADV_PAY_NUM,
     * ================================================================
     * -->
    <insert id="DlwDeductionMap.insertGongjeFileUpload" parameterType="map">
        INSERT INTO /* DlwDeductionMap.insertGongjeFileUpload */
                    LF_DMUSER.TB_GONGJE_DAY_EXT_RESULT(GDATE, FILE_TYPE, RESULT_KEY, ACCNT_NO, GUAR_NO, WORK_RESULT, ERR_MSG, GUBUN, CODE,
                                                       MEMB_NO, LIMIT_VALUE, SEQ_NO, PAY_NO, PAY_TYPE, REG_MAN, REG_DM, UPD_MAN, UPD_DM, DEL_FG)
             VALUES (#{RC_DT}, #{FILE_TYPE}, #{RESULT_KEY}, #{CONS_NO}, #{GUAR_NO}, #{WORK_RESULT}, #{ERR_MSG}, #{GUBUN}, #{CODE},
                     #{MEMB_NO}, #{LIMIT_VALUE}, #{SEQ_NO}, #{ADV_PAY_NUM}, #{PAY_TYPE}, #{REG_MAN}, SYSDATE, '', '' , 'N')
    </insert>

   <!-- ================================================================
     * 날짜 : 20190213
     * 이름 : 임동진
     * 추가내용 : 공제 데이터 결과반영
     * ======-->

    <parameterMap id="ResultInfoMap" type="resultMap">
        <!-- <parameter property="file_nm" mode="IN" jdbcType="VARCHAR"  javaType="java.lang.String" /> -->
        <parameter property="g_date" mode="IN" jdbcType="VARCHAR"  javaType="java.lang.String" />
        <parameter property="g_type" mode="IN" jdbcType="VARCHAR"  javaType="java.lang.String" />
        <parameter property="reg_man" mode="IN" jdbcType="VARCHAR"  javaType="java.lang.String" />

    </parameterMap>

    <select id="DlwDeductionMap.uptGongResultStat" statementType="CALLABLE" parameterMap="ResultInfoMap">
               {call SP_GONGJE_CONVERT( ?, ?, ?)}
    </select>

    <!-- ================================================================
     * 날짜 : 20190214
     * 이름 : 송준빈
     * 추가내용 : 공제 데이터 전송이력 조회수
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_DAY_EXT, LF_DMUSER.TB_GONGJE_DAY_EXT_RESULT
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getGongjeDayExtSendHistCount" parameterType="map" resultType="int">
        SELECT /* DlwDeductionMap.getGongjeDayExtSendHistCount */
               COUNT(*) AS ICNT
          FROM ( SELECT ROW_NUMBER() OVER(ORDER BY ${orderBy} ${orderDirection}) AS PAGE_INDX
                       ,GDE.GDATE
                       ,GDE.ACCNT_NO
                       ,GDE.CL
                       ,GDE.GBIT
                       ,GDE.SI_DATE
                       ,GDER.FILE_TYPE
                       ,GDER.GUAR_NO
                       ,GDER.WORK_RESULT
                       ,GDER.ERR_MSG
                       ,GDER.GUBUN
                       ,GDER.CODE
                       ,GDER.MEMB_NO
                       ,GDER.LIMIT_VALUE
                       ,GDER.SEQ_NO
                       ,GDER.PAY_NO
                       ,GDER.PAY_TYPE
                   FROM LF_DMUSER.TB_GONGJE_DAY_EXT GDE
                   LEFT OUTER JOIN LF_DMUSER.TB_GONGJE_DAY_EXT_RESULT GDER
                           ON GDE.GDATE = GDER.GDATE
                          AND GDE.ACCNT_NO = GDER.ACCNT_NO
                          AND GDE.RESULT_KEY = GDER.RESULT_KEY
                  WHERE 1=1
                    AND GDE.GDATE = #{srchDt}
                    <if test="cl != null and cl != ''">
                        AND GDE.CL = #{cl}
                     </if>
                    <if test="gbit != null and gbit != ''">
                        AND GDE.GBIT = #{gbit}
                     </if>
                     <if test="file_type != null and file_type != ''">
                        AND GDER.FILE_TYPE = #{file_type}
                     </if>
                     <if test="work_result != null and work_result != ''">
                        AND GDER.WORK_RESULT = #{work_result}
                     </if>
                     <if test="accnt_no != null and accnt_no != ''">
                        AND GDE.ACCNT_NO = #{accnt_no}
                     </if>
               ) MAIN_TBL
         WHERE 1=1
    </select>

    <!-- ================================================================
     * 날짜 : 20190214
     * 이름 : 송준빈
     * 추가내용 : 공제 데이터 전송이력 리스트
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_DAY_EXT, LF_DMUSER.TB_GONGJE_DAY_EXT_RESULT
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getGongjeDayExtSendHist" parameterType="map" resultType="resultMap">
        SELECT /* DlwDeductionMap.getGongjeDayExtSendHist */
               MAIN_TBL.*
          FROM ( SELECT ROW_NUMBER() OVER(ORDER BY ${orderBy} ${orderDirection}) AS PAGE_INDX
                       ,GDE.GDATE
                       ,GDE.ACCNT_NO
                       ,GDE.CL
                       ,GDE.GBIT
                       ,GDE.SI_DATE
                       ,GDER.FILE_TYPE
                       ,GDER.GUAR_NO
                       ,GDER.WORK_RESULT
                       ,GDER.ERR_MSG
                       ,GDER.GUBUN
                       ,GDER.CODE
                       ,GDER.MEMB_NO
                       ,GDER.LIMIT_VALUE
                       ,GDER.SEQ_NO
                       ,GDER.PAY_NO
                       ,GDER.PAY_TYPE
                   FROM LF_DMUSER.TB_GONGJE_DAY_EXT GDE
                   LEFT OUTER JOIN LF_DMUSER.TB_GONGJE_DAY_EXT_RESULT GDER
                           ON GDE.GDATE = GDER.GDATE
                          AND GDE.ACCNT_NO = GDER.ACCNT_NO
                          AND GDE.RESULT_KEY = GDER.RESULT_KEY
                  WHERE 1=1
                    AND GDE.GDATE = #{srchDt}
                    <if test="cl != null and cl != ''">
                        AND GDE.CL = #{cl}
                     </if>
                    <if test="gbit != null and gbit != ''">
                        AND GDE.GBIT = #{gbit}
                     </if>
                     <if test="file_type != null and file_type != ''">
                        AND GDER.FILE_TYPE = #{file_type}
                     </if>
                     <if test="work_result != null and work_result != ''">
                        AND GDER.WORK_RESULT = #{work_result}
                     </if>
                     <if test="accnt_no != null and accnt_no != ''">
                        AND GDE.ACCNT_NO = #{accnt_no}
                     </if>
               ) MAIN_TBL
         WHERE 1=1
         <if test="startLine != null and startLine != '' and endLine != null and endLine != ''">
             AND PAGE_INDX <![CDATA[>=]]> #{startLine}
             AND PAGE_INDX <![CDATA[<]]> #{endLine}
         </if>
    </select>

    <!-- ================================================================
     * 날짜 : 20190219
     * 이름 : 송준빈
     * 추가내용 : 공제 신고 현황 데이터 (ASIS) 조회수
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_ASIS_DATA
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getGongjeAsisDataCount" parameterType="map" resultType="int">
        SELECT /* DlwDeductionMap.getGongjeAsisDataCount */
               COUNT(*) AS ICNT
          FROM ( SELECT ROW_NUMBER() OVER(ORDER BY ${orderBy} ${orderDirection}) AS PAGE_INDX
                       ,ACCNT_NO
                       ,DED_NO
                       ,KSTBIT
                       ,GONGJE_CNT
                       ,GONGJE_AMT
                   FROM TB_GONGJE_ASIS_DATA
                  WHERE 1=1
                  <if test="accnt_no != null and accnt_no != ''">
                    AND ACCNT_NO = #{accnt_no}
                  </if>
               ) MAIN_TBL
         WHERE 1=1
    </select>

     <!-- ================================================================
     * 날짜 : 20190219
     * 이름 : 송준빈
     * 추가내용 : 공제 신고 현황 데이터 (ASIS) 조회수
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_ASIS_DATA
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getGongjeAsisDataList" parameterType="map" resultType="resultMap">
        SELECT /* DlwDeductionMap.getGongjeAsisDataList */
               MAIN_TBL.*
          FROM ( SELECT ROW_NUMBER() OVER(ORDER BY ${orderBy} ${orderDirection}) AS PAGE_INDX
                       ,ACCNT_NO
                       ,DED_NO
                       ,KSTBIT
                       ,GONGJE_CNT
                       ,GONGJE_AMT
                       ,NVL(READY_CASH, 0) AS READY_CASH
                   FROM TB_GONGJE_ASIS_DATA
                  WHERE 1=1
                  <if test="accnt_no != null and accnt_no != ''">
                      AND ACCNT_NO = #{accnt_no}
                  </if>
               ) MAIN_TBL
         WHERE 1=1
         <if test="startLine != null and startLine != '' and endLine != null and endLine != ''">
             AND PAGE_INDX <![CDATA[>=]]> #{startLine}
             AND PAGE_INDX <![CDATA[<]]> #{endLine}
         </if>
    </select>

    <!-- ================================================================
     * 날짜 : 20190219
     * 이름 : 송준빈
     * 추가내용 : 공제 신고 현황 데이터 (ASIS) 조회수
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_ASIS_DATA
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getGongjeAsisDataListSummary" parameterType="map" resultType="resultMap">
        SELECT /* DlwDeductionMap.getGongjeAsisDataList */
               COUNT(*) AS SUMMARY_SUCCESS_CNT
              ,SUM(GONGJE_AMT)-SUM(READY_CASH) AS SUMMARY_AMT
          FROM ( SELECT ROW_NUMBER() OVER(ORDER BY ${orderBy} ${orderDirection}) AS PAGE_INDX
                       ,ACCNT_NO
                       ,DED_NO
                       ,KSTBIT
                       ,GONGJE_CNT
                       ,GONGJE_AMT
                       ,NVL(READY_CASH, 0) AS READY_CASH
                   FROM TB_GONGJE_ASIS_DATA
                  WHERE 1=1
                    AND KSTBIT = '정상'
                  <if test="accnt_no != null and accnt_no != ''">
                      AND ACCNT_NO = #{accnt_no}
                  </if>
               ) MAIN_TBL
         WHERE 1=1
    </select>

    <!-- ================================================================
     * 날짜 : 20190219
     * 이름 : 송준빈
     * 추가내용 :  공제 데이터 전송이력 (ASIS) 추가
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_ASIS_DATA
     * ================================================================
     * -->
    <insert id="DlwDeductionMap.insertGongjeAsisDataList" parameterType="map">
        INSERT /* DlwDeductionMap.insertGongjeAsisDataList */
          INTO LF_DMUSER.TB_GONGJE_ASIS_DATA(ACCNT_NO, DED_NO, KSTBIT, GONGJE_CNT, GONGJE_AMT, READY_CASH)
        VALUES (#{accnt_no}, #{ded_no}, #{kstbit}, #{gongje_cnt}, #{gongje_amt}, #{ready_cash})
    </insert>

    <!-- ================================================================
     * 날짜 : 20190219
     * 이름 : 송준빈
     * 추가내용 : 공제 데이터 전송이력 (ASIS) 수정
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_ASIS_DATA
     * ================================================================
     * -->
    <update id="DlwDeductionMap.updateGongjeAsisDataList" parameterType="map">
        UPDATE /* DlwDeductionMap.updateGongjeAsisDataList */
               LF_DMUSER.TB_GONGJE_ASIS_DATA
           SET DED_NO = #{ded_no}
              ,KSTBIT = #{kstbit}
              ,GONGJE_CNT = #{gongje_cnt}
              ,GONGJE_AMT = #{gongje_amt}
              ,READY_CASH = #{READY_CASH}
         WHERE 1=1
           AND ACCNT_NO = #{accnt_no}
    </update>

    <!-- ================================================================
     * 날짜 : 20190219
     * 이름 : 송준빈
     * 추가내용 : 공제 데이터 전송이력 (ASIS) 삭제
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_ASIS_DATA
     * ================================================================
     * -->
    <delete id="DlwDeductionMap.deleteGongjeAsisDataList" parameterType="map">
        DELETE /* DlwDeductionMap.deleteGongjeAsisDataList */
          FROM LF_DMUSER.TB_GONGJE_ASIS_DATA
         WHERE 1=1
           AND ACCNT_NO = #{accnt_no}
    </delete>

    <!-- ================================================================
     * 날짜 : 20190220
     * 이름 : 정승철
     * 추가내용 : 공제 기존 누적 선수금 조회
     * 대상 테이블 : LF_DMUSER.GONGJE_MG
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getGongjeBefTotalAmt" parameterType="map" resultType="string">

        <!-- 공제마감여부에 따라, 나눠 가져옴 -->
        <!-- 조회년월과 다음 공제 마감처리할 정산년월 비교 -->

        <if test="yyyymm >= nCloseYYYYMM">
        SELECT /* DlwDeductionMap.getGongjeBefTotalAmt */
               ACM_AMT
          FROM TB_GONGJE_CLOSE
         WHERE CLOSE_YYYYMM = TO_CHAR(ADD_MONTHS(#{yyyymm}||'01',-1),'YYYYMM')
        </if>


        <if test="yyyymm lt nCloseYYYYMM">
        SELECT /* DlwDeductionMap.getGongjeBefTotalAmt */
               BEF_ACM_AMT
          FROM TB_GONGJE_CLOSE
         WHERE CLOSE_YYYYMM = #{yyyymm}
        </if>


        <!-- 2019년 3월부터 (총) 공제 기존 누적 선수금 -->
        <!--
        SELECT /* DlwDeductionMap.getGongjeBefTotalAmt */
               ACM_AMT
               /* CASE WHEN CLOSE_YYYYMM >= {yyyymm} */
          FROM TB_GONGJE_CLOSE
         /* WHERE CLOSE_YYYYMM = #{yyyymm} */
         WHERE CLOSE_YYYYMM = TO_CHAR(ADD_MONTHS(#{yyyymm}||'01',-1),'YYYYMM')
         -->


        <!-- 2019년 3월 이전까지 (총) 공제 기존 누적 선수금 -->
        <!-- SELECT /* DlwDeductionMap.getGongjeBefTotalAmt */
               SUM(GONGJE_AMT)
          FROM TB_GONGJE_ORIGIN
         WHERE KSTBIT = '정상'
         -->

        <!--
        SELECT /* DlwDeductionMap.getGongjeBefTotalAmt */
               NAMT
          FROM GONGJE_MG
         WHERE YYMM = TO_CHAR(ADD_MONTHS(#{yyyymm}||'01',-1),'YYYYMM')
         -->

    </select>

    <!-- ================================================================
     * 날짜 : 20190220
     * 이름 : 정승철
     * 추가내용 : 공제 월별 보고서 조회
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_DAY_EXT
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getGongjeMonthReport" parameterType="map" resultType="resultMap">

        <if test="yyyymm >= nCloseYYYYMM">

                SELECT /* DlwDeductionMap.getGongjeMonthReport */
                    'N_RE' AS GUBUN,
                    NVL(SUM(CASE WHEN NVL(EXT_INFO, '00') = '04'  THEN AMT ELSE 0 END),0) AS CMS_SUM_AMT,
                    NVL(SUM(CASE WHEN NVL(EXT_INFO, '00') != '04' THEN AMT ELSE 0 END),0) AS N_CMS_SUM_AMT,
                    0 AS R_SUM_AMT,
                    0 AS E_SUM_AMT,
                    0 AS ETC_REFUND_SUM_AMT,
                    0 AS ADJUST_SUM_AMT,
                    '' AS ADJUNST_REASON,
                    0 AS READY_CASH_SUM_AMT,
                    0 AS READY_CASH_CC_SUM_AMT,
                    0 AS READY_CASH_R_SUM_AMT,
                    --------------------------------------------------------------------------------------------------
                    0 AS BEF_ACM_AMT,
                    0 AS BEF_ACM_CNT
                FROM
                (
                    SELECT
                        EXT_INFO,
                        (CASE WHEN CL='P' THEN P_AMT ELSE D_AMT + PB_AMT END) AS AMT
                    FROM
                    (
                        SELECT
                            CL,
                            EXT.EXT_INFO,
                            (SELECT SUM(AMT) FROM PRODUCT_NO_DATA WHERE MBID.PROD_CD = PROD_CD AND NO = EXT.PAY_NO) AS P_AMT,
                            (SELECT SUM(AMT) FROM PRODUCT_NO_DATA WHERE MBID.PROD_CD = PROD_CD AND NO <![CDATA[<=]]> EXT.PAY_NO) AS D_AMT,
                            0 AS PB_AMT
                        FROM TB_GONGJE_DAY_EXT EXT INNER JOIN
                        TB_MEMBER_BASIC_INFO_DAY MBID ON EXT.ACCNT_NO = MBID.ACCNT_NO
                        WHERE 1=1
                        AND SUBSTR(GDATE,1,6) = #{yyyymm}
                        AND GBIT = '01'
                        AND CL IN ('D','P')
                        AND PROD_CD NOT IN ('FU', 'FZ', 'HM')

                        UNION ALL

                        SELECT
                            '',
                            '',
                            0,
                            0,
                            ( SELECT SUM(EXT.EXT_INFO2) FROM TB_GONGJE_DAY_EXT EXT INNER JOIN
                                                             TB_MEMBER_BASIC_INFO_DAY MBID ON EXT.ACCNT_NO = MBID.ACCNT_NO
                                                             WHERE 1=1
                                                             AND SUBSTR(GDATE,1,6) = #{yyyymm}
                                                             AND GBIT = '01'
                                                             AND CL IN ('D','P')
                                                             AND PROD_CD IN ('FU', 'FZ', 'HM') -- 장례이행보증상품
                            ) AS PB_AMT -- 장례이행보증금액
                        FROM DUAL

                    ) TBL
                ) TBL2

            UNION ALL

            -- 2. 해약, 행사
                          SELECT
                'RE' AS GUBUN,
                0,
                0,
                NVL(SUM(CASE WHEN CL = 'R' THEN TBL.GONGJE_AMT - PAY_AMT  ELSE 0 END),0) AS R_SUM_AMT,
                NVL(SUM(CASE WHEN CL = 'E' THEN TBL.GONGJE_AMT - PAY_AMT ELSE 0 END),0) AS E_SUM_AMT,
                0,
                0,
                '',
                0,
                0,
                0,
                --------------------------------------------------------------------------------------------------
                0,
                0
              FROM
              (
                  SELECT
                    EXT.CL,
                    ASIS.GONGJE_AMT,
                    NVL((
                        SELECT
                            SUM((SELECT AMT FROM PRODUCT_NO_DATA WHERE PROD_CD = MPA.PROD_CD AND NO = AAA.PAY_NO)) AS PAY_AMT
                        FROM TB_GONGJE_DAY_EXT AAA INNER JOIN
                            MEM_PROD_ACCNT MPA ON AAA.ACCNT_NO = MPA.ACCNT_NO
                        WHERE AAA.ACCNT_NO = EXT.ACCNT_NO AND GBIT = '01' AND CL IN ('P') AND GDATE > EXT.GDATE
                   ),0) AS PAY_AMT
                  FROM TB_GONGJE_DAY_EXT EXT LEFT OUTER JOIN
                       TB_GONGJE_ASIS_DATA ASIS ON EXT.ACCNT_NO = ASIS.ACCNT_NO
                 WHERE 1=1
                   AND SUBSTR(GDATE,1,6) =  #{yyyymm}
                   AND GBIT = '01'
                   AND CL IN ('E','R')
               ) TBL


            UNION ALL

            -- 3. 선수금취소(P_C), 조정금액(ETC), 레디캐시(C), 레디캐시취소(C_C), 레디캐시환급
            SELECT
                'PC_ADJUST' AS GUBUN,
                0,
                0,
                0,
                0,
                SUM(ETC_REFUND_SUM_AMT) AS ETC_REFUND_SUM_AMT,
                SUM(ADJUST_SUM_AMT) AS ADJUST_SUM_AMT,
                '' AS ADJUST_REASON,
                SUM(READY_CASH_SUM_AMT) AS READY_CASH_SUM_AMT,
                SUM(READY_CASH_CC_SUM_AMT) AS READY_CASH_CC_SUM_AMT,
                SUM(READY_CASH_R_SUM_AMT) AS READY_CASH_R_SUM_AMT,
                --------------------------------------------------------------------------------------------------
                0,
                0
              FROM
              (
                   SELECT
                       NVL(SUM(CASE WHEN CL = 'P_C' THEN TO_NUMBER(EXT.EXT_INFO2) ELSE 0 END),0) AS ETC_REFUND_SUM_AMT,
                       NVL(SUM(CASE WHEN CL = 'ETC' THEN TO_NUMBER(EXT.EXT_INFO2) ELSE 0 END),0) AS ADJUST_SUM_AMT,
                       (-1) * ABS(NVL(SUM(CASE WHEN CL = 'C' THEN TO_NUMBER(EXT.EXT_INFO2) ELSE 0 END),0)) AS READY_CASH_SUM_AMT,
                       ABS(NVL(SUM(CASE WHEN CL = 'C_C' THEN TO_NUMBER(EXT.EXT_INFO2) ELSE 0 END),0)) AS READY_CASH_CC_SUM_AMT,
                       0 AS READY_CASH_R_SUM_AMT
                     FROM TB_GONGJE_DAY_EXT EXT
                    WHERE 1=1
                      AND SUBSTR(GDATE,1,6) = #{yyyymm}
                      AND GBIT = '01'
                      AND CL IN ('P_C', 'ETC', 'C', 'C_C')

                    UNION ALL

                   -- 해약한 회원의 경우, 레디캐시금액 차이나는 부분 보완 - 2019.05.23
                   SELECT
                       0,
                       0,
                       0,
                       0,
                       (SELECT SUM(NVL(READY_CASH,0))
                          FROM TB_GONGJE_ASIS_DATA
                         WHERE 1=1
                         AND KSTBIT IN ('청약해지','행사')
                         AND ACCNT_NO IN ( SELECT ACCNT_NO
                                               FROM TB_GONGJE_DAY_EXT
                                              WHERE SUBSTR(GDATE,1,6) = #{yyyymm}
                                                AND CL IN ('R','E')
                                                AND GBIT = '01' )
                       )
                     FROM DUAL
              )

             UNION ALL

             -- 4. 해약취소, 행사취소
             -- 월별 보고서 기타환불의 경우 행사 및 해약 취소 할 경우 취소일자 이후로 납입된 월 납입 금액을 제외하고 더해줘야 함
			SELECT
			    'RC_EC' AS GUBUN,
			    0,
			    0,
			    0,
			    0,
			    NVL(SUM(GONGJE_AMT),0) -
			    NVL(SUM(PAY_AMT),0) AS ETC_REFUND_SUM_AMT,
			    0,
			    '',
			    0,
			    0,
			    0,
			    0,
			    0
			FROM
			(
			    SELECT
			        EXT.ACCNT_NO,
			        MPA.PROD_CD,
			        GONGJE_AMT,
			        NVL((
                        SELECT
                            SUM((SELECT AMT FROM PRODUCT_NO_DATA WHERE PROD_CD = MPA.PROD_CD AND NO = AAA.PAY_NO)) AS PAY_AMT
                        FROM TB_GONGJE_DAY_EXT AAA INNER JOIN
                            MEM_PROD_ACCNT MPA ON AAA.ACCNT_NO = MPA.ACCNT_NO
                        WHERE AAA.ACCNT_NO = EXT.ACCNT_NO AND GBIT = '01' AND CL IN ('P') AND GDATE > EXT.GDATE
                   ),0) AS PAY_AMT
			    FROM TB_GONGJE_DAY_EXT EXT LEFT OUTER JOIN
			    TB_GONGJE_ASIS_DATA ASIS ON EXT.ACCNT_NO = ASIS.ACCNT_NO INNER JOIN
			    MEM_PROD_ACCNT MPA ON EXT.ACCNT_NO = MPA.ACCNT_NO AND MPA.DEL_FG = 'N'
			    WHERE 1=1
			    AND SUBSTR(GDATE,1,6) =#{yyyymm}
			    AND GBIT = '01'
			    AND CL IN ('E_C','R_C')
			) TBL

             UNION ALL

             -- 5. (이전) 기존 선수금, 기존 건수
            SELECT
                'BEF_DATA' AS GUBUN,
                0,
                0,
                0,
                0,
                0,
                0,
                '',
                0,
                0,
                0,
                --------------------------------------------------------------------------------------------------
                NVL(ACM_AMT, 0) AS BEF_ACM_AMT,
                NVL(ACM_CNT, 0) AS BEF_ACM_CNT
              FROM TB_GONGJE_CLOSE
             WHERE CLOSE_YYYYMM = TO_CHAR(ADD_MONTHS(#{yyyymm}||'01',-1),'YYYYMM')

        </if>

        <!-- 공제마감데이터 조회 -->
        <if test="yyyymm lt nCloseYYYYMM">
            SELECT /* DlwDeductionMap.getGongjeMonthReport */
                BEF_ACM_AMT,
                PLUS_AMT1  AS CMS_SUM_AMT,
                PLUS_AMT2  AS N_CMS_SUM_AMT,
                MINUS_AMT1 AS R_SUM_AMT,
                MINUS_AMT2 AS E_SUM_AMT,
                MINUS_AMT3 AS ETC_REFUND_SUM_AMT,
                ADJUST_AMT AS ADJUST_SUM_AMT,
                ADJUST_REASON,
                READY_CASH_AMT AS READY_CASH_SUM_AMT,
                READY_CASH_CC_AMT AS READY_CASH_CC_SUM_AMT,
                READY_CASH_R_AMT AS READY_CASH_R_SUM_AMT,
                -----------------------------------------------------------------------------
                BEF_ACM_CNT,
                NEW_CNT,
                RES_CNT,
                EVT_CNT,
                CRE_CNT,
                ADJUST_CNT
              FROM TB_GONGJE_CLOSE
             WHERE CLOSE_YYYYMM = #{yyyymm}

        </if>

    </select>

    <!-- ================================================================
     * 날짜 : 20190220
     * 이름 : 정승철
     * 추가내용 : 공제 월별 보고서 구분별 카운트조회
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_DAY_EXT
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getCntGongjeMonthReport" parameterType="map" resultType="resultMap">

        SELECT /* DlwDeductionMap.getCntGongjeMonthReport */
               NVL((SELECT ACM_CNT FROM TB_GONGJE_CLOSE WHERE CLOSE_YYYYMM = TO_CHAR(ADD_MONTHS(#{yyyymm}||'01',-1),'YYYYMM')),0) AS BEF_CNT,   /* 기존누적건수 */
               MAIN_TBL.NEW_CNT,                                                                                                                /* 신규건수 */
               MAIN_TBL.RES_CNT,                                                                                                                /* 해약건수 */
               MAIN_TBL.EVT_CNT,                                                                                                                /* 행사건수 */
               MAIN_TBL.CRE_CNT                                                                                                                 /* 해악,행사취소건수 */
          FROM (
                SELECT NVL(SUM(CASE WHEN EXT.CL = 'D' THEN 1 ELSE 0 END),0) AS NEW_CNT,
                       NVL(SUM(CASE WHEN EXT.CL = 'R' THEN 1 ELSE 0 END),0) AS RES_CNT,
                       NVL(SUM(CASE WHEN EXT.CL = 'E' THEN 1 ELSE 0 END),0) AS EVT_CNT,
                       NVL(SUM(CASE WHEN EXT.CL IN ('R_C', 'E_C') THEN 1 ELSE 0 END),0) AS CRE_CNT
                  FROM TB_GONGJE_DAY_EXT EXT
                 WHERE 1=1
                   AND SUBSTR(EXT.GDATE,1,6) = #{yyyymm}
                   AND EXT.GBIT = '01'
              ) MAIN_TBL


        <!--
        SELECT /* (SELECT NCNT FROM GONGJE_MG WHERE YYMM = TO_CHAR(ADD_MONTHS(#{yyyymm}||'01',-1),'YYYYMM')) AS BEF_CNT,*/ /* 기존누적건수 */
               NVL((SELECT ACM_CNT FROM TB_GONGJE_CLOSE WHERE CLOSE_YYYYMM = TO_CHAR(ADD_MONTHS(#{yyyymm}||'01',-1),'YYYYMM')),0) AS BEF_CNT,   /* 기존누적건수 */
               MAIN_TBL.NEW_CNT,                                                                                     /* 신규건수 */
               MAIN_TBL.R_CNT,                                                                                       /* 해약건수 */
               MAIN_TBL.E_CNT,                                                                                       /* 행사건수 */
               MAIN_TBL.RC_EC_CNT,                                                                                   /* 해악,행사취소건수 */
               (SELECT COUNT(ACCNT_NO) FROM MEM_PROD_ACCNT WHERE NEW_YN = 'N') AS TOTAL_CNT                          /* 누적건수 */
          FROM (
                SELECT NVL(SUM(CASE WHEN EXT.CL = 'D' THEN 1 ELSE 0 END),0) AS NEW_CNT,
                       NVL(SUM(CASE WHEN EXT.CL = 'R' THEN 1 ELSE 0 END),0) AS R_CNT,
                       NVL(SUM(CASE WHEN EXT.CL = 'E' THEN 1 ELSE 0 END),0) AS E_CNT,
                       NVL(SUM(CASE WHEN EXT.CL IN ('R_C', 'E_C') THEN 1 ELSE 0 END),0) AS RC_EC_CNT
                  FROM TB_GONGJE_DAY_EXT EXT INNER JOIN
                       TB_GONGJE_DAY_EXT_RESULT RST ON EXT.GDATE = RST.GDATE AND EXT.RESULT_KEY = RST.RESULT_KEY
                 WHERE 1=1
                   AND SUBSTR(EXT.GDATE,1,6) = #{yyyymm}
                   AND RST.CODE = '0000'
              ) MAIN_TBL
         -->

    </select>

    <!-- ================================================================
     * 날짜 : 20190311
     * 이름 : 정승철
     * 추가내용 : 공제 월별 보고서 마감처리
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_CLOSE
     * ================================================================
     * -->
    <insert id="DlwDeductionMap.insertGongjeClose" parameterType="map">

        /*
            DlwDeductionMap.insertGongjeClose
        */
        INSERT INTO TB_GONGJE_CLOSE
        (
          CLOSE_YYYYMM, BEF_ACM_AMT, ACM_AMT, BEF_ACM_CNT, ACM_CNT,
          PLUS_AMT1, PLUS_AMT2, MINUS_AMT1, MINUS_AMT2, MINUS_AMT3,
          READY_CASH_AMT, READY_CASH_CC_AMT, READY_CASH_R_AMT, ADJUST_AMT,
          <if test="adjust_reason != null and adjust_reason != ''">
          ADJUST_REASON,
          </if>
          NEW_CNT, RES_CNT, EVT_CNT, CRE_CNT, ADJUST_CNT,
          REG_DM, REG_MAN
        )
        VALUES
        (
          #{close_yyyymm}, #{bef_acm_amt}, #{acm_amt}, #{bef_acm_cnt}, #{acm_cnt},
          #{plus_amt1}, #{plus_amt2}, #{minus_amt1}, #{minus_amt2}, #{minus_amt3},
          #{ready_cash_amt}, #{ready_cash_cc_amt}, #{ready_cash_r_amt}, #{adjust_amt},
          <if test="adjust_reason != null and adjust_reason != ''">
          #{adjust_reason},
          </if>
          #{new_cnt}, #{res_cnt}, #{evt_cnt}, #{cre_cnt}, #{adjust_cnt},
          SYSDATE, #{reg_man}
        )

    </insert>

    <!-- ================================================================
     * 날짜 : 20190312
     * 이름 : 정승철
     * 추가내용 : 공제 마감처리할 정산년월 조회
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_CLOSE
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getNextGongjeCloseYYYYMM" resultType="string">

        SELECT /* DlwDeductionMap.getNextGongjeCloseYYYYMM */
            TO_CHAR(ADD_MONTHS(TO_CHAR(MAX(CLOSE_YYYYMM)) || '01', 1), 'YYYYMM')
        FROM TB_GONGJE_CLOSE

    </select>

    <!-- ================================================================
     * 날짜 : 20190321
     * 이름 : 정승철
     * 추가내용 : 정상적인 공제 ASIS-DATA 총 금액 및 건수 조회
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_ASIS_DATA
     * ================================================================
     * -->
    <select id="DlwDeductionMap.getSumGongjeAsisData" resultType="resultMap">

        SELECT /*DlwDeductionMap.getSumGongjeAsisData*/
             (SUM(GONGJE_AMT) - SUM(READY_CASH)) AS ASIS_SUM_AMT,
            COUNT(*) AS ASIS_SUM_CNT
        FROM TB_GONGJE_ASIS_DATA
        WHERE KSTBIT = '정상'

    </select>

    <!-- ================================================================
     * 날짜 : 20190403
     * 이름 : 송준빈
     * 추가내용 : 공제 마감 처리후 ASIS의 정보를 ORIGIN으로 이관
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_ORIGIN
     * ================================================================
     * -->
    <insert id="DlwDeductionMap.insertGongjeAsisToOrigin" parameterType="map">
        INSERT INTO /* DlwDeductionMap.insertGongjeAsisToOrigin */
                    LF_DMUSER.TB_GONGJE_ORIGIN(ACCNT_NO, DED_NO, KSTBIT, GONGJE_CNT, GONGJE_AMT, ORI_DATE,READY_CASH)
        SELECT ACCNT_NO
              ,DED_NO
              ,KSTBIT
              ,GONGJE_CNT
              ,GONGJE_AMT
              ,TO_CHAR(SYSDATE, 'YYYYMMDD')
              ,READY_CASH
          FROM LF_DMUSER.TB_GONGJE_ASIS_DATA
         WHERE 1=1
    </insert>

    <!-- ================================================================
     * 날짜 : 20190410
     * 이름 : 정승철
     * 추가내용 : 공제결과 삭제
     * 대상 테이블 : LF_DMUSER.TB_GONGJE_DAY_EXT_RESULT
     * ================================================================
     * -->
    <delete id="DlwDeductionMap.deleteGongjeResult" parameterType="map">
        DELETE /* DlwDeductionMap.deleteGongjeResult */
          FROM TB_GONGJE_DAY_EXT_RESULT
         WHERE 1=1
           AND TO_CHAR(REG_DM, 'YYYYMMDD') = TO_CHAR(SYSDATE, 'YYYYMMDD')
    </delete>

</mapper>
